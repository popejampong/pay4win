VERSION 5.00
Object = "{BDC217C8-ED16-11CD-956C-0000C04E4C0A}#1.1#0"; "tabctl32.ocx"
Object = "{F9043C88-F6F2-101A-A3C9-08002B2F49FB}#1.2#0"; "Comdlg32.ocx"
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.0#0"; "Mscomctl.ocx"
Object = "{083C8784-F106-4CC2-9930-876218A6B74C}#1.1#0"; "ciaxpbutton.ocx"
Begin VB.Form frmSel 
   BorderStyle     =   1  'Fixed Single
   Caption         =   "Select from List..."
   ClientHeight    =   4695
   ClientLeft      =   120
   ClientTop       =   450
   ClientWidth     =   6555
   KeyPreview      =   -1  'True
   LinkTopic       =   "Form1"
   LockControls    =   -1  'True
   MaxButton       =   0   'False
   MinButton       =   0   'False
   ScaleHeight     =   4695
   ScaleWidth      =   6555
   ShowInTaskbar   =   0   'False
   StartUpPosition =   2  'CenterScreen
   Begin VB.CheckBox Check5 
      BackColor       =   &H00800000&
      Caption         =   "&Tagalog"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00C0FFFF&
      Height          =   450
      Left            =   4950
      TabIndex        =   47
      Top             =   2865
      Width           =   1440
   End
   Begin MSComDlg.CommonDialog CommonDialog1 
      Left            =   5370
      Top             =   2295
      _ExtentX        =   847
      _ExtentY        =   847
      _Version        =   393216
   End
   Begin ciaXPButton.XPButton XPButton3 
      Height          =   600
      Left            =   4965
      TabIndex        =   11
      Top             =   975
      Width           =   1395
      _ExtentX        =   2461
      _ExtentY        =   1058
      Caption         =   "&Ok"
      Picture         =   "frmSel.frx":0000
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      LicValid        =   -1  'True
   End
   Begin ciaXPButton.XPButton XPButton2 
      Height          =   600
      Left            =   4965
      TabIndex        =   10
      Top             =   360
      Width           =   1395
      _ExtentX        =   2461
      _ExtentY        =   1058
      Caption         =   "&Process"
      Picture         =   "frmSel.frx":1992
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      LicValid        =   -1  'True
   End
   Begin ciaXPButton.XPButton XPButton1 
      Cancel          =   -1  'True
      Height          =   600
      Left            =   4965
      TabIndex        =   9
      Top             =   1590
      Width           =   1395
      _ExtentX        =   2461
      _ExtentY        =   1058
      Caption         =   "&Close"
      Picture         =   "frmSel.frx":3324
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      LicValid        =   -1  'True
   End
   Begin VB.CheckBox Check4 
      BackColor       =   &H00800000&
      Caption         =   "Detailed Report"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00C0FFFF&
      Height          =   450
      Left            =   4935
      TabIndex        =   8
      Top             =   3945
      Width           =   1440
   End
   Begin VB.CheckBox Check3 
      BackColor       =   &H00800000&
      Caption         =   "&Deduction Only"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00C0FFFF&
      Height          =   450
      Left            =   4935
      TabIndex        =   7
      Top             =   3390
      Width           =   1440
   End
   Begin TabDlg.SSTab SSTab1 
      Height          =   3930
      Left            =   90
      TabIndex        =   2
      Top             =   105
      Width           =   4560
      _ExtentX        =   8043
      _ExtentY        =   6932
      _Version        =   393216
      Style           =   1
      Tabs            =   5
      Tab             =   4
      TabsPerRow      =   5
      TabHeight       =   520
      TabCaption(0)   =   "Select Period"
      TabPicture(0)   =   "frmSel.frx":4CB6
      Tab(0).ControlEnabled=   0   'False
      Tab(0).Control(0)=   "ListView1"
      Tab(0).Control(1)=   "Check1"
      Tab(0).ControlCount=   2
      TabCaption(1)   =   "Select Department"
      TabPicture(1)   =   "frmSel.frx":4CD2
      Tab(1).ControlEnabled=   0   'False
      Tab(1).Control(0)=   "ListView2"
      Tab(1).Control(1)=   "Check2"
      Tab(1).ControlCount=   2
      TabCaption(2)   =   "Tab 2"
      TabPicture(2)   =   "frmSel.frx":4CEE
      Tab(2).ControlEnabled=   0   'False
      Tab(2).Control(0)=   "Label1"
      Tab(2).Control(1)=   "Label3"
      Tab(2).Control(2)=   "Label9"
      Tab(2).Control(3)=   "Label13"
      Tab(2).Control(4)=   "Combo2"
      Tab(2).Control(5)=   "Combo3"
      Tab(2).Control(6)=   "Command1"
      Tab(2).Control(7)=   "Text2"
      Tab(2).ControlCount=   8
      TabCaption(3)   =   "Signatory"
      TabPicture(3)   =   "frmSel.frx":4D0A
      Tab(3).ControlEnabled=   0   'False
      Tab(3).Control(0)=   "Label4"
      Tab(3).Control(1)=   "Label7"
      Tab(3).Control(2)=   "Label5"
      Tab(3).Control(3)=   "Label11"
      Tab(3).Control(4)=   "Label6"
      Tab(3).Control(5)=   "Label15"
      Tab(3).Control(6)=   "Label10"
      Tab(3).Control(7)=   "Label8"
      Tab(3).Control(8)=   "Label16"
      Tab(3).Control(9)=   "Label12"
      Tab(3).Control(10)=   "Label14"
      Tab(3).Control(11)=   "Text1"
      Tab(3).Control(12)=   "Command5"
      Tab(3).Control(13)=   "Command14"
      Tab(3).Control(14)=   "Text5"
      Tab(3).Control(15)=   "Text7"
      Tab(3).Control(16)=   "Command15"
      Tab(3).Control(17)=   "Text6"
      Tab(3).Control(18)=   "Command13"
      Tab(3).Control(19)=   "Text8"
      Tab(3).Control(20)=   "Command16"
      Tab(3).Control(21)=   "Command2"
      Tab(3).Control(22)=   "Text3"
      Tab(3).ControlCount=   23
      TabCaption(4)   =   "Tab 4"
      TabPicture(4)   =   "frmSel.frx":4D26
      Tab(4).ControlEnabled=   -1  'True
      Tab(4).Control(0)=   "Label17"
      Tab(4).Control(0).Enabled=   0   'False
      Tab(4).Control(1)=   "Dir1"
      Tab(4).Control(1).Enabled=   0   'False
      Tab(4).Control(2)=   "Drive1"
      Tab(4).Control(2).Enabled=   0   'False
      Tab(4).Control(3)=   "Text4"
      Tab(4).Control(3).Enabled=   0   'False
      Tab(4).ControlCount=   4
      Begin VB.TextBox Text4 
         Appearance      =   0  'Flat
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   285
         Left            =   135
         Locked          =   -1  'True
         TabIndex        =   45
         Top             =   3480
         Width           =   4290
      End
      Begin VB.DriveListBox Drive1 
         Height          =   315
         Left            =   135
         TabIndex        =   44
         Top             =   2805
         Width           =   4305
      End
      Begin VB.DirListBox Dir1 
         Height          =   2340
         Left            =   135
         TabIndex        =   43
         Top             =   420
         Width           =   4290
      End
      Begin VB.TextBox Text3 
         Appearance      =   0  'Flat
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   285
         Left            =   -74895
         TabIndex        =   20
         Tag             =   "1"
         ToolTipText     =   "TXT:INSP_BY"
         Top             =   2595
         Width           =   660
      End
      Begin VB.CommandButton Command2 
         Caption         =   "..."
         Height          =   300
         Left            =   -74205
         TabIndex        =   41
         Top             =   2580
         Width           =   375
      End
      Begin VB.TextBox Text2 
         Appearance      =   0  'Flat
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   285
         Left            =   -74880
         TabIndex        =   38
         Tag             =   "1"
         ToolTipText     =   "TXT:PREP_BY"
         Top             =   1515
         Width           =   660
      End
      Begin VB.CommandButton Command1 
         Caption         =   "..."
         Height          =   315
         Left            =   -74190
         TabIndex        =   37
         Top             =   1485
         Width           =   375
      End
      Begin VB.CommandButton Command16 
         Caption         =   "..."
         Height          =   300
         Left            =   -74205
         TabIndex        =   26
         Top             =   3150
         Width           =   375
      End
      Begin VB.TextBox Text8 
         Appearance      =   0  'Flat
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   285
         Left            =   -74895
         TabIndex        =   21
         Tag             =   "1"
         ToolTipText     =   "TXT:CHK_BY"
         Top             =   3165
         Width           =   660
      End
      Begin VB.CommandButton Command13 
         Caption         =   "..."
         Height          =   300
         Left            =   -74205
         TabIndex        =   25
         Top             =   630
         Width           =   375
      End
      Begin VB.TextBox Text6 
         Appearance      =   0  'Flat
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   285
         Left            =   -74895
         TabIndex        =   16
         Tag             =   "1"
         ToolTipText     =   "TXT:PREP_BY"
         Top             =   645
         Width           =   660
      End
      Begin VB.CommandButton Command15 
         Caption         =   "..."
         Height          =   300
         Left            =   -74205
         TabIndex        =   24
         Top             =   2280
         Width           =   375
      End
      Begin VB.TextBox Text7 
         Appearance      =   0  'Flat
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   285
         Left            =   -74895
         TabIndex        =   19
         Tag             =   "1"
         ToolTipText     =   "TXT:INSP_BY"
         Top             =   2295
         Width           =   660
      End
      Begin VB.TextBox Text5 
         Appearance      =   0  'Flat
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   285
         Left            =   -74895
         TabIndex        =   17
         Tag             =   "1"
         ToolTipText     =   "TXT:CHK_BY"
         Top             =   1185
         Width           =   660
      End
      Begin VB.CommandButton Command14 
         Caption         =   "..."
         Height          =   300
         Left            =   -74205
         TabIndex        =   23
         Top             =   1170
         Width           =   375
      End
      Begin VB.CommandButton Command5 
         Caption         =   "..."
         Height          =   300
         Left            =   -74205
         TabIndex        =   22
         Top             =   1725
         Width           =   375
      End
      Begin VB.TextBox Text1 
         Appearance      =   0  'Flat
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   285
         Left            =   -74895
         TabIndex        =   18
         Tag             =   "1"
         ToolTipText     =   "TXT:REC_BY"
         Top             =   1740
         Width           =   660
      End
      Begin VB.ComboBox Combo3 
         Height          =   315
         ItemData        =   "frmSel.frx":4D42
         Left            =   -74070
         List            =   "frmSel.frx":4D4F
         Style           =   2  'Dropdown List
         TabIndex        =   14
         Top             =   780
         Width           =   2190
      End
      Begin VB.ComboBox Combo2 
         Height          =   315
         ItemData        =   "frmSel.frx":4D65
         Left            =   -74070
         List            =   "frmSel.frx":4D75
         Style           =   2  'Dropdown List
         TabIndex        =   12
         Top             =   435
         Width           =   2190
      End
      Begin VB.CheckBox Check2 
         Caption         =   "Select &All"
         ForeColor       =   &H00800000&
         Height          =   240
         Left            =   -74880
         TabIndex        =   5
         Top             =   3630
         Width           =   1755
      End
      Begin VB.CheckBox Check1 
         Caption         =   "Select &All"
         ForeColor       =   &H00800000&
         Height          =   240
         Left            =   -74880
         TabIndex        =   3
         Top             =   3630
         Width           =   1755
      End
      Begin MSComctlLib.ListView ListView1 
         Height          =   3210
         Left            =   -74880
         TabIndex        =   4
         Top             =   405
         Width           =   4320
         _ExtentX        =   7620
         _ExtentY        =   5662
         View            =   3
         LabelEdit       =   1
         LabelWrap       =   0   'False
         HideSelection   =   0   'False
         AllowReorder    =   -1  'True
         Checkboxes      =   -1  'True
         FullRowSelect   =   -1  'True
         GridLines       =   -1  'True
         _Version        =   393217
         ForeColor       =   4210752
         BackColor       =   -2147483643
         BorderStyle     =   1
         Appearance      =   0
         NumItems        =   2
         BeginProperty ColumnHeader(1) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Text            =   "Code"
            Object.Width           =   1764
         EndProperty
         BeginProperty ColumnHeader(2) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   1
            Text            =   "Description"
            Object.Width           =   5010
         EndProperty
      End
      Begin MSComctlLib.ListView ListView2 
         Height          =   3210
         Left            =   -74880
         TabIndex        =   6
         Top             =   405
         Width           =   4320
         _ExtentX        =   7620
         _ExtentY        =   5662
         View            =   3
         LabelEdit       =   1
         LabelWrap       =   0   'False
         HideSelection   =   0   'False
         AllowReorder    =   -1  'True
         Checkboxes      =   -1  'True
         FullRowSelect   =   -1  'True
         GridLines       =   -1  'True
         _Version        =   393217
         ForeColor       =   4210752
         BackColor       =   -2147483643
         BorderStyle     =   1
         Appearance      =   0
         NumItems        =   2
         BeginProperty ColumnHeader(1) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Text            =   "Code"
            Object.Width           =   1764
         EndProperty
         BeginProperty ColumnHeader(2) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   1
            Text            =   "Description"
            Object.Width           =   5010
         EndProperty
      End
      Begin VB.Label Label17 
         BackStyle       =   0  'Transparent
         Caption         =   "Path / Location"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00800000&
         Height          =   285
         Left            =   135
         TabIndex        =   46
         Top             =   3255
         Width           =   4035
      End
      Begin VB.Label Label14 
         BackStyle       =   0  'Transparent
         Caption         =   "Prepared By"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00800000&
         Height          =   285
         Left            =   -73785
         TabIndex        =   42
         Top             =   2640
         Width           =   3270
      End
      Begin VB.Label Label13 
         BackStyle       =   0  'Transparent
         Caption         =   "Signatory"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00800000&
         Height          =   285
         Left            =   -74865
         TabIndex        =   40
         Top             =   1275
         Width           =   1215
      End
      Begin VB.Label Label9 
         BackStyle       =   0  'Transparent
         Caption         =   "Prepared By"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00800000&
         Height          =   285
         Left            =   -73770
         TabIndex        =   39
         Top             =   1530
         Width           =   3270
      End
      Begin VB.Label Label12 
         BackStyle       =   0  'Transparent
         Caption         =   "Approved By"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00800000&
         Height          =   285
         Left            =   -74880
         TabIndex        =   36
         Top             =   2940
         Width           =   1215
      End
      Begin VB.Label Label16 
         BackStyle       =   0  'Transparent
         Caption         =   "Prepared By"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00800000&
         Height          =   285
         Left            =   -73785
         TabIndex        =   35
         Top             =   3225
         Width           =   3270
      End
      Begin VB.Label Label8 
         BackStyle       =   0  'Transparent
         Caption         =   "Prepared By"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00800000&
         Height          =   285
         Left            =   -73785
         TabIndex        =   34
         Top             =   690
         Width           =   3270
      End
      Begin VB.Label Label10 
         BackStyle       =   0  'Transparent
         Caption         =   "Prepared By"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00800000&
         Height          =   285
         Left            =   -74880
         TabIndex        =   33
         Top             =   435
         Width           =   1215
      End
      Begin VB.Label Label15 
         BackStyle       =   0  'Transparent
         Caption         =   "Prepared By"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00800000&
         Height          =   285
         Left            =   -73785
         TabIndex        =   32
         Top             =   2340
         Width           =   3270
      End
      Begin VB.Label Label6 
         BackStyle       =   0  'Transparent
         Caption         =   "Prepared By"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00800000&
         Height          =   285
         Left            =   -73785
         TabIndex        =   31
         Top             =   1230
         Width           =   3270
      End
      Begin VB.Label Label11 
         BackStyle       =   0  'Transparent
         Caption         =   "Noted By"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00800000&
         Height          =   285
         Left            =   -74880
         TabIndex        =   30
         Top             =   2085
         Width           =   1215
      End
      Begin VB.Label Label5 
         BackStyle       =   0  'Transparent
         Caption         =   "Checked By"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00800000&
         Height          =   285
         Left            =   -74880
         TabIndex        =   29
         Top             =   975
         Width           =   1215
      End
      Begin VB.Label Label7 
         BackStyle       =   0  'Transparent
         Caption         =   "Verified By"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00800000&
         Height          =   285
         Left            =   -74880
         TabIndex        =   28
         Top             =   1530
         Width           =   1215
      End
      Begin VB.Label Label4 
         BackStyle       =   0  'Transparent
         Caption         =   "Prepared By"
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00800000&
         Height          =   285
         Left            =   -73785
         TabIndex        =   27
         Top             =   1785
         Width           =   3270
      End
      Begin VB.Label Label3 
         Caption         =   "Year"
         ForeColor       =   &H00800000&
         Height          =   450
         Left            =   -74895
         TabIndex        =   15
         Top             =   825
         Width           =   765
      End
      Begin VB.Label Label1 
         Caption         =   "Quarter"
         ForeColor       =   &H00800000&
         Height          =   450
         Left            =   -74895
         TabIndex        =   13
         Top             =   480
         Width           =   765
      End
   End
   Begin VB.ComboBox Combo1 
      Height          =   315
      ItemData        =   "frmSel.frx":4DB7
      Left            =   90
      List            =   "frmSel.frx":4DC1
      Style           =   2  'Dropdown List
      TabIndex        =   0
      Top             =   4290
      Width           =   4215
   End
   Begin VB.Label Label2 
      BackStyle       =   0  'Transparent
      Caption         =   "Select Type of Report to Generate:"
      BeginProperty Font 
         Name            =   "Tahoma"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00800000&
      Height          =   285
      Left            =   90
      TabIndex        =   1
      Top             =   4080
      Width           =   3135
   End
   Begin VB.Shape Shape1 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H00800000&
      FillStyle       =   0  'Solid
      Height          =   4710
      Left            =   4755
      Top             =   0
      Width           =   1815
   End
End
Attribute VB_Name = "frmSel"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
' project name  :   Dong-in Payroll System
' module        :   frmSel
' description   :   Module for any kind of selection
' programmer    :   _-=[ srm ]=-_
' date          :   23 Oct 2005

Option Explicit
    Dim oTempADO As New ADODB.Recordset, _
        oDBFConn As New ADODB.Connection        ' --> for DBF connection


Sub cmdClick(ByVal oTxtBox As TextBox, ByVal oLabel As Label)
    frmLookup.showPopup 1   ', " where sysuser = 1"
    frmLookup.Show 1
    If Trim(cResult) <> "" Then
        oTxtBox.Text = cResult
        ShowData cResult, oLabel
    End If
End Sub

Sub ShowData(cString As String, oLabel As Label)
    OpenQueryDNS "SELECT USERID,CONCAT(FIRSTNAME," & cQuote & " " & cQuote & ",LASTNAME) AS FULLNAME FROM PA2360 WHERE USERID=" & cQuote & cString & cQuote, objdbRs, False
    oLabel.Caption = IIf(objdbRs.RecordCount > 0, objdbRs("FULLNAME"), "")
End Sub

Sub txtKeyDown(nMode As Integer, cString As String, oLabel As Label)
    If Trim(cString) = "" Then
        Select Case nMode
            Case 1
                Command13_Click
            Case 2
                Command14_Click
            Case 3
                Command5_Click
            Case 4
                Command15_Click
            Case 5
                Command16_Click
            Case 6
                Command1_Click
            Case 7
                Command2_Click
        End Select
    Else
        ShowData cString, oLabel
    End If
End Sub

Sub SetSelection(ByVal nMode As Integer)
    Dim oLstItem As ListItem, nCtr As Integer
    
    Tag = nMode
    
    Label10.Caption = "Prepared By"
    
    Check1.Visible = True
    Check3.Visible = True
    Check4.Visible = True
    Check5.Visible = False
    
    Combo1.Visible = True
    Combo2.Visible = True
    Combo3.Visible = True
    
    Label1.Visible = True
    Label2.Visible = True
    Label3.Visible = True
    
    XPButton2.Visible = True
    
    Command2.Visible = True
    Command5.Visible = True
    Command14.Visible = True
    Command15.Visible = True
    Command16.Visible = True
    
    Label4.Visible = True
    Label5.Visible = True
    Label6.Visible = True
    Label7.Visible = True
    Label11.Visible = True
    Label12.Visible = True
    Label14.Visible = True
    Label15.Visible = True
    Label16.Visible = True
    
    Text1.Visible = True
    Text3.Visible = True
    Text5.Visible = True
    Text7.Visible = True
    Text8.Visible = True
    
    With SSTab1
        .TabVisible(0) = True
        .TabVisible(1) = True
        .TabVisible(2) = True
        .TabVisible(3) = True
        .TabVisible(4) = True
        .Tab = 0
    End With
    
    ShowData Text1.Text, Label4
    ShowData Text2.Text, Label9
    ShowData Text3.Text, Label14
    ShowData Text5.Text, Label6
    ShowData Text6.Text, Label8
    ShowData Text7.Text, Label15
    ShowData Text8.Text, Label16
    
    Select Case nMode
        Case 1, 2, 7, 8, 23   ' --> Transaction Selection
            Check1.Visible = False
            
            Check3.Visible = False
            Check4.Visible = (nMode = 7) Or (nMode = 23)
            
            Combo1.Visible = False
            Label2.Visible = False
            
            XPButton2.Visible = nMode = 1
            
            With SSTab1
                .TabVisible(1) = False
                .TabVisible(2) = False
                .TabVisible(3) = (nMode = 7) Or (nMode = 23)
                .TabVisible(4) = False
                .TabCaption(0) = "Select Period"
            End With
            
            If (nMode = 7) Or (nMode = 23) Then
                Label10.Caption = "From"
                Label5.Caption = "Attention to:"
                Label4.Visible = False
                Label7.Visible = False
                Label11.Visible = False
                Label12.Visible = False
                Label14.Visible = False
                Label15.Visible = False
                Label16.Visible = False
                
                Text1.Visible = False
                Text3.Visible = False
                Text7.Visible = False
                Text8.Visible = False
                
                Command2.Visible = False
                Command5.Visible = False
                Command15.Visible = False
                Command16.Visible = False
            End If
            
            ListView1.Checkboxes = False
            If (nMode = 2) Then
                OpenQueryDNS "SELECT PERIODID, DURATION FROM PA7730 WHERE 13month=0 ", objdbRs, False
            Else
                If nMode = 23 Then
                    OpenQueryDNS "SELECT PERIODID, DURATION FROM PA7730 WHERE (13month=1) and (PCLOSE=0) ORDER BY PERIODID", objdbRs, False
                Else
                    OpenQueryDNS "SELECT PERIODID, DURATION FROM PA7730 WHERE (13month=0) and (PCLOSE=0) and (DATE_START < CURDATE() and DATE_END < CURDATE()) ORDER BY PERIODID", objdbRs, False
                End If
            End If
'            OpenQueryDNS "SELECT PERIODID, DURATION FROM PA7730 WHERE (PCLOSE=0) and (DATE_START < CURDATE() and DATE_END < CURDATE()) ORDER BY PERIODID", objdbRs, False
            add2LstBox objdbRs, ListView1, Array("DURATION", "PERIODID")
    
'        Case 3
'            Check3.Visible = False
'            Check4.Visible = False
'
'            XPButton2.Visible = False
'
'            With SSTab1
'                .TabVisible(1) = False
'                .TabVisible(2) = False
'                .TabVisible(3) = False
'                .TabVisible(4) = False
'                .TabCaption(0) = "Select Department"
'            End With
'
'            ListView1.Checkboxes = True
'
'            OpenQueryDNS "SELECT LINENAME, LINEID FROM DI5463 ORDER BY LINEID", objdbRs, False
'            add2LstBox objdbRs, ListView1, Array("LINENAME", "LINEID")
            
        Case 3, 4, 5, 6, 10, 15, 22
            Check1.Visible = False
            
            Check3.Visible = IIf((nMode = 6) Or (nMode = 15), True, False)
            Check4.Visible = IIf((nMode = 6) Or (nMode = 15) Or (nMode = 3), True, False)
            Check4.Value = vbChecked
            Check4.Caption = "Detailed Report"
            
            Check5.Visible = nMode = 4
            Check5.Value = IIf(nMode = 4, vbChecked, vbUnchecked)
            
            XPButton2.Visible = False
            
            ListView1.Checkboxes = False
            If (nMode = 10) Or (nMode = 3) Then
                OpenQueryDNS "SELECT PERIODID, DURATION FROM PA7730 WHERE 13month=0 ", objdbRs, False
'                add2LstBox objdbRs, ListView1, Array("DURATION", "PERIODID")
            Else
                If nMode = 22 Then
                    OpenQueryDNS "SELECT PERIODID, DURATION FROM PA7730 WHERE (13month=1) and (PCLOSE=0) ORDER BY PERIODID", objdbRs, False
                Else
                    OpenQueryDNS "SELECT PERIODID, DURATION FROM PA7730 WHERE (13month=0) and (PCLOSE=0) and (DATE_START < CURDATE() and DATE_END < CURDATE()) ORDER BY PERIODID", objdbRs, False
                End If
            End If
            add2LstBox objdbRs, ListView1, Array("DURATION", "PERIODID")
            
            ListView2.Checkboxes = True
            
            With SSTab1
                .TabVisible(2) = False
                .TabVisible(3) = IIf(nMode = 6, Check4.Value <> vbChecked, False)
                .TabVisible(4) = False
                .TabCaption(0) = "Select Period"
                .TabCaption(1) = "Select Department"
            End With
            
            Check2.Value = vbChecked
            Check2_Click
        
            OpenQueryDNS "SELECT LINENAME, LINEID FROM DI5463 ORDER BY LINEID", objdbRs, False
            add2LstBox objdbRs, ListView2, Array("LINENAME", "LINEID")
             
            If nMode = 10 Then
                Check4.Caption = "Group Report"
                Combo1.Visible = False
                Label2.Visible = False
            Else
                If nMode <> 22 Then
                    Label2.Caption = "Select filter:"
                    
                    With Combo1
                        .Clear
                        .AddItem "Regular"
                        .AddItem "SA"
                        .AddItem "WAP"
                        .AddItem "WAP SA"
                        .ListIndex = 0
                    End With
                Else
                    Label2.Visible = False
                    Combo1.Visible = False
                End If
            End If
            
        Case 9
            XPButton2.Visible = False
            Check3.Visible = False
            Check4.Caption = "&Order by Sex"
            
            With SSTab1
                .TabVisible(2) = False
                .TabVisible(3) = False
                .TabVisible(4) = False
                
                .TabCaption(0) = "Month"
                .TabCaption(1) = "Department"
            End With
            
            With ListView1
                .ListItems.Clear
                For nCtr = 1 To 12
                    Set oLstItem = .ListItems.Add()
                    oLstItem.Text = Trim(Str(nCtr))
                    oLstItem.SubItems(1) = MonthName(nCtr)
                    If nCtr = Month(Now) Then oLstItem.Checked = True
                Next
            End With
            
            OpenQueryDNS "SELECT LINEID, LINENAME FROM di5463 ORDER BY LINEID", objdbRs, False
            add2LstBox objdbRs, ListView2, Array("LINENAME", "LINEID")
            
            Label2.Caption = "Select Year"
            With Combo1
                .Clear
                .AddItem "2005"
                .AddItem "2006"
                .AddItem "2007"
            End With
            
            MatchCombo Year(Now), Combo1
            
        Case 11 ' --> Leave Report
            Check1.Visible = False
            Check3.Visible = False
            Check4.Visible = False
            
            Command2.Visible = False
            
            Label2.Visible = False
            Label14.Visible = False
            
            Text3.Visible = False
            
            XPButton2.Visible = False
            
            With SSTab1
                .TabVisible(1) = False
                .TabVisible(2) = False
                .TabVisible(4) = False
                
                .TabCaption(0) = "Select Period"
                .TabCaption(3) = "Signatory"
            End With
            
            ListView1.Checkboxes = False
            OpenQueryDNS "SELECT PERIODID, DURATION FROM PA7730 WHERE (13month=0) and (PCLOSE=0) and (DATE_START < CURDATE() and DATE_END < CURDATE()) ORDER BY PERIODID", objdbRs, False
            add2LstBox objdbRs, ListView1, Array("DURATION", "PERIODID")
            
            With Combo1
                .Clear
                .AddItem "Sick / Vacation Leave"
                .AddItem "Emergency Leave"
                .AddItem "Maternity Leave"
                .AddItem "Paternity Leave"
                .AddItem "Force Leave"
                .AddItem "Union Leave"
                .AddItem "All Leave"
                .ListIndex = 0
            End With
            
        Case 12
            Check3.Visible = False
            Check4.Visible = False
            Combo1.Visible = False
            Label2.Visible = False
            XPButton2.Visible = False
            
            With SSTab1
                .TabVisible(0) = False
                .TabVisible(1) = False
                .TabVisible(3) = False
                .TabVisible(4) = False
                
                .Tab = 2
                
                .TabCaption(2) = "Select a Period"
                .TabCaption(3) = "Signatories"
            End With
            
            Combo2.ListIndex = Month(Now) \ 3
            MatchCombo Format(Now, "yyyy"), Combo3
    
        Case 13, 14, 16, 17, 21
            Command2.Visible = False
            Command5.Visible = False
            Command14.Visible = False
            Command15.Visible = False
            Command16.Visible = False
            
            Label4.Visible = False
            Label5.Visible = False
            Label6.Visible = False
            Label7.Visible = False
            Label11.Visible = False
            Label12.Visible = False
            Label14.Visible = False
            Label15.Visible = False
            Label16.Visible = False
            
            Text1.Visible = False
            Text3.Visible = False
            Text5.Visible = False
            Text7.Visible = False
            Text8.Visible = False
            
            XPButton2.Visible = False
            Check1.Visible = False
            Check3.Visible = False
            If nMode = 13 Then
                Check4.Visible = False
            Else
                Check4.Caption = "Premium only"
                Check4.Value = vbChecked
            End If
            
            With SSTab1
                .TabVisible(0) = IIf(Tag = 21, False, True)
                .TabVisible(1) = False
                .TabVisible(2) = False
                
                If (Tag = 17) Or (Tag = 21) Then
                    ListView1.Checkboxes = False
                    OpenQueryDNS "SELECT PERIODID, DURATION FROM PA7730 WHERE (13month=0) and (PCLOSE=0) and (DATE_START < CURDATE() and DATE_END < CURDATE()) ORDER BY PERIODID", objdbRs, False
                    add2LstBox objdbRs, ListView1, Array("DURATION", "PERIODID")
                    
                    .TabVisible(3) = False
                    .TabCaption(4) = "Select a location"
                    
                    Check4.Visible = False
                    Label2.Visible = False
                    Combo1.Visible = False
                    Drive1.Drive = left(cDownloadPath, 2)
                    Dir1.Path = cDownloadPath
                    Text4.Text = cDownloadPath
'                    Text9.Text = "K1PAY"
                Else
                    .TabVisible(4) = False
                    
                    If Tag = 16 Then .TabVisible(3) = False
                    .TabCaption(0) = "Month"
                    .TabCaption(3) = "Signatory"
                End If
            End With
            
            If (Tag <> 17) And (Tag <> 21) Then
                With ListView1
                    .ListItems.Clear
                    For nCtr = 1 To 12
                        Set oLstItem = .ListItems.Add()
                        oLstItem.Text = Trim(Str(nCtr))
                        oLstItem.SubItems(1) = MonthName(nCtr)
                    Next
                End With
                ListView1.Checkboxes = False
                
                Label2.Caption = "Select Year"
                With Combo1
                    .Clear
                    .AddItem "2005"
                    .AddItem "2006"
                    .AddItem "2007"
                End With
                
                MatchCombo Year(Now), Combo1
            End If
            
        Case 18     ' --> Salary Division
            XPButton2.Visible = False
            
            Check1.Visible = False
            Check3.Visible = False
            Check4.Caption = "Detailed Report"
            Check5.Visible = False
            
            With SSTab1
                .TabVisible(1) = False
                .TabVisible(2) = False
                .TabVisible(3) = False
                .TabVisible(4) = False
            End With
            
            Label2.Caption = "Select Filter:"
            With Combo1
                .Clear
                .AddItem "Regular"
                .AddItem "WAP"
                .ListIndex = 0
            End With
    
            ListView1.Checkboxes = False
            OpenQueryDNS "SELECT PERIODID, DURATION FROM PA7730 WHERE (13month=0) and (PCLOSE=0) and (DATE_START < CURDATE() and DATE_END < CURDATE()) ORDER BY PERIODID", objdbRs, False
            add2LstBox objdbRs, ListView1, Array("DURATION", "PERIODID")
            
        Case 19, 20
            XPButton2.Visible = False
            
            Check3.Visible = False
            Check5.Visible = False
            Check4.Visible = nMode = 20
            Check4.Value = vbChecked
            Check4.Caption = "Detailed Report"
    
            With SSTab1
                .TabVisible(0) = False
                .TabVisible(2) = False
                .TabVisible(3) = False
                .TabVisible(4) = False
            End With
            
            Label2.Visible = False
            Combo1.Visible = False
            
            OpenQueryDNS "SELECT LINEID, LINENAME FROM di5463 ORDER BY LINEID", objdbRs, False
            add2LstBox objdbRs, ListView2, Array("LINENAME", "LINEID")
    
        Case 24
            With SSTab1
                .TabVisible(1) = False
                .TabVisible(2) = False
                .TabVisible(3) = False
                .TabCaption(4) = "Select a location"
            End With
            
            Check3.Visible = False
            Check4.Visible = False
            Check5.Visible = False
            Combo1.Visible = False
            Label2.Visible = False
            XPButton2.Visible = False
            
            Drive1.Drive = left(cDownloadPath, 2)
            Dir1.Path = cDownloadPath
            Text4.Text = cDownloadPath
            
            ListView1.Checkboxes = False
            OpenQueryDNS "SELECT PERIODID, DURATION FROM PA7730 WHERE (wtax=1) and (PCLOSE=0) and (DATE_START < CURDATE() and DATE_END < CURDATE()) ORDER BY PERIODID", objdbRs, False
            add2LstBox objdbRs, ListView1, Array("DURATION", "PERIODID")
            
    End Select
End Sub

Sub add2LstBox(ByVal oRecordSet As ADODB.Recordset, ByVal oListBox As ListView, ByVal aField As Variant)
    Dim lstItem As ListItem
    
    If oRecordSet.RecordCount > 0 Then
        oListBox.ListItems.Clear
        While Not oRecordSet.EOF
            Set lstItem = oListBox.ListItems.Add()
            lstItem.Text = objdbRs(aField(1))
            lstItem.SubItems(1) = objdbRs(aField(0))
            oRecordSet.MoveNext
        Wend
    End If
End Sub



' + -->
' |     Procedure Name  :   ProcessTransaction
' |     Description     :   Process Payroll Transaction of a particular period
' |     Date Created    :   xx mar 2006
' + -->

' --> compute dtr summary here...
Function CheckDTR(ByVal cEmpid As String, _
                  aPeriodInfo As Variant, _
                  ByVal aEmpStat As Variant) As Variant
    Dim cSqlStmt As String, _
        oDTRRSet As New ADODB.Recordset, _
        aTimeInfo As Variant, _
        nCount As Integer, _
        cDateEnd As String
    
    aTimeInfo = Array(0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#, 0, 0, 0#)
    
    cSqlStmt = "select active, date_res, date_fin from di3670 where empid=" & cQuote & cEmpid & cQuote
    OpenQueryDNS cSqlStmt, objdbRs, False
    If objdbRs("active") > 0 Then
        cDateEnd = Format(IIf(objdbRs("active") = 1, objdbRs("date_res"), objdbRs("date_fin")), "yyyy-mm-dd")
        cSqlStmt = "select * from PA4329 " & _
                   "where (date between " & cQuote & aPeriodInfo(0) & cQuote & " and " & cQuote & cDateEnd & cQuote & ") " & _
                   "  or ((month(date)=" & Month(aPeriodInfo(0)) & ") and (day(date) between " & Day(aPeriodInfo(0)) & " and " & Day(cDateEnd) & ") and (fix_day=1))"
        OpenQueryDNS cSqlStmt, objdbRs, False
        nCount = objdbRs.RecordCount
    Else
        nCount = aPeriodInfo(2)
    End If
    
    
    cSqlStmt = "select EMPID, PERIODID, DATE, SHIFTID, " & _
               "  sum(reg_hr/8) as reg_day, sum(reg_ot_hr) as reg_ot, sum(sa_reg_ot) as sa_reg_ot, " & _
               "  sum(nd_hr/8) as nd_day, sum(nd_ot_hr) as nd_ot, sum(sa_nd_ot) as sa_nd_ot, " & _
               "  sum(sun_hr) as sun_hr, sum(sun_ot_hr) as sun_ot " & _
               "From di36770 " & _
               "where (empid=" & cQuote & cEmpid & cQuote & ") " & _
               "  and (date between " & cQuote & Format(aPeriodInfo(0), "yyyy-mm-dd") & cQuote & " and " & cQuote & Format(aPeriodInfo(1), "yyyy-mm-dd") & cQuote & ") " & _
               "group by empid "
    OpenQueryDNS cSqlStmt, oDTRRSet, False
    If oDTRRSet.RecordCount > 0 Then
        aTimeInfo(0) = oDTRRSet("reg_day")      ' --> Reg Day
        aTimeInfo(1) = oDTRRSet("reg_ot")       ' --> Reg OT
        aTimeInfo(2) = oDTRRSet("sa_reg_ot")    ' --> SA Reg OT
        aTimeInfo(3) = oDTRRSet("nd_day")       ' --> NDiff Day
        aTimeInfo(4) = oDTRRSet("nd_ot")        ' --> NDiff OT
        aTimeInfo(5) = oDTRRSet("sun_hr")       ' --> Sunday
        aTimeInfo(6) = oDTRRSet("sun_ot")       ' --> Sunday OT
        aTimeInfo(12) = oDTRRSet("sa_nd_ot")    ' --> SA NDiff OT
        aTimeInfo(7) = IIf((aEmpStat(0) <> 0) And (Not ((aEmpStat(0) = 1) And (aEmpStat(1) = 1))), nCount, 0)
    End If
    
    CheckDTR = aTimeInfo
    
    Set oDTRRSet = Nothing
End Function

'Function ChkLeave(ByVal dStartDate As Date, dEndDate As Date) As Variant
Function ChkLeave(ByVal oRecordSet As ADODB.Recordset) As Variant
    Dim nCtr As Integer, _
        aLeaveInfo As Variant, _
        cSqlStmt As String, _
        dStartDate As Date, dEndDate As Date
        
    aLeaveInfo = Array(0#, 0#)
    
    While Not oRecordSet.EOF
        dStartDate = oRecordSet("date_start")
        dEndDate = oRecordSet("date_end")
        For nCtr = 0 To DateDiff("d", dStartDate, dEndDate)
            If Weekday(DateAdd("d", nCtr, dStartDate)) <> vbSunday Then
                aLeaveInfo(0) = aLeaveInfo(0) + 1
            End If
            cSqlStmt = "select * from pa4329 " & _
                       " where (date=" & cQuote & Format(DateAdd("d", nCtr, dStartDate), "yyyy-mm-dd") & cQuote & ")" & _
                       " or ((month(date)=" & Month(DateAdd("d", nCtr, dStartDate)) & ") and (day(date)=" & Day(DateAdd("d", nCtr, dStartDate)) & ") and (fix_day=1))"
            OpenQueryDNS cSqlStmt, objdbRs, False
            If (objdbRs.RecordCount > 0) And (Weekday(DateAdd("d", nCtr, dStartDate)) <> vbSunday) Then
                aLeaveInfo(1) = aLeaveInfo(1) + 1
            End If
        Next nCtr
        oRecordSet.MoveNext
    Wend
    
    ChkLeave = aLeaveInfo
End Function

Sub ProcessTransaction()
    Dim nCtr, _
        nPeriod As Integer, _
        cDedID, cSqlStmt, cDepid, cParam As String, _
        aTimeInfo As Variant, _
        oRSetDed As New ADODB.Recordset, oRset1 As New ADODB.Recordset, _
        nDedAmt As Double, nDedAmt2 As Double, nDedAmt3 As Double, nTotDed As Double, _
        n13mopay As Double, _
        nIncentive As Double, nTotDay As Double, nTotExempt As Double, _
        aPeriodInfo As Variant, aDedAmt As Variant, aPayInfo As Variant, aLeaveInfo As Variant, _
        lAssess As Boolean, lIsWap As Boolean, lWithTax As Boolean, _
        aTmpTax As Variant
        
    
    aPeriodInfo = Array("", "", 0, 0, 0)
    ' (0)   -   Start Date
    ' (1)   -   End Date
    ' (2)   -   # of Holiday
    ' (3)   -   Working Days
    ' (4)   -   Annual Withholding Tax tag... 20070105
    
    aDedAmt = Array(0#, 0#, 0#, 0#, 0#, 0#, "")     ' --> for deduction purposes
    ' (0)   -   SSS ER
    ' (1)   -   SSS Premium
    ' (2)   -   Withholding Tax
    ' (3)   -   PhilHealth/Medicare PS
    ' (4)   -   PhilHealth/Medicare ES
    ' (5)   -   Medicare Total
    ' (6)   -   Loan Control Number - 20060816
    
    For nCtr = 0 To UBound(aTaxExempt)
        If Trim(aTaxExempt(nCtr)) = "" Then Exit For
        cDedID = cDedID & aTaxExempt(nCtr) & ","
    Next nCtr
    If Trim(cDedID) <> "" Then cDedID = left(cDedID, Len(cDedID) - 1)
    
    cParam = ListView1.SelectedItem.Text
    
    OpenQueryDNS "SELECT * FROM PA87260 WHERE PERIODID=" & cQuote & cParam & cQuote, objdbRs, False
    If objdbRs.RecordCount = 0 Then
    
        ' --> for special assessment only...
        If (Trim(gAssessID) <> "") Then
            cSqlStmt = "select DEF_AMT from pa3330 where dedid=" & cQuote & gAssessID & cQuote
            OpenQueryDNS cSqlStmt, objdbRs, False
            nAssessAmt = IIf(objdbRs.RecordCount > 0, objdbRs("def_amt"), 0)
            If (MsgBox("Is there special assessment?", vbYesNo, App.Title) = vbYes) Then
                frmSpecialAssess.txtAmount.Text = nAssessAmt
                frmSpecialAssess.Show 1
                lAssess = True
            End If
        Else
            lAssess = False
        End If
        
        ' --> retrieve period info here...
        OpenQueryDNS "SELECT * FROM PA7730 WHERE PERIODID=" & cQuote & cParam & cQuote, objdbRs, False
        nPeriod = IIf(objdbRs.RecordCount > 0, objdbRs("STATUS"), 0)
        aPeriodInfo(0) = Format(IIf(objdbRs.RecordCount > 0, objdbRs("DATE_START"), Now), "yyyy-mm-dd")
        aPeriodInfo(1) = Format(IIf(objdbRs.RecordCount > 0, objdbRs("DATE_END"), Now), "yyyy-mm-dd")
        aPeriodInfo(2) = IIf(objdbRs.RecordCount > 0, objdbRs("holidays"), 0)
        aPeriodInfo(3) = IIf(objdbRs.RecordCount > 0, objdbRs("workindays"), 0)
        aPeriodInfo(4) = IIf(objdbRs.RecordCount > 0, objdbRs("wtax"), 0)
        
        ' --> count holiday here...
        cSqlStmt = "select * from PA4329 " & _
                   "where (date between " & cQuote & aPeriodInfo(0) & cQuote & " and " & cQuote & aPeriodInfo(1) & cQuote & ") " & _
                   "  or ((month(date)=" & Month(aPeriodInfo(0)) & ") and (day(date) between " & Day(aPeriodInfo(0)) & " and " & Day(aPeriodInfo(1)) & ") and (fix_day=1))"
        OpenQueryDNS cSqlStmt, objdbRs, False
        If objdbRs.RecordCount > 0 Then aPeriodInfo(2) = objdbRs.RecordCount
        
        ' --> retrieve daily wage earner here... 20070118
        cSqlStmt = "SELECT EMPID, SHIFTID, TAXID, CONCAT(LASTNAME,', ',FIRSTNAME,if(trim(mname)='','',concat(' ',left(mname,1),'. '))) as FULLNAME, FIRSTNAME, MNAME, LASTNAME, DEPID, POSID, ISUNION, " & _
                   " RATE_AMT, COLA_AMT, POS_ALLOW, SSER1215, SSPREM1215, PS1215, ES1215, PAYSTATUS, EMP_STAT, WAP, DATE_RES, DATE_FIN, DATE_HIRE, " & _
                   " MTD_TAXABLE, MTD_BASIC, MTD_GROSS, YTD_BASIC, YTD_GROSS, YTD_GROSS_SA, YTD_COLA, " & _
                   " if(active>0,1,0) as active2, `ACTIVE`, SL_AVAIL, VL_AVAIL, SL_USE, VL_USE, PAGIBIGNO, SSNUM, PHEALTHNUM, TIN " & _
                   "FROM DI3670 " & _
                   "WHERE (paystatus=0) and ((ACTIVE=0) and ((date_hire<=" & cQuote & aPeriodInfo(0) & cQuote & ") or (date_hire between " & cQuote & aPeriodInfo(0) & cQuote & " and " & cQuote & aPeriodInfo(1) & cQuote & ")))" & _
                   " OR ((active=1) and ((date_res between " & cQuote & aPeriodInfo(0) & cQuote & " and " & cQuote & aPeriodInfo(1) & cQuote & ") or (date_res > " & cQuote & aPeriodInfo(1) & cQuote & "))) " & _
                   " OR ((active=2) and ((date_fin between " & cQuote & aPeriodInfo(0) & cQuote & " and " & cQuote & aPeriodInfo(1) & cQuote & ") or (date_fin > " & cQuote & aPeriodInfo(1) & cQuote & "))) " & _
                   "order by active2, if(active>0,'',depid), emp_stat desc, fullname"
'        Script2File cSqlStmt
        OpenQueryDNS cSqlStmt, oTempADO, False
        If oTempADO.RecordCount > 0 Then
        
            ShowProgress 0
            
            While Not oTempADO.EOF
            
                ' --> create seq_no here...
                If (oTempADO("active") = 0) Then
                    If (oTempADO("depid") <> cDepid) Then
                        lIsWap = False
                        cDepid = oTempADO("depid")
                        nCtr = 0
                    ElseIf oTempADO("emp_stat") = 0 Then
                        If Not lIsWap Then
                            lIsWap = True
                            nCtr = 0
                        End If
                    End If
                Else
                    If (cDepid <> "999") Then
                        lIsWap = False
                        cDepid = "999"
                        nCtr = 0
                    ElseIf oTempADO("emp_stat") = 0 Then
                        If Not lIsWap Then
                            lIsWap = True
                            nCtr = 0
                        End If
                    End If
                End If
                nCtr = nCtr + 1
                
                
                n13mopay = 0
                nTotDay = 0
                nIncentive = 0
                aPayInfo = Array(0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#)
                '    (0) = reg pay
                '    (1) = reg ot pay
                '    (2) = sa reg ot pay
                '    (3) = ndiff pay
                '    (4) = ndiff ot pay
                '    (5) = Sunday pay
                '    (6) = Sunday OT pay
                '    (7) = holiday pay
                '    (8) = Holiday OT hrs (reserved)
                '    (9) = basic pay
                '    (10) = gross pay
                '    (11) = sa net pay
                '    (12) = sa ndiff ot pay
                aLeaveInfo = Array(0#, 0#)
                                
                ShowProgress 2, (oTempADO.AbsolutePosition / oTempADO.RecordCount) * 100, , , "Retrieving data of " & oTempADO("FULLNAME")
                
                ' --> compute leave avail here...
                cSqlStmt = "select " & _
                           "  if(date_start<" & cQuote & aPeriodInfo(0) & cQuote & "," & cQuote & aPeriodInfo(0) & cQuote & ",date_start) as date_start, " & _
                           "  if(date_end>" & cQuote & aPeriodInfo(1) & cQuote & "," & cQuote & aPeriodInfo(1) & cQuote & ",date_end) as date_end, " & _
                           "  tag , paytag " & _
                           "From pa367583 " & _
                           "where (empid=" & cQuote & oTempADO("empid") & cQuote & ") and (status=1) " & _
                           "  and (paytag=0) and (tag in (0,1)) " & _
                           "  and ((date_start between " & cQuote & aPeriodInfo(0) & cQuote & " and " & cQuote & aPeriodInfo(1) & cQuote & ") " & _
                           "    or (date_end between " & cQuote & aPeriodInfo(0) & cQuote & " and " & cQuote & aPeriodInfo(1) & cQuote & ")) "
                OpenQueryDNS cSqlStmt, objdbRs, False
                If objdbRs.RecordCount > 0 Then
'                    aLeaveInfo = ChkLeave(objdbRs("date_start"), objdbRs("date_end"))
                    aLeaveInfo = ChkLeave(objdbRs)
                    nTotDay = aLeaveInfo(0) - aLeaveInfo(1)
                    nIncentive = Round(nTotDay * (oTempADO("RATE_AMT") / IIf(oTempADO("paystatus") = 0, 1, 26.08)), 2)
                End If
                
                ' --> compute "prerata" here...
                If oTempADO("active") > 0 Then
                    nTotDay = (DateDiff("d", "01/01/" & Year(Now), IIf(oTempADO("active") = 1, oTempADO("date_res"), oTempADO("date_fin")))) / 365
                    nIncentive = Round(nIncentive + ((nTotDay * (oTempADO("SL_AVAIL") + oTempADO("VL_AVAIL") - oTempADO("SL_USE") - oTempADO("VL_USE"))) * (oTempADO("RATE_AMT") / IIf(oTempADO("paystatus") = 0, 1, 26.08))), 2)
                End If
                
                
                ' --> 20060919 - use summary instead...
'                ' --> insert data from bio-clock here...
'                aTimeInfo = ComputeDays(oTempADO("EMPID"), _
'                                        Array(aPeriodInfo(0), aPeriodInfo(1), aPeriodInfo(2) - aLeaveInfo(1)), _
'                                        Array(oTempADO("EMP_STAT"), oTempADO("WAP")))
                
                If (oTempADO("active") = 0) And _
                   (Month(oTempADO("date_hire")) = Month(aPeriodInfo(0))) And _
                   (Year(oTempADO("date_hire")) = Year(aPeriodInfo(0))) Then
                    aTimeInfo = CheckDTR(oTempADO("EMPID"), _
                                         Array(Format(oTempADO("date_hire"), "yyyy-mm-dd"), aPeriodInfo(1), aPeriodInfo(2) - aLeaveInfo(1)), _
                                         Array(oTempADO("EMP_STAT"), oTempADO("WAP")))
                Else
                    aTimeInfo = CheckDTR(oTempADO("EMPID"), _
                                         Array(aPeriodInfo(0), aPeriodInfo(1), aPeriodInfo(2) - aLeaveInfo(1)), _
                                         Array(oTempADO("EMP_STAT"), oTempADO("WAP")))
                End If
                                       
                
                If oTempADO("paystatus") = 0 Then   ' --> Daily
                
                    aPayInfo(0) = Round(aTimeInfo(0) * oTempADO("RATE_AMT"), 2)                          ' --> reg pay
                    aPayInfo(1) = Round(aTimeInfo(1) * ((oTempADO("RATE_AMT") / 8) * 1.25), 2)            ' --> reg ot pay
                    aPayInfo(2) = Round(aTimeInfo(2) * ((oTempADO("RATE_AMT") / 8) * 1.25), 2)            ' --> sa reg ot pay
                    
                    aPayInfo(3) = Round(aTimeInfo(3) * (oTempADO("RATE_AMT") * 1.1), 2)                   ' --> ndiff pay
                    aPayInfo(4) = Round(aTimeInfo(4) * ((oTempADO("RATE_AMT") / 8) * 1.1 * 1.25), 2)      ' --> ndiff ot pay
                    aPayInfo(12) = Round(aTimeInfo(12) * ((oTempADO("RATE_AMT") / 8) * 1.1 * 1.25), 2)    ' --> sa ndiff ot pay
                    
                    aPayInfo(5) = Round(aTimeInfo(5) * ((oTempADO("RATE_AMT") / 8) * 1.3), 2)             ' --> sun pay
                    aPayInfo(6) = Round(aTimeInfo(6) * ((oTempADO("RATE_AMT") / 8) * 1.3 * 1.3), 2)       ' --> sun ot pay
                    
                    aPayInfo(7) = Round(aTimeInfo(7) * oTempADO("RATE_AMT"), 2)                           ' --> holiday pay
'                    aPayInfo(0) = 0
'                    aPayInfo(0) = 0
                                
                    '    Basic Pay = RegPay + NDiffPay
                    aPayInfo(9) = aPayInfo(0) + aPayInfo(3)
    
                    '    nGrossAmt = RegPay +
                    '                RegOTPay +
                    '                NDiffPay +
                    '                NDiffOTPay +
                    '                HolPay +
                    '                PosAllow +
                    '                COLA +
                    '                Incentive Leave +
                    '                Adjustment             --> ala p 2 computation d2...
                    aPayInfo(10) = Round(aPayInfo(0) + _
                                   aPayInfo(1) + _
                                   aPayInfo(3) + _
                                   aPayInfo(4) + _
                                   aPayInfo(7) + _
                                   IIf(aTimeInfo(0) + aTimeInfo(3) + aTimeInfo(5) > 0, oTempADO("POS_ALLOW"), 0) + _
                                   Round((oTempADO("COLA_AMT") * (aTimeInfo(3) + aTimeInfo(0))), 2) + _
                                   nIncentive, 2)
                    
                    '    nNetAmt = SARegOTPay +
                    '              SANDiffOTPay +
                    '              SunCola +
                    '              SunPay +
                    '              SunOTPay +
                    '              SAAdjPay         --> ala p 2 computation d2...
                    aPayInfo(11) = Round(aPayInfo(2) + _
                                   aPayInfo(12) + _
                                   Round((oTempADO("COLA_AMT") * (aTimeInfo(5) / 8)), 2) + _
                                   aPayInfo(5) + _
                                   aPayInfo(6), 2)
                             
                Else    ' --> monthly
                    If aTimeInfo(0) = 0 Then
                        aPayInfo(0) = 0
                    Else
                        aPayInfo(0) = Round((oTempADO("rate_amt") / 2) - ((oTempADO("rate_amt") / 26.08) * (aPeriodInfo(3) - aTimeInfo(0))), 2)
                    End If
'                    aPayInfo(7) = aTimeInfo(7) * (oTempADO("rate_amt") / 26.08)
                    aPayInfo(9) = aPayInfo(0)
                    aPayInfo(10) = Round(aPayInfo(0) + _
                                   aPayInfo(1) + _
                                   aPayInfo(3) + _
                                   aPayInfo(7) + _
                                   nIncentive, 2)
                                   
                End If
                         
                
                ' --> revised 20070105
                If aPeriodInfo(4) > 0 Then
                    n13mopay = 0
                Else
                    ' --> 13th month here...
                    If (oTempADO("active") > 0) And (oTempADO("wap") = 0) Then
                        If oTempADO("EMP_STAT") = 1 Then
                            ' --> 20060724 n13MOPay = (oTempADO("YTD_BASIC") - oTempADO("YTD_COLA") + aPayInfo(9) - (oTempADO("COLA_AMT") * (aTimeInfo(3) + aTimeInfo(0)))) / 12
                            n13mopay = Round((oTempADO("YTD_BASIC") + aPayInfo(9)) / 12, 2)
                        ElseIf oTempADO("EMP_STAT") = 2 Then
                            n13mopay = Round((oTempADO("YTD_GROSS") + oTempADO("YTD_GROSS_SA") - oTempADO("YTD_COLA") + aPayInfo(10) + aPayInfo(11) - (oTempADO("COLA_AMT") * (aTimeInfo(3) + aTimeInfo(0)))) / 12, 2)
                        Else
                            n13mopay = 0
                        End If
                    End If
                End If
                
                
                ' --> days worked transaction saved here...
                cSqlStmt = "INSERT INTO PA87260(PERIODID,PERIOD_STAT,P_DAY,P_HOLIDAY,SEQ_NO,EMPID,FULLNAME,FIRSTNAME,MNAME,LASTNAME,date_hire,DATE_RES," & _
                           "WAP,EMP_STAT,`ACTIVE`,PAYSTATUS,TAXID,DEPID,RATE_AMT,COLA_AMT,COLA,SUN_COLA,POSID,POS_ALLOW," & _
                           "BASIC1215,GROSS16231,TAX1215,SSER1215,SSPREM1215,PS1215,ES1215," & _
                           "REG_DAY,REG_OT_HR,SA_REG_OT,NDIFF_DAY,NDIFF_OT_HR,SA_NDIFF_OT,SUN_HR,SUN_OT,`HOLIDAY`," & _
                           "REG_PAY,REG_OT_PAY,SA_REG_PAY,NDIFF_PAY,NDIFF_OT_PAY,SA_NDIFF_PAY,SUN_PAY,SUN_OT_PAY,HOL_PAY," & _
                           "BASICPAY,GROSS_PAY,SA_NET_PAY,LEAVE_PAY,M13PAY,PAGIBIGNO,SSSNUM,PHEALTHNUM,TINNUM)VALUES(" & _
                           cQuote & cParam & cQuote & "," & nPeriod & "," & aPeriodInfo(3) & "," & aPeriodInfo(2) & "," & _
                           nCtr & "," & cQuote & oTempADO("EMPID") & cQuote & "," & _
                           cQuote & DecodeStr(oTempADO("FULLNAME")) & cQuote & "," & cQuote & DecodeStr(oTempADO("FIRSTNAME")) & cQuote & "," & cQuote & DecodeStr(oTempADO("MNAME")) & cQuote & "," & cQuote & oTempADO("LASTNAME") & cQuote & "," & _
                           cQuote & Format(oTempADO("date_hire"), "yyyy-mm-dd") & cQuote & "," & cQuote & Format(IIf(oTempADO("active") = 1, oTempADO("date_res"), oTempADO("date_fin")), "yyyy-mm-dd") & cQuote & "," & _
                           oTempADO("WAP") & "," & oTempADO("EMP_STAT") & "," & oTempADO("ACTIVE") & "," & oTempADO("PAYSTATUS") & "," & _
                           cQuote & oTempADO("TAXID") & cQuote & "," & cQuote & oTempADO("DEPID") & cQuote & "," & _
                           oTempADO("RATE_AMT") & "," & _
                           oTempADO("COLA_AMT") & "," & Round((oTempADO("COLA_AMT") * (aTimeInfo(3) + aTimeInfo(0))), 2) & "," & Round(oTempADO("COLA_AMT") * (aTimeInfo(5) / 8), 2) & "," & _
                           cQuote & oTempADO("POSID") & cQuote & "," & IIf(aTimeInfo(0) + aTimeInfo(3) + aTimeInfo(5) > 0, oTempADO("POS_ALLOW"), 0) & "," & _
                           oTempADO("MTD_BASIC") & "," & oTempADO("MTD_GROSS") & "," & oTempADO("MTD_TAXABLE") & "," & oTempADO("SSER1215") & "," & oTempADO("SSPREM1215") & "," & oTempADO("PS1215") & "," & oTempADO("ES1215") & "," & _
                           aTimeInfo(0) & "," & aTimeInfo(1) & "," & aTimeInfo(2) & "," & aTimeInfo(3) & "," & aTimeInfo(4) & "," & aTimeInfo(12) & "," & aTimeInfo(5) & "," & aTimeInfo(6) & "," & aTimeInfo(7) & "," & _
                           aPayInfo(0) & "," & aPayInfo(1) & "," & aPayInfo(2) & "," & aPayInfo(3) & "," & aPayInfo(4) & "," & aPayInfo(12) & "," & aPayInfo(5) & "," & aPayInfo(6) & "," & aPayInfo(7) & "," & _
                           aPayInfo(9) & "," & aPayInfo(10) + n13mopay & "," & aPayInfo(11) & "," & nIncentive & "," & n13mopay & "," & _
                           cQuote & oTempADO("PAGIBIGNO") & cQuote & "," & cQuote & oTempADO("SSNUM") & cQuote & "," & _
                           cQuote & IIf(Trim(oTempADO("PHEALTHNUM")) = "", oTempADO("SSNUM"), oTempADO("PHEALTHNUM")) & cQuote & "," & cQuote & oTempADO("TIN") & cQuote & ")"
                OpenQueryDNS cSqlStmt, objdbRs, True
                Script2File cSqlStmt
                
                ' --> deduction transaction saved here...
                ' --> WAP is excluded in deductions...
                If (oTempADO("EMP_STAT") <> 0) And Not ((oTempADO("WAP") = 1) And (oTempADO("EMP_STAT") = 1)) Then 'And (nGrossAmt > 0) Then
                    cSqlStmt = "select DEDID,DEF_AMT,FIX_DED,DEDTAG, DEDTYPE from pa3330 where " & IIf(nPeriod = 1, "PERIOD1=1", "PERIOD2=1")
                    OpenQueryDNS cSqlStmt, oRSetDed, False
                    If oRSetDed.RecordCount > 0 Then
                        aDedAmt = Array(0#, 0#, 0#, 0#, 0#, 0#, "")
                        nTotDed = 0
                        
                        ' --> added 20061003
                        nTotExempt = 0
                        lWithTax = False
                        
                        While Not oRSetDed.EOF
                            nDedAmt = 0
                            nDedAmt2 = 0
                            nDedAmt3 = 0
                            
                            If aPayInfo(10) > 0 Then
                                Select Case oRSetDed("DEDID")
                                    Case "001"      ' --> SSS Premium
                                        cSqlStmt = "select ER_SS, EE_SS, ER_EC  from pa7770 where " & (oTempADO("MTD_GROSS") + aPayInfo(10)) & " between range1 and range2"
                                        OpenQueryDNS cSqlStmt, objdbRs, False
                                        nDedAmt = IIf(objdbRs.RecordCount > 0, objdbRs("EE_SS"), 0) - IIf(nPeriod = 2, oTempADO("SSPREM1215"), 0)
                                        nDedAmt2 = IIf(objdbRs.RecordCount > 0, objdbRs("ER_SS"), 0) - IIf(nPeriod = 2, oTempADO("SSER1215"), 0)
                                        nDedAmt3 = IIf(objdbRs.RecordCount > 0, objdbRs("ER_EC"), 0)
                                        aDedAmt(0) = nDedAmt
                                        aDedAmt(1) = nDedAmt2
                                        aDedAmt(5) = IIf(objdbRs.RecordCount > 0, objdbRs("ER_EC"), 0)
                                        
                                        If InStr(1, cDedID, oRSetDed("dedid")) > 1 Then nTotExempt = nTotExempt + nDedAmt
                                        
                                    Case "003"      ' --> Pag-Ibig Premium
                                        If ((oTempADO("MTD_BASIC") + aPayInfo(9)) * 0.02) >= oRSetDed("def_amt") Then
                                            nDedAmt = oRSetDed("def_amt")
                                        Else
                                            nDedAmt = (oTempADO("MTD_BASIC") + aPayInfo(9)) * 0.02
                                        End If
                                        If InStr(1, cDedID, oRSetDed("dedid")) > 1 Then nTotExempt = nTotExempt + nDedAmt
                                        
                                    Case "005"      ' --> PhilHealth/Medicare
                                        If aDedAmt(0) > 0 Then
                                            cSqlStmt = "select def_amt from di3673 " & _
                                                       " where (empid=" & cQuote & oTempADO("EMPID") & cQuote & ")" & _
                                                       " and (dedid=" & cQuote & oRSetDed("DEDID") & cQuote & ")" & _
                                                       " and (" & IIf(nPeriod = 1, "period1=1", "period2=1") & ")"
                                            OpenQueryDNS cSqlStmt, oRset1, False
                                            
                                            cSqlStmt = "select PS, ES from PA7454 where " & (oTempADO("MTD_GROSS") + aPayInfo(10)) & " between range1 and range2"
                                            OpenQueryDNS cSqlStmt, objdbRs, False
                                            If oRset1.RecordCount > 0 Then
                                                nDedAmt = oRset1("def_amt") - IIf(nPeriod = 2, oTempADO("PS1215"), 0)
                                            Else
                                                nDedAmt = IIf(objdbRs.RecordCount > 0, objdbRs("PS"), 0) - IIf(nPeriod = 2, oTempADO("PS1215"), 0)
                                            End If
                                            nDedAmt2 = IIf(objdbRs.RecordCount > 0, objdbRs("ES"), 0) - IIf(nPeriod = 2, oTempADO("ES1215"), 0)
                                            aDedAmt(3) = nDedAmt
                                            aDedAmt(4) = nDedAmt2
                                        Else
                                            aDedAmt(3) = 0
                                            aDedAmt(4) = 0
                                        End If
                                        If InStr(1, cDedID, oRSetDed("dedid")) > 1 Then nTotExempt = nTotExempt + nDedAmt
                                    
                                    Case "006"      ' --> Withholding Tax
                                        If oTempADO("emp_stat") = 2 Then lWithTax = True
                                        
                                    Case Else
'                                        If oTempADO("empid") = "235601" Then MsgBox "test"
                                        ' --> custom employee deduction
'                                        If oTempADO("empid") = "294038" Then MsgBox "test"
                                        cSqlStmt = "select def_amt, cut_off_amt, acc_amt, ctrl_no from di3673 " & _
                                                   " where (empid=" & cQuote & oTempADO("EMPID") & cQuote & ")" & _
                                                   " and (dedid=" & cQuote & oRSetDed("DEDID") & cQuote & ")" & _
                                                   " and (status=0)" & _
                                                   " and (period" & nPeriod & "=1)"
                                        OpenQueryDNS cSqlStmt, oRset1, False
                                        If oRset1.RecordCount > 0 Then
                                            If oRset1("cut_off_amt") > oRset1("acc_amt") Then
                                                aDedAmt(6) = oRset1("ctrl_no")
                                                If (oRset1("acc_amt") + oRset1("def_amt")) > oRset1("cut_off_amt") Then
                                                    nDedAmt = oRset1("cut_off_amt") - oRset1("acc_amt")
                                                Else
                                                    nDedAmt = oRset1("def_amt")
                                                End If
                                                If InStr(1, cDedID, oRSetDed("dedid")) > 1 Then nTotExempt = nTotExempt + nDedAmt
                                            End If
                                        Else
                                            If oRSetDed("dedtype") <> 1 Then
                                                If oRSetDed("dedtag") = 1 Then
                                                    If oTempADO("emp_stat") = 2 Then
                                                        If oTempADO("isunion") = 0 Then
                                                            If (gAssessID = oRSetDed("DEDID")) Then
                                                                ' --> special assessment
                                                                nDedAmt = IIf(lAssess, nAssessAmt, 0)
                                                            Else
                                                                ' --> for Union Dues...
                                                                nDedAmt = oRSetDed("DEF_AMT")
                                                            End If
                                                        End If
                                                    End If
                                                Else
                                                    ' --> default deduction
                                                    nDedAmt = oRSetDed("DEF_AMT")
                                                End If
                                                If InStr(1, cDedID, oRSetDed("dedid")) > 1 Then nTotExempt = nTotExempt + nDedAmt
'                                            Else
'                                                ' --> if dedtype=1, at ala s custom deduction, 0 para sure...
'                                                nDedAmt = 0
                                            End If
                                        End If
                                    
                                End Select
                            End If
                            
                            cSqlStmt = "INSERT INTO PA87263(PERIODID, PERIOD_STAT, EMPID, DEDID, CTRL_NO, DED_AMT, DED_AMT2, DED_AMT3, COMPUTED)VALUES(" & _
                                       cQuote & cParam & cQuote & "," & nPeriod & "," & _
                                       cQuote & oTempADO("EMPID") & cQuote & "," & _
                                       cQuote & oRSetDed("DEDID") & cQuote & "," & _
                                       cQuote & aDedAmt(6) & cQuote & "," & _
                                       Round(nDedAmt, 2) & "," & _
                                       Round(nDedAmt2, 2) & "," & _
                                       Round(nDedAmt3, 2) & "," & _
                                       oRSetDed("FIX_DED") & ")"
                            OpenQueryDNS cSqlStmt, objdbRs, True
                            Script2File cSqlStmt
                            
                            nTotDed = nTotDed + Round(nDedAmt, 2)
                            
                            oRSetDed.MoveNext
                        Wend
                        
                        
                        ' --> added 20061004
                        If lWithTax Then
                            
                            ' --> revised 20070105
                            If aPeriodInfo(4) > 0 Then
                            
                                ' --> annual withholding tax...
                                aTmpTax = ComputeTax(cParam, oTempADO("empid"), cDedID, Year(aPeriodInfo(1)), aPayInfo(10), nTotExempt)
                                nDedAmt = aTmpTax(0)
                                aDedAmt(2) = aTmpTax(0)
                            Else
                            
                                If oTempADO("emp_stat") = 2 Then
                                    cSqlStmt = "select ded_pct, ded_amt, ded_amt2 from pa8293 " & _
                                               " where (taxid=" & cQuote & oTempADO("TAXID") & cQuote & ") and (" & (oTempADO("MTD_TAXABLE") + (aPayInfo(10) - nTotExempt)) & ">=ded_amt2)" & _
                                               " order by ded_amt2 desc limit 1"
                                    OpenQueryDNS cSqlStmt, objdbRs, False
                                    If objdbRs.RecordCount > 0 Then
                                        If objdbRs("DED_PCT") > 0 Then
                                            nDedAmt = objdbRs("DED_AMT") + (((oTempADO("MTD_TAXABLE") + (aPayInfo(10) - nTotExempt)) - objdbRs("DED_AMT2")) * (objdbRs("DED_PCT") / 100))
                                        Else
                                            nDedAmt = 0
                                        End If
                                    End If
                                    aDedAmt(2) = nDedAmt
                                End If
                            
                                If IfExists("pa87263", "(periodid=" & cQuote & cParam & cQuote & ") and (empid=" & cQuote & oTempADO("empid") & cQuote & ") and (dedid='006')") Then
                                    cSqlStmt = "update pa87263 set ded_amt = " & Round(nDedAmt, 2) & _
                                               " where (periodid=" & cQuote & cParam & cQuote & ") and (empid=" & cQuote & oTempADO("empid") & cQuote & ") and (dedid='006')"
                                Else
                                    cSqlStmt = "INSERT INTO PA87263(PERIODID, PERIOD_STAT, EMPID, DEDID, CTRL_NO, DED_AMT, DED_AMT2, DED_AMT3, COMPUTED)VALUES(" & _
                                               cQuote & cParam & cQuote & "," & nPeriod & "," & _
                                               cQuote & oTempADO("EMPID") & cQuote & "," & _
                                               cQuote & "006" & cQuote & "," & _
                                               cQuote & aDedAmt(6) & cQuote & "," & _
                                               Round(nDedAmt, 2) & "," & _
                                               Round(nDedAmt2, 2) & "," & _
                                               Round(nDedAmt3, 2) & "," & _
                                               "0" & ")"
                                End If
                                OpenQueryDNS cSqlStmt, objdbRs, True
                                Script2File cSqlStmt
                                
                            End If
                            ' --> end of revision 20070105
                            
                            nTotDed = nTotDed + Round(nDedAmt, 2)
                        End If
                        
                    End If
                    
                    If (nTotDed <> 0) Then
                        cSqlStmt = "UPDATE PA87260 SET DED_AMT=" & Round(nTotDed, 2) & "," & _
                                   " SSPREM=" & Round(aDedAmt(0), 2) & "," & _
                                   " SSER=" & Round(aDedAmt(1), 2) & "," & _
                                   " SSS01=" & Round(aDedAmt(0) + aDedAmt(1), 2) & "," & _
                                   " EC001=" & aDedAmt(5) & "," & _
                                   " MEDICARE=" & Round(aDedAmt(3), 2) & "," & _
                                   " MEDICARE2=" & Round(aDedAmt(4), 2) & "," & _
                                   " MED01=" & Round(aDedAmt(3) + aDedAmt(4), 2) & "," & _
                                   " TAXABLE=" & Round(aPayInfo(10) - nTotExempt, 2) & "," & _
                                   " WTAX=" & Round(aDedAmt(2), 2) & "," & _
                                   " NET_PAY=" & Round(aPayInfo(10) + n13mopay - nTotDed, 2) & _
                                   " WHERE PERIODID=" & cQuote & cParam & cQuote & _
                                   " AND EMPID=" & cQuote & oTempADO("EMPID") & cQuote
                    Else
                        cSqlStmt = "UPDATE PA87260 SET NET_PAY=" & Round(aPayInfo(10) + n13mopay, 2) & "," & _
                                   " DED_AMT=0," & _
                                   " SSPREM=0," & _
                                   " SSER=0," & _
                                   " SSS01=0," & _
                                   " EC001=0," & _
                                   " MEDICARE=0," & _
                                   " MEDICARE2=0," & _
                                   " MED01=0," & _
                                   " TAXABLE=0," & _
                                   " WTAX=0" & _
                                   " WHERE PERIODID=" & cQuote & cParam & cQuote & _
                                   " AND EMPID=" & cQuote & oTempADO("EMPID") & cQuote
                    End If
                    OpenQueryDNS cSqlStmt, objdbRs, True
                    Script2File cSqlStmt
                Else
                    cSqlStmt = "UPDATE PA87260 SET NET_PAY=" & Round(aPayInfo(10) + n13mopay, 2) & "," & _
                               " DED_AMT=0," & _
                               " SSPREM=0," & _
                               " SSER=0," & _
                               " SSS01=0," & _
                               " EC001=0," & _
                               " MEDICARE=0," & _
                               " MEDICARE2=0," & _
                               " MED01=0," & _
                               " TAXABLE=0," & _
                               " WTAX=0" & _
                               " WHERE PERIODID=" & cQuote & cParam & cQuote & _
                               " AND EMPID=" & cQuote & oTempADO("EMPID") & cQuote
                    OpenQueryDNS cSqlStmt, objdbRs, True
                    Script2File cSqlStmt
                End If
                           
                oTempADO.MoveNext
                
            Wend
            
            ShowProgress 4
            
            GoTo ShowData
        End If
        
    Else
        GoTo ShowData
    End If
    
    Exit Sub

ShowData:

    Set oRSetDed = Nothing
    Set oRset1 = Nothing

    GetUserRights PadStr(frmMain.mnuTransaction.Name, " ", 100, PadRight), gUserID
    frmTransaction.lblPeriod.Caption = cParam
    frmTransaction.lblDuration.Caption = ListView1.SelectedItem.SubItems(1) & " Payroll"
    frmTransaction.Show
End Sub



' + -->
' |     Procedure Name  :   GenEmpList(ByVal cParam As String, nmode As Integer)
' |     Description     :   Utility to generate Employee Masterlist
' |     Date Created    :   xx mar 2006
' + -->
Sub CreateTmpEmp()
    On Error GoTo ErrCreate
    Dim cSqlStmt As String
    
    cSqlStmt = "CREATE TABLE tmpEmpLst(" & _
               "[LINEID] char(3),           [LINENAME] char(100)," & _
               "[EMPID] char(6),            [FULLNAME] char(100)," & _
               "[date_hire] date,           [date_end] date," & _
               "[birthday] date,            [status] integer," & _
               "[ssnum] char(15),           [pagibigno] char(15),       [tin] char(15)," & _
               "[rate_amt] double,          [cola_amt] double," & _
               "[pos_allow] double,         [emp_stat] integer," & _
               "[paystatus] integer,        [active] integer," & _
               "[sex] char(10),             [position] char(100)," & _
               "[taxcode] char(10),         [shiftname] char(100))"
              
    oTempConn.Execute cSqlStmt
    While oTempConn.State = adStateExecuting
        DoEvents
    Wend
ErrCreate:
    ' in case table is already existing, let's clear it...
    QueryTemp "DELETE FROM tmpEmpLst", oTempADO, True
End Sub

Sub GenEmpList(ByVal cPeriod As String, cParam As String, nMode As Integer)
    Dim cSqlStmt As String, _
        oRset1 As New ADODB.Recordset, _
        oRSet2 As New ADODB.Recordset, _
        oRset3 As New ADODB.Recordset, _
        oRSet4 As New ADODB.Recordset, _
        aOtherInfo As Variant, _
        cString As String
        
    aOtherInfo = Array("", "", "", "")
    
    CreateTmpEmp
    
    ShowProgress 0
    
    
    cString = " and a.active " & IIf(nMode <> 0, "> 0", "=0")
    
    If Trim(cParam) <> "" Then
        cParam = " and a.depid IN " & cParam
    End If
    
    cSqlStmt = " SELECT a.date_hire,b.birthday,b.date_fin,a.date_res,a.active,a.empid, a.firstname, a.mname, a.lastname, concat(a.lastname,', ',a.firstname) as fullname, b.sex, b.posid, a.depid, " & _
               " a.date_hire,b.birthday,b.date_fin,a.date_res, b.status, a.rate_amt, a.cola_amt, a.pos_allow, b.isunion, a.emp_stat, a.paystatus, a.active,  " & _
               " a.taxid, b.shiftid,b.ssnum , b.pagibigno, b.tin "

    
    OpenQueryDNS "select pclose from pa7730 where periodid =" & cQuote & cPeriod & cQuote, objdbRs, False
    If objdbRs.RecordCount > 0 Then
        If objdbRs("pclose") <> 1 Then
            
            cSqlStmt = cSqlStmt & " FROM pa87260 a left join di3670 b on a.empid=b.empid "
        
        Else
            cSqlStmt = cSqlStmt & " FROM pah87260 a left join di3670 b on a.empid=b.empid "

        End If
    End If
        
    cSqlStmt = cSqlStmt & "where a.periodid=" & cQuote & cPeriod & cQuote & cString & cParam
'    Script2File cSqlStmt
'    MsgBox cSqlStmt
'            cSqlStmt = "select a.date_hire, a.birthday, a.date_fin, a.date_res, a.status, a.rate_amt, a.cola_amt, a.pos_allow, a.isunion, a.emp_stat, a.paystatus, a.active, " & _
'                       " a.empid, a.firstname, a.mname, a.lastname, concat(a.lastname,', ',a.firstname) as fullname, a.sex, a.posid, a.depid, a.taxid, a.shiftid," & _
'                       " a.ssnum, a.pagibigno, a.tin from di3670 a"
               
'    cSqlStmt = cSqlStmt & " where a.active=" & nmode & IIf(Trim(cParam) = "", "", " and " & cParam)
    OpenQueryDNS cSqlStmt, oTempADO, False
    If oTempADO.RecordCount > 0 Then
        
        OpenQueryDNS "select posid, posname from DI7670 order by posid", oRset1, False
        OpenQueryDNS "select lineid, linename from di5463 order by lineid", oRSet2, False
        OpenQueryDNS "select taxid, taxcode, taxname from pa8290 order by taxid", oRset3, False
        OpenQueryDNS "select shiftid, `description` from pa74380 order by shiftid", oRSet4, False
        
        While Not oTempADO.EOF
            
            ShowProgress 2, (oTempADO.AbsolutePosition / oTempADO.RecordCount) * 100, , , "Processing data for " & oTempADO("fullname")
            
            If oRset1.RecordCount > 0 Then
                oRset1.Requery adAsyncFetch
                oRset1.Find "posid='" & oTempADO("posid") & "'"
                aOtherInfo(0) = IIf(oRset1.EOF, "", oRset1("posname"))
            End If
            
            If oRSet2.RecordCount > 0 Then
                oRSet2.Requery adAsyncFetch
                oRSet2.Find "lineid='" & oTempADO("depid") & "'"
                aOtherInfo(1) = IIf(oRSet2.EOF, "", oRSet2("linename"))
            End If
            
            If oRset3.RecordCount > 0 Then
                oRset3.Requery adAsyncFetch
                oRset3.Find "taxid='" & oTempADO("taxid") & "'"
                aOtherInfo(2) = IIf(oRset3.EOF, "", oRset3("taxcode"))
            End If
            
            If oRSet4.RecordCount > 0 Then
                oRSet4.Requery adAsyncFetch
                oRSet4.Find "shiftid='" & oTempADO("shiftid") & "'"
                aOtherInfo(3) = IIf(oRSet4.EOF, "", oRSet4("description"))
            End If
            
            cSqlStmt = "insert into tmpEmpLst(empid,fullname,lineid,linename,date_hire,date_end,birthday,[status]," & _
                       " rate_amt,cola_amt,pos_allow,emp_stat,paystatus,[active],[sex],[position],taxcode,shiftname," & _
                       " ssnum, pagibigno, [tin])values(" & _
                       cQuote & oTempADO("empid") & cQuote & "," & cQuote & DecodeStr(EncodeStr2(oTempADO("fullname"))) & cQuote & "," & _
                       cQuote & oTempADO("depid") & cQuote & "," & cQuote & DecodeStr(EncodeStr2(aOtherInfo(1))) & cQuote & "," & _
                       cQuote & Format(oTempADO("date_hire"), "mm/dd/yyyy") & cQuote & "," & cQuote & Format(IIf(oTempADO("active") = 0, Now, IIf(oTempADO("active") = 1, oTempADO("date_res"), oTempADO("date_fin"))), "mm/dd/yyyy") & cQuote & "," & _
                       cQuote & Format(oTempADO("birthday"), "mm/dd/yyyy") & cQuote & "," & oTempADO("status") & "," & _
                       oTempADO("rate_amt") & "," & oTempADO("cola_amt") & "," & oTempADO("pos_allow") & "," & _
                       oTempADO("emp_stat") & "," & oTempADO("paystatus") & "," & oTempADO("active") & "," & _
                       cQuote & IIf(oTempADO("sex") = 0, "Male", "Female") & cQuote & "," & _
                       cQuote & DecodeStr(EncodeStr2(aOtherInfo(0))) & cQuote & "," & cQuote & DecodeStr(EncodeStr2(aOtherInfo(2))) & cQuote & "," & _
                       cQuote & DecodeStr(EncodeStr2(aOtherInfo(3))) & cQuote & "," & _
                       cQuote & DecodeStr(EncodeStr2(oTempADO("ssnum"))) & cQuote & "," & _
                       cQuote & DecodeStr(EncodeStr2(oTempADO("pagibigno"))) & cQuote & "," & _
                       cQuote & DecodeStr(EncodeStr2(oTempADO("tin"))) & cQuote & ")"
'            MsgBox cSqlStmt
            QueryTemp cSqlStmt, objdbRs, True
            
            oTempADO.MoveNext
        Wend
    End If
    
    ShowProgress 3
    
    QueryTemp "select * from tmpEmpLst", objdbRs, False
    If objdbRs.RecordCount > 0 Then
        GenerateReport IIf(nMode = 0, "", "Resigned/Finished") & " Employee Report Listing", "lst3670.rpt"
    Else
        MsgBox "No report to generate!", vbInformation, "System Advisory!!!"
    End If
    
    ShowProgress 4
    
EndGenEmp:
    Set oRset1 = Nothing
    Set oRSet2 = Nothing
    Set oRset3 = Nothing
    Set oRSet4 = Nothing

    Exit Sub
    
ErrGenEmp:
    ErrorMsg Err.Number, Err.Description, "Employee Report Listing", Name
    
    Resume EndGenEmp
End Sub



Sub CreateTmpEmpSum()
    On Error GoTo ErrCreate
    Dim cSqlStmt As String
    
'    cSqlStmt = "CREATE TABLE tmpEmpLstsum(" & _
'               "[Con] char(3),             [Con_SM] double, " & _
'               "[Con_SF] double, " & _
'               "[Wap_UH] char(3),          [Wap_UH_SM] double, " & _
'               "[Wap_UH_SF] double, " & _
'               "[Wap_H] char(3),           [Wap_H_SM] double, " & _
'               "[Wap_H_SF] double)"
              
    cSqlStmt = " CREATE TABLE tmpEmpLstsum(" & _
               " [Name] char(100),           [Name_SM] double, " & _
               " [Name_SF] double,           [emp_stat] double, " & _
               " [Wap] double)"

    oTempConn.Execute cSqlStmt
    While oTempConn.State = adStateExecuting
        DoEvents
    Wend
ErrCreate:
    ' in case table is already existing, let's clear it...
    QueryTemp "DELETE FROM tmpEmpLstsum", oTempADO, True
End Sub

Sub GenEmpListSum(ByVal cPeriod As String, cParam As String, nMode As Integer)
    Dim cSqlStmt As String, _
        oRecordSet As New ADODB.Recordset, _
        oRSet As New ADODB.Recordset, _
        oRSet2 As New ADODB.Recordset, _
        aOtherInfo As Variant, _
        cString As String, _
        cString2 As String, _
        nCtr As Integer, _
        cPclose As String
        
    aOtherInfo = Array("", 0#, 0#, 0#)
    
    ShowProgress 0

    CreateTmpEmpSum
    
    OpenQueryDNS "SELECT emp_stat,wap FROM di3670 group by emp_stat,wap ", oRSet, False
    If oRSet.RecordCount > 0 Then
    
        While Not oRSet.EOF
            ShowProgress 2, (oRSet.AbsolutePosition / oRSet.RecordCount) * 100, , , "Processing data... "
            If (oRSet("emp_stat") <> 0) Or (oRSet("wap") <> 1) Then
                If (oRSet("emp_stat") = 0) And (oRSet("wap") = 0) Then
                    aOtherInfo(0) = "WAP"
                    aOtherInfo(1) = oRSet("emp_stat")
                    aOtherInfo(2) = oRSet("wap")
                ElseIf (oRSet("emp_stat") = 2) And (oRSet("wap") = 0) Then
                    aOtherInfo(0) = "Regular"
                    aOtherInfo(1) = oRSet("emp_stat")
                    aOtherInfo(2) = oRSet("wap")
                ElseIf (oRSet("emp_stat") = 1) And (oRSet("wap") = 0) Then
                    aOtherInfo(0) = "Contractual Unhide"
                    aOtherInfo(1) = oRSet("emp_stat")
                    aOtherInfo(2) = oRSet("wap")
                ElseIf (oRSet("emp_stat") = 1) And (oRSet("wap") = 1) Then
                    aOtherInfo(0) = "Contractual Hide"
                    aOtherInfo(1) = oRSet("emp_stat")
                    aOtherInfo(2) = oRSet("wap")
                End If
                cSqlStmt = "insert into tmpEmpLstsum(Name,Name_SM,Name_SF,emp_stat,Wap)values(" & _
                           cQuote & DecodeStr(EncodeStr2(aOtherInfo(0))) & cQuote & ",0,0," & _
                           aOtherInfo(1) & "," & aOtherInfo(2) & ")"
                           
'                MsgBox cSqlStmt
                QueryTemp cSqlStmt, objdbRs, True

            End If
            
            
            oRSet.MoveNext
        Wend
        ShowProgress 4
    End If
    
    ShowProgress 0
    
    cString = " and a.active " & IIf(nMode <> 0, "> 0", "=0")

    If Trim(cParam) <> "" Then
        cParam = " and a.depid IN " & cParam
    End If


    OpenQueryDNS "select pclose from pa7730 where periodid =" & cQuote & cPeriod & cQuote, objdbRs, False
    If objdbRs.RecordCount > 0 Then
        cPclose = IIf(objdbRs("pclose") <> 0, "pah87260", "pa87260")
    Else
        cPclose = ""
    End If

    cSqlStmt = " SELECT a.emp_stat,b.sex,a.wap FROM " & cPclose & " a " & _
               " left join di3670 b on a.empid=b.empid" & _
               " Where (a.periodid = " & cQuote & cPeriod & cQuote & cString & ") " & cParam & _
               " order by a.emp_stat,a.wap "
    OpenQueryDNS cSqlStmt, oRecordSet, False
    If oRecordSet.RecordCount > 0 Then
        While Not oRecordSet.EOF
        
            ShowProgress 2, (oRecordSet.AbsolutePosition / oRecordSet.RecordCount) * 100, , , "Processing data... "
            
            If oRecordSet("sex") = 0 Then
                cString2 = " set Name_SM =  Name_SM + 1 "
            Else
                cString2 = " set Name_SF = Name_SF + 1 "
            End If
            
            cSqlStmt = " update tmpEmpLstsum " & cString2 & _
                       " where emp_stat = " & oRecordSet("emp_stat") & IIf(oRecordSet("emp_stat") = 0, "", " and wap = " & oRecordSet("wap"))
'            MsgBox cSqlStmt
            QueryTemp cSqlStmt, objdbRs, True
            
            oRecordSet.MoveNext
        Wend
    Else
        ShowProgress 3
        MsgBox "No report to generate!", vbCritical, "System Advisory"

        ShowProgress 4
        GoTo EndGenEmpSum
    End If
    
    ShowProgress 3

    GenerateReport IIf(nMode = 0, "", "Resigned/Finished") & " Employee Summary Listing Report ", "lst36703.rpt"

    ShowProgress 4

    
EndGenEmpSum:
    Set oRecordSet = Nothing

    Exit Sub
    
ErrGenEmpSum:
    ErrorMsg Err.Number, Err.Description, "Employee Summary Report Listing", Name
    
    Resume EndGenEmpSum
End Sub


' + -->
' |     Procedure Name  :   GenPayRoll(ByVal cPeriodID As String, ByVal cParam As String, nFilter As Integer)
' |     Description     :   Print Utility for Payroll module
' |     Date Created    :   16 mar 2006
' + -->
'       4   Payslip - 3 reports
'               Regular Payslip
'               SA Payslip
'               WAP Payslip
'               WAP SA Payslip
'       5   Acknowledgement (all 3) - 3 reports
'       6   Payroll Sheet (summary/detail) - 8 reports
'               Regular Payroll Sheet
'               Regular Payroll (deduction) Sheet
'               SA Payroll Sheet
'               WAP Payroll Sheet
'               WAP SA Payroll Sheet
Sub CreateTmpPaySlip(ByVal nMode As Integer)
    On Error GoTo ErrCreate
    Dim cSqlStmt As String, _
        cParam As String
    
    If nMode = 0 Then
        cSqlStmt = " CREATE TABLE tmp7297655(   [PERIODNAME] CHAR(100),     [SEQ_NO] INTEGER, " & _
                   " [P_DAY] DOUBLE,            [P_HOLIDAY] DOUBLE,         " & _
                   " [DEPID] CHAR(3),           [DEPTNAME] CHAR(100),       [DEPID2] CHAR(3),           [DEPTNAME2] CHAR(100), " & _
                   " [EMPID] CHAR(6),           [ACTIVE] INTEGER,           [EMP_STAT] INTEGER," & _
                   " [FULLNAME] CHAR(100),      [FNAME] CHAR(50),           [LNAME] CHAR(50),           [MNAME] CHAR(50), " & _
                   " [RATE_AMT] DOUBLE,         [COLA_AMT] DOUBLE,          [SUN_COLA] DOUBLE,          [POS_ALLOW] DOUBLE, " & _
                   " [REG_DAY] DOUBLE,          [REG_PAY] DOUBLE,           [REG_OT_HR] DOUBLE,         [REG_OT_PAY] DOUBLE, " & _
                   " [NDIFF_DAY] DOUBLE,        [NDIFF_PAY] DOUBLE,         [NDIFF_OT_HR] DOUBLE,       [NDIFF_OT_PAY] DOUBLE, " & _
                   " [HOLIDAY] DOUBLE,          [HOL_PAY] DOUBLE, " & _
                   " [SA_REG_OT] DOUBLE,        [SA_REG_PAY] DOUBLE,        [SA_NDIFF_OT] DOUBLE,       [SA_NDIFF_PAY] DOUBLE, " & _
                   " [SUN_HR] DOUBLE,           [SUN_PAY] DOUBLE,           [SUN_OT] DOUBLE,            [SUN_OT_PAY] DOUBLE, " & _
                   " [ADJ_PAY] DOUBLE,          [SA_ADJ_PAY] DOUBLE, " & _
                   " [OTHER_PAY] DOUBLE,        [LEAVE_PAY] DOUBLE, " & _
                   " [DED_AMT] DOUBLE,          [GROSS_PAY] DOUBLE, " & _
                   " [NET_PAY] DOUBLE,          [SA_NET_PAY] DOUBLE, " & _
                   " [SIGNATORY1] char(50),     [POSNAME1] char(50)," & _
                   " [SIGNATORY2] char(50),     [POSNAME2] char(50)," & _
                   " [SIGNATORY3] char(50),     [POSNAME3] char(50)," & _
                   " [SIGNATORY4] char(50),     [POSNAME4] char(50)," & _
                   " [SIGNATORY5] char(50),     [POSNAME5] char(50)," & _
                   " [SIGNATORY6] char(50),     [POSNAME6] char(50)," & _
                   " [SIGNATORY7] char(50),     [POSNAME7] char(50)," & _
                   " [13MO_PAY] DOUBLE,         [CMPID] char(4))"
    ElseIf nMode = 1 Then
        cSqlStmt = " CREATE TABLE tmp7297655d(" & _
                   " [PERIODID] CHAR(5),        [EMPID] CHAR(6)," & _
                   " [DEDID] CHAR(3),           [DEDNAME] CHAR(100)," & _
                   " [AMOUNT] DOUBLE,           [SEQ_NO] INTEGER)"
    Else
        OpenQueryDNS "select dedid from PA3330", objdbRs, False
        If objdbRs.RecordCount > 0 Then
            While Not objdbRs.EOF
                cParam = cParam & "[dedname" & objdbRs("dedid") & "] char(50), [dedamt" & objdbRs("dedid") & "] DOUBLE,"
                objdbRs.MoveNext
            Wend
        End If
        
        cSqlStmt = " CREATE TABLE tmp7297655d2( [PERIODNAME] CHAR(100), [SEQ_NO] INTEGER,  " & _
                   " [P_DAY] DOUBLE,            [P_HOLIDAY] DOUBLE,         " & _
                   " [DEPID] CHAR(3),           [DEPTNAME] CHAR(100),   " & _
                   " [DEPID2] CHAR(3),          [DEPTNAME2] CHAR(100), " & _
                   " [EMPID] CHAR(6),           [ACTIVE] INTEGER,       [EMP_STAT] INTEGER," & _
                   " [FULLNAME] CHAR(100),      [FNAME] CHAR(50),       [LNAME] CHAR(50), " & _
                   cParam & _
                   " [DED_AMT] DOUBLE,          [GROSS_PAY] DOUBLE,     [NET_PAY] DOUBLE)"
    End If
              
    'MsgBox cSqlStmt
    
    oTempConn.Execute cSqlStmt
    While oTempConn.State = adStateExecuting
        DoEvents
    Wend
ErrCreate:
    ' in case table is already existing, let's clear it...
    QueryTemp "DELETE FROM " & IIf(nMode = 0, "tmp7297655", IIf(nMode = 1, "tmp7297655d", "tmp7297655d2")), oTempADO, True
End Sub

Sub GenPayRoll(ByVal cPeriodID As String, ByVal cParam As String, nFilter As Integer)
    Dim cSqlStmt, _
        cPeriodName, _
        cDedParam, _
        cDedValue As String, _
        oRset1 As New ADODB.Recordset, _
        oRSet2 As New ADODB.Recordset, _
        oRset3 As New ADODB.Recordset, _
        nActive, _
        nCtr As Integer, _
        aOtherInfo As Variant, _
        aPosInfo As Variant, _
        aDedName As Variant, aDedAmt As Variant, _
        aMonthName As Variant

    If SSTab1.TabVisible(3) Then
        If Not ChkPersonnel(Text6) Then Exit Sub
        If Not ChkPersonnel(Text5) Then Exit Sub
        If Not ChkPersonnel(Text1) Then Exit Sub
        If Not ChkPersonnel(Text7) Then Exit Sub
        If Not ChkPersonnel(Text3) Then Exit Sub
        If Not ChkPersonnel(Text8) Then Exit Sub
    End If

    ' --> process active employee first here...
    nActive = IIf(Tag = 15, 1, 0)
    
    aPosInfo = Array("", "", "", "", "", "", "")
    
    aMonthName = Array("Enero", "Pebrero", "Marso", "Abril", "Mayo", "Hunyo", "Hulyo", "Agosto", "Setyembre", "Oktubre", "Nobyembre", "Disyembre")
    
    OpenQueryDNS "SELECT * FROM PA2360 ORDER BY USERID", objdbRs, False
    If objdbRs.RecordCount > 0 Then
        objdbRs.Requery adAsyncFetch
        objdbRs.Find "USERID='" & Text6.Text & "'"
        aPosInfo(0) = IIf(Not objdbRs.EOF, objdbRs("POSITION"), "")
    
        objdbRs.Requery adAsyncFetch
        objdbRs.Find "USERID='" & Text5.Text & "'"
        aPosInfo(1) = IIf(Not objdbRs.EOF, objdbRs("POSITION"), "")
    
        objdbRs.Requery adAsyncFetch
        objdbRs.Find "USERID='" & Text1.Text & "'"
        aPosInfo(2) = IIf(Not objdbRs.EOF, objdbRs("POSITION"), "")
    
        objdbRs.Requery adAsyncFetch
        objdbRs.Find "USERID='" & Text7.Text & "'"
        aPosInfo(3) = IIf(Not objdbRs.EOF, objdbRs("POSITION"), "")
    
        objdbRs.Requery adAsyncFetch
        objdbRs.Find "USERID='" & Text3.Text & "'"
        aPosInfo(4) = IIf(Not objdbRs.EOF, objdbRs("POSITION"), "")
    
        objdbRs.Requery adAsyncFetch
        objdbRs.Find "USERID='" & Text8.Text & "'"
        aPosInfo(5) = IIf(Not objdbRs.EOF, objdbRs("POSITION"), "")
    End If

    If Trim(cParam) <> "" Then
        cParam = "a.depid IN " & cParam
    End If
    
    If Check3.Value = vbChecked Then
        CreateTmpPaySlip 2  ' --> payroll sheet deduction
    Else
        CreateTmpPaySlip 0  ' --> header
        If (nFilter = 0) Then CreateTmpPaySlip 1 ' --> detail
    End If
    
loopd2:

    aOtherInfo = Array("", "", "", "")

    If Check3.Value = vbChecked Then
        OpenQueryDNS "select dedid, dedname from PA3330", objdbRs, False
        If objdbRs.RecordCount > 0 Then
            cDedParam = ""
            ReDim aDedName(objdbRs.RecordCount + 1)
            ReDim aDedAmt(objdbRs.RecordCount + 1)
            While Not objdbRs.EOF
                cDedParam = cDedParam & "dedname" & objdbRs("dedid") & "," & "dedamt" & objdbRs("dedid") & ","
                aDedName(Val(objdbRs("dedid"))) = (objdbRs("dedname"))
                objdbRs.MoveNext
            Wend
        End If
    End If

    OpenQueryDNS "select * from pa7730 where periodid=" & cQuote & cPeriodID & cQuote, objdbRs, False
    If objdbRs.RecordCount > 0 Then
        If Check5.Value = vbChecked Then
            If Combo1.ListIndex <> 2 Then
                cPeriodName = "Para sa sahod mula " & aMonthName(Month(objdbRs("date_start")) - 1) & Format(objdbRs("date_start"), " d, yyyy") & " hanggang " & aMonthName(Month(objdbRs("date_end")) - 1) & Format(objdbRs("date_end"), " d, yyyy")
            Else
                cPeriodName = "Sahod mula " & aMonthName(Month(objdbRs("date_start")) - 1) & " " & Day(objdbRs("date_start")) & "-" & Day(objdbRs("date_end")) & ", " & Year(objdbRs("date_end"))
            End If
        Else
            cPeriodName = "For the " & IIf(Tag = 5, "Payroll", "") & " period " & Format(objdbRs("date_start"), "mmm d, yyyy") & " to " & Format(objdbRs("date_end"), "mmm d, yyyy")
        End If
    End If
    
    If (Check4.Value = vbChecked) Then
        cSqlStmt = "select a.periodid, a.p_day, a.p_holiday, a.seq_no, a.empid, a.firstname, a.lastname, a.mname, a.emp_stat, " & _
                   " a.fullname, a.depid, a.rate_amt, a.cola_amt, a.cola, a.sun_cola, a.pos_allow, a.reg_day, a.reg_pay, " & _
                   " a.reg_ot_hr, a.reg_ot_pay,a.ndiff_day, a.ndiff_pay, a.ndiff_ot_hr, a.ndiff_ot_pay, a.holiday, a.hol_pay, " & _
                   " a.sa_reg_ot, a.sa_reg_pay, a.sa_ndiff_ot, a.sa_ndiff_pay, a.sun_hr, a.sun_pay, a.sun_ot, a.sun_ot_pay, " & _
                   " a.adj_pay, a.sa_adj_pay, a.other_pay, a.leave_pay, a.m13pay, a.ded_amt, a.gross_pay, a.net_pay, a.sa_net_pay, a.active" & _
                   " from pa87260 a"
    Else
        cSqlStmt = "select a.periodid, a.p_day, a.p_holiday, a.depid, count(a.empid) as manpower,sum(truncate(a.cola_amt*(a.reg_day+a.ndiff_day),2)) as cola_amt, " & _
                   " sum(a.cola) as cola, sum(a.pos_allow) as pos_allow, sum(a.sun_cola) as sun_cola, " & _
                   " sum(a.reg_day) as reg_day, sum(a.reg_pay) as reg_pay, sum(a.reg_ot_hr) as reg_ot_hr, sum(a.reg_ot_pay) as reg_ot_pay," & _
                   " sum(a.ndiff_day) as ndiff_day, sum(a.ndiff_pay) as ndiff_pay, sum(a.ndiff_ot_hr) as ndiff_ot_hr, sum(a.ndiff_ot_pay) as ndiff_ot_pay, " & _
                   " sum(a.holiday) as holiday, sum(a.hol_pay) as hol_pay, sum(a.sa_reg_ot) as sa_reg_ot, sum(a.sa_reg_pay) as sa_reg_pay, " & _
                   " sum(a.sa_ndiff_ot) as sa_ndiff_ot, sum(a.sa_ndiff_pay) as sa_ndiff_pay, sum(a.sun_hr) as sun_hr, sum(a.sun_pay) as sun_pay, " & _
                   " sum(a.sun_ot) as sun_ot, sum(a.sun_ot_pay) as sun_ot_pay, sum(a.adj_pay) as adj_pay, sum(a.sa_adj_pay) as sa_adj_pay, " & _
                   " sum(a.other_pay) as other_pay, sum(a.leave_pay) as leave_pay, sum(a.m13pay) as m13pay, sum(a.ded_amt) as ded_amt, " & _
                   " sum(a.gross_pay) as gross_pay, sum(a.net_pay) as net_pay, sum(a.sa_net_pay) as sa_net_pay" & _
                   " from pa87260 a"
    End If
    
    cSqlStmt = cSqlStmt & " where (a.active" & IIf(nActive = 0, "=0", "<>0") & ")" & IIf(Trim(cParam) = "", "", " and (" & cParam & ")") & _
               " and " & IIf(nFilter = 0, "(a.emp_stat <> 0)", IIf(nFilter = 1, "(a.sa_net_pay<>0) and (a.emp_stat<>0)", IIf(nFilter = 2, "(a.emp_stat=0)", "(a.sa_net_pay<>0) and (a.emp_stat=0)"))) & _
               " and (a.periodid=" & cQuote & cPeriodID & cQuote & ")" & IIf((Check4.Value <> vbChecked), " group by a.depid", "")
'    MsgBox cSqlStmt
'    Script2File cSqlStmt
    OpenQueryDNS cSqlStmt, oTempADO, False
    If oTempADO.RecordCount > 0 Then
        
'        OpenQueryDNS "select posid, posname from DI7670 order by posid", oRSet1, False
        OpenQueryDNS "select lineid, linename from di5463 order by lineid", oRset1, False
        
        ShowProgress 0
        
        While Not oTempADO.EOF
        
            ShowProgress 2, (oTempADO.AbsolutePosition / oTempADO.RecordCount) * 100
            
'            If oRSet1.RecordCount > 0 Then
'                oRSet1.Requery adAsyncFetch
'                oRSet1.Find "posid='" & oTempADO("posid") & "'"
'                aOtherInfo(0) = IIf(oRSet1.EOF, "", oRSet1("posname"))
'            End If
            
            If oRset1.RecordCount > 0 Then
                oRset1.Requery adAsyncFetch
                oRset1.Find "lineid='" & oTempADO("depid") & "'"
                aOtherInfo(1) = IIf(oRset1.EOF, "", oRset1("linename"))
            End If
            
            If Check3.Value = vbChecked Then
                ' --> Payroll Sheet (deduction)
                cDedValue = ""
                If Check4.Value = vbChecked Then
                    cSqlStmt = "select a.periodid, a.empid, a.dedid, a.ded_amt," & _
                               " ifnull(b.dedname,'') as dedname" & _
                               " from pa87263 a left join pa3330 b on a.dedid=b.dedid" & _
                               " where (a.periodid=" & cQuote & cPeriodID & cQuote & ")" & _
                               " and (a.empid=" & cQuote & oTempADO("empid") & cQuote & ")"
                Else
                    cSqlStmt = "select a.periodid, c.depid, a.dedid, sum(a.ded_amt) as ded_amt," & _
                               "  ifnull(b.dedname,'') as dedname " & _
                               "from pa87263 a left join pa87260 c on a.empid=c.empid and a.periodid=c.periodid " & _
                               "  left join di3670 d on a.empid=d.empid" & _
                               "  left join pa3330 b on a.dedid=b.dedid" & _
                               " where (a.periodid=" & cQuote & cPeriodID & cQuote & ")" & _
                               " and (c.depid=" & cQuote & oTempADO("depid") & cQuote & ")" & _
                               " and (d.emp_stat<>0)" & _
                               " and (c.active" & IIf(nActive = 0, "=0", "<>0") & ")" & _
                               " group by b.dedid, c.depid"
                End If
                OpenQueryDNS cSqlStmt, oRSet2, False
                If oRSet2.RecordCount > 0 Then
                    While Not oRSet2.EOF
                        aDedAmt(Val(oRSet2("dedid"))) = oRSet2("ded_amt")
                        oRSet2.MoveNext
                    Wend
                    For nCtr = 1 To UBound(aDedAmt) - 1
                        cDedValue = cDedValue & cQuote & DecodeStr(EncodeStr2(aDedName(nCtr))) & cQuote & "," & Val(aDedAmt(nCtr)) & ","
                    Next nCtr
                Else
                    For nCtr = 1 To UBound(aDedAmt) - 1
                        cDedValue = cDedValue & cQuote & DecodeStr(EncodeStr2(aDedName(nCtr))) & cQuote & ",0,"
                    Next nCtr
                End If
                
                If Check4.Value = vbChecked Then
                    cSqlStmt = "insert into tmp7297655d2(periodname, depid, deptname," & IIf(nActive = 1, " depid2, deptname2,", "") & _
                               " seq_no,empid, emp_stat, [active], fullname, fname, lname, " & _
                               cDedParam & "ded_amt, gross_pay, net_pay)values(" & _
                               cQuote & DecodeStr(EncodeStr2(cPeriodName)) & cQuote & "," & _
                               cQuote & IIf(nActive = 1, IIf(Tag = 15, oTempADO("depid"), "999"), oTempADO("depid")) & cQuote & "," & cQuote & IIf(nActive = 1, IIf(Tag = 15, DecodeStr(EncodeStr2(aOtherInfo(1))), "Resigned/FC"), DecodeStr(EncodeStr2(aOtherInfo(1)))) & cQuote & "," & _
                               IIf(nActive = 1, cQuote & oTempADO("depid") & cQuote & "," & cQuote & DecodeStr(EncodeStr2(aOtherInfo(1))) & cQuote & ",", "") & _
                               oTempADO("seq_no") & "," & cQuote & oTempADO("empid") & cQuote & "," & oTempADO("emp_stat") & "," & oTempADO("active") & "," & _
                               cQuote & DecodeStr(EncodeStr2(oTempADO("fullname"))) & cQuote & "," & cQuote & DecodeStr(EncodeStr2(oTempADO("firstname"))) & cQuote & "," & cQuote & DecodeStr(EncodeStr2(oTempADO("lastname"))) & cQuote & "," & _
                               cDedValue & oTempADO("ded_amt") & "," & oTempADO("gross_pay") & "," & oTempADO("net_pay") & ")"
                Else
                    cSqlStmt = "insert into tmp7297655d2(periodname, p_day, p_holiday, depid, deptname," & IIf(nActive = 1, " depid2, deptname2,", "") & _
                               cDedParam & "ded_amt, gross_pay, net_pay)values(" & _
                               cQuote & DecodeStr(EncodeStr2(cPeriodName)) & cQuote & "," & oTempADO("p_day") & "," & oTempADO("p_holiday") & "," & _
                               cQuote & IIf(nActive = 1, IIf(Tag = 15, oTempADO("depid"), "999"), oTempADO("depid")) & cQuote & "," & cQuote & IIf(nActive = 1, IIf(Tag = 15, DecodeStr(EncodeStr2(aOtherInfo(1))), "Resigned/FC"), DecodeStr(EncodeStr2(aOtherInfo(1)))) & cQuote & "," & _
                               IIf(nActive = 1, cQuote & oTempADO("depid") & cQuote & "," & cQuote & DecodeStr(EncodeStr2(aOtherInfo(1))) & cQuote & ",", "") & _
                               cDedValue & oTempADO("ded_amt") & "," & oTempADO("gross_pay") & "," & oTempADO("net_pay") & ")"
                End If
                QueryTemp cSqlStmt, objdbRs, True
                
            Else
            
                If Check4.Value <> vbChecked Then
                    cSqlStmt = "insert into tmp7297655(periodname, p_day, p_holiday, depid, deptname," & IIf(nActive = 1, " depid2, deptname2,", "") & _
                               " rate_amt, cola_amt, sun_cola, pos_allow, reg_day, reg_pay, reg_ot_hr, reg_ot_pay, " & _
                               " ndiff_day, ndiff_pay, ndiff_ot_hr, ndiff_ot_pay, [holiday], hol_pay, sa_reg_ot, sa_reg_pay, " & _
                               " sa_ndiff_ot, sa_ndiff_pay, sun_hr, sun_pay, sun_ot, sun_ot_pay, adj_pay, sa_adj_pay, " & _
                               " other_pay, leave_pay, 13mo_pay, ded_amt, gross_pay, net_pay, sa_net_pay, " & _
                               " signatory1,signatory2,signatory3,signatory4,signatory5,signatory6,signatory7, " & _
                               " posname1,posname2,posname3,posname4,posname5,posname6,posname7)values(" & _
                               cQuote & DecodeStr(EncodeStr2(cPeriodName)) & cQuote & "," & oTempADO("p_day") & "," & oTempADO("p_holiday") & "," & _
                               cQuote & IIf(nActive = 1, IIf(Tag = 15, oTempADO("depid"), "999"), oTempADO("depid")) & cQuote & "," & cQuote & IIf(nActive = 1, IIf(Tag = 15, DecodeStr(EncodeStr2(aOtherInfo(1))), "Resigned/FC"), DecodeStr(EncodeStr2(aOtherInfo(1)))) & cQuote & "," & _
                               IIf(nActive = 1, cQuote & oTempADO("depid") & cQuote & "," & cQuote & DecodeStr(EncodeStr2(aOtherInfo(1))) & cQuote & ",", "") & _
                               oTempADO("manpower") & "," & oTempADO("cola") & "," & oTempADO("sun_cola") & "," & oTempADO("pos_allow") & "," & _
                               oTempADO("reg_day") & "," & oTempADO("reg_pay") & "," & oTempADO("reg_ot_hr") & "," & oTempADO("reg_ot_pay") & "," & _
                               oTempADO("ndiff_day") & "," & oTempADO("ndiff_pay") & "," & oTempADO("ndiff_ot_hr") & "," & oTempADO("ndiff_ot_pay") & "," & _
                               oTempADO("holiday") & "," & oTempADO("hol_pay") & "," & _
                               oTempADO("sa_reg_ot") & "," & oTempADO("sa_reg_pay") & "," & _
                               oTempADO("sa_ndiff_ot") & "," & oTempADO("sa_ndiff_pay") & "," & _
                               oTempADO("sun_hr") & "," & oTempADO("sun_pay") & "," & oTempADO("sun_ot") & "," & oTempADO("sun_ot_pay") & "," & _
                               oTempADO("adj_pay") & "," & oTempADO("sa_adj_pay") & "," & _
                               oTempADO("other_pay") & "," & oTempADO("leave_pay") & "," & oTempADO("M13PAY") & "," & _
                               oTempADO("ded_amt") & "," & oTempADO("gross_pay") & "," & _
                               IIf((Tag = 5) And ((nFilter = 1) Or (nFilter = 3)), oTempADO("sa_net_pay"), oTempADO("net_pay")) & "," & oTempADO("sa_net_pay") & "," & _
                               cQuote & EncodeStr2(Label8.Caption) & cQuote & "," & cQuote & EncodeStr2(Label6.Caption) & cQuote & "," & cQuote & EncodeStr2(Label4.Caption) & cQuote & "," & _
                               cQuote & EncodeStr2(Label15.Caption) & cQuote & "," & cQuote & EncodeStr2(Label14.Caption) & cQuote & "," & cQuote & EncodeStr2(Label16.Caption) & cQuote & "," & cQuote & cQuote & "," & _
                               cQuote & aPosInfo(0) & cQuote & "," & cQuote & aPosInfo(1) & cQuote & "," & cQuote & aPosInfo(2) & cQuote & "," & cQuote & aPosInfo(3) & cQuote & "," & cQuote & aPosInfo(4) & cQuote & "," & cQuote & aPosInfo(5) & cQuote & "," & cQuote & aPosInfo(6) & cQuote & ")"
                Else
                    cSqlStmt = "insert into tmp7297655(periodname, p_day, p_holiday, seq_no, depid, deptname," & IIf(nActive = 1, " depid2, deptname2,", "") & " empid, emp_stat, [active], fullname, fname, mname, lname, " & _
                               " rate_amt, cola_amt, sun_cola, pos_allow, reg_day, reg_pay, reg_ot_hr, reg_ot_pay, " & _
                               " ndiff_day, ndiff_pay, ndiff_ot_hr, ndiff_ot_pay, [holiday], hol_pay, sa_reg_ot, sa_reg_pay, " & _
                               " sa_ndiff_ot, sa_ndiff_pay, sun_hr, sun_pay, sun_ot, sun_ot_pay, adj_pay, sa_adj_pay, " & _
                               " other_pay, leave_pay, 13mo_pay, ded_amt, gross_pay, net_pay, sa_net_pay)values(" & _
                               cQuote & DecodeStr(EncodeStr2(cPeriodName)) & cQuote & "," & oTempADO("p_day") & "," & oTempADO("p_holiday") & "," & oTempADO("seq_no") & "," & _
                               cQuote & IIf(nActive = 1, IIf(Tag = 15, oTempADO("depid"), "999"), oTempADO("depid")) & cQuote & "," & cQuote & IIf(nActive = 1, IIf(Tag = 15, DecodeStr(EncodeStr2(aOtherInfo(1))), "Resigned/FC"), DecodeStr(EncodeStr2(aOtherInfo(1)))) & cQuote & "," & _
                               IIf(nActive = 1, cQuote & oTempADO("depid") & cQuote & "," & cQuote & DecodeStr(EncodeStr2(aOtherInfo(1))) & cQuote & ",", "") & _
                               cQuote & oTempADO("empid") & cQuote & "," & oTempADO("emp_stat") & "," & oTempADO("active") & "," & _
                               cQuote & DecodeStr(EncodeStr2(oTempADO("fullname"))) & cQuote & "," & cQuote & DecodeStr(EncodeStr2(oTempADO("firstname"))) & cQuote & "," & cQuote & DecodeStr(EncodeStr2(oTempADO("mname"))) & cQuote & "," & cQuote & DecodeStr(EncodeStr2(oTempADO("lastname"))) & cQuote & "," & _
                               oTempADO("rate_amt") & "," & oTempADO("cola") & "," & oTempADO("sun_cola") & "," & oTempADO("pos_allow") & "," & _
                               oTempADO("reg_day") & "," & oTempADO("reg_pay") & "," & _
                               oTempADO("reg_ot_hr") & "," & oTempADO("reg_ot_pay") & "," & _
                               oTempADO("ndiff_day") & "," & oTempADO("ndiff_pay") & "," & _
                               oTempADO("ndiff_ot_hr") & "," & oTempADO("ndiff_ot_pay") & "," & _
                               oTempADO("holiday") & "," & oTempADO("hol_pay") & "," & _
                               oTempADO("sa_reg_ot") & "," & oTempADO("sa_reg_pay") & "," & _
                               oTempADO("sa_ndiff_ot") & "," & oTempADO("sa_ndiff_pay") & "," & _
                               oTempADO("sun_hr") & "," & oTempADO("sun_pay") & "," & _
                               oTempADO("sun_ot") & "," & oTempADO("sun_ot_pay") & "," & _
                               oTempADO("adj_pay") & "," & oTempADO("sa_adj_pay") & "," & _
                               oTempADO("other_pay") & "," & oTempADO("leave_pay") & "," & oTempADO("M13PAY") & "," & _
                               oTempADO("ded_amt") & "," & oTempADO("gross_pay") & "," & _
                               IIf((Tag = 5) And ((nFilter = 1) Or (nFilter = 3)), oTempADO("sa_net_pay"), oTempADO("net_pay")) & "," & oTempADO("sa_net_pay") & ")"
                End If
                QueryTemp cSqlStmt, objdbRs, True
                
                If (nFilter = 0) And (Tag <> 20) Then
                    If Check4.Value = vbChecked Then
                        cSqlStmt = "select a.periodid, a.empid, a.dedid, a.ded_amt," & _
                                   " ifnull(b.dedname,'') as dedname," & _
                                   " ifnull(b.dedname2,'') as dedname2" & _
                                   " from pa87263 a left join pa3330 b on a.dedid=b.dedid" & _
                                   " where (a.periodid=" & cQuote & cPeriodID & cQuote & ")" & _
                                   " and (a.empid=" & cQuote & oTempADO("empid") & cQuote & ")"
                        OpenQueryDNS cSqlStmt, oRSet2, False
                        If oRSet2.RecordCount > 0 Then
                            While Not oRSet2.EOF
                                cSqlStmt = "insert into tmp7297655d(periodid, empid, dedid, dedname, amount)values(" & _
                                           cQuote & cPeriodID & cQuote & "," & _
                                           cQuote & oTempADO("empid") & cQuote & "," & _
                                           cQuote & oRSet2("dedid") & cQuote & "," & _
                                           cQuote & DecodeStr(EncodeStr2(oRSet2(IIf(Check5.Value = vbChecked, "dedname2", "dedname")))) & cQuote & "," & _
                                           oRSet2("ded_amt") & ")"
                                QueryTemp cSqlStmt, objdbRs, True
                                oRSet2.MoveNext
                            Wend
                        End If
                    End If
                End If
            End If
            
            oTempADO.MoveNext
        Wend
        
        ShowProgress 4
    End If
    
    
    ' --> process resigned/fc employee next...
    If nActive = 0 Then
        nActive = 1
        GoTo loopd2
    End If
    
    
    ShowProgress 0
    
    QueryTemp "select * from " & IIf(Check3.Value <> vbChecked, "tmp7297655", "tmp7297655d2"), objdbRs, False
    If objdbRs.RecordCount > 0 Then
    
        ShowProgress 3
        
        Select Case Tag
            Case 4, 19      ' --> Payslip/13th month
                Select Case nFilter
                    Case 0
                        GenerateReport IIf(Check5.Value <> vbChecked, "PAYSLIP", "TALAAN NG KINITA"), IIf(Check5.Value = vbChecked, "rpt7297547T.rpt", "rpt7297547.rpt")
                    Case 1, 3
                        GenerateReport IIf(nFilter = 1, "SA", "WAP SA") & " PAYROLL", IIf(Check5.Value = vbChecked, "rpt727547T.rpt", "rpt727547.rpt")
                    Case 2
                        GenerateReport IIf(Check5.Value <> vbChecked, "WAP Payslip", "TALAAN NG KINITA PARA SA WAP"), IIf(Check5.Value = vbChecked, "rpt9277547t.rpt", "rpt9277547.rpt")
                End Select
                
            Case 5, 22      ' --> Acknowledgement
                GenerateReport IIf(nFilter = 1, "SA ", IIf(nFilter = 2, "WAP ", IIf(nFilter = 3, "WAP SA ", IIf(Tag = 22, "13th Month Pay 2006 ", "")))) & "Acknowledgement Report", "rpt734748.rpt"
                
            Case 6, 15     ' --> Payroll Sheet (summary/detail)
                If Check3.Value <> vbChecked Then
                    Select Case nFilter
                        Case 0      ' --> reg payroll sheet
                            GenerateReport "PAYROLL", IIf(Check4.Value = vbChecked, "rpt729748d.rpt", "rpt729748s.rpt")
                        Case 1, 3   ' --> sa payroll sheet
                            GenerateReport IIf(nFilter = 1, "SA", "WAP SA") & " PAYROLL", IIf(Check4.Value = vbChecked, "rpt72748d.rpt", "rpt72748s.rpt")
                        Case 2      ' --> wap payroll sheet
                            GenerateReport "WAP PAYROLL", IIf(Check4.Value = vbChecked, "rpt927748d.rpt", "rpt927748s.rpt")
                    End Select
                Else
                    ' --> Payroll Deduction sheet
                    GenerateReport cPeriodName, IIf(Check4.Value = vbChecked, "rpt729748ded.rpt", "rpt729748sd.rpt")
                End If
            
            Case 20     ' --> 13th month payroll sheet
                GenerateReport "13th Month Pay 2006 Payroll Sheet", IIf(Check4.Value = vbChecked, "rpt13667.rpt", "rpt13667s.rpt")
                
        End Select
        
    Else
        ShowProgress 3

        MsgBox "No report to generate!", vbCritical, "System Advisory"
    End If
    
    ShowProgress 4
    
    Set oRset1 = Nothing
    Set oRSet2 = Nothing
    Set oRset3 = Nothing
End Sub



' + -->
' |     Procedure Name  :   GenDenom(ByVal cPeriodID As String)
' |     Description     :   Generate Denomination Report
' |     Date Created    :   20 mar 2006
' + -->
Sub CreateTmpDenom()
    On Error GoTo ErrCreate
    Dim cSqlStmt As String
    
    cSqlStmt = " CREATE TABLE TmpDenom(     [PERIODNAME] CHAR(100), " & _
               " [DEPID] CHAR(3),           [DEPTNAME] CHAR(100), " & _
               " [EMPID] CHAR(6),           [ACTIVE] INTEGER,       [EMP_STAT] INTEGER," & _
               " [FULLNAME] CHAR(100),      [FNAME] CHAR(100),      [LNAME] CHAR(100), " & _
               " [FROM_NAME] CHAR(100),     [ATTN_NAME] CHAR(100), " & _
               " [P1000] DOUBLE,            [P500] DOUBLE,          [P100] DOUBLE, " & _
               " [P50] DOUBLE,              [P20] DOUBLE, " & _
               " [P10] DOUBLE,              [P5] DOUBLE, " & _
               " [P1] DOUBLE,               [PCOIN] DOUBLE, " & _
               " [NET_PAY] DOUBLE,          [SA_NET_PAY] DOUBLE, " & _
               " [CMPID] char(4))"
              
    oTempConn.Execute cSqlStmt
    While oTempConn.State = adStateExecuting
        DoEvents
    Wend
ErrCreate:
    ' in case table is already existing, let's clear it...
    QueryTemp "DELETE FROM TmpDenom", oTempADO, True
End Sub

Function GetDenom(nAmount As Double) As Variant
    Dim nRemainder As Double, _
        nCtr As Integer, aOtherInfo As Variant, _
        cString As String
        
    aOtherInfo = Array(0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#)
    ' (0)   -   1000
    ' (1)   -   500
    ' (2)   -   100
    ' (3)   -   50
    ' (4)   -   20
    ' (5)   -   10
    ' (6)   -   5
    ' (7)   -   1
    ' (8)   -   cent
    
    aOtherInfo(0) = Int(nAmount) \ 1000
    nRemainder = nAmount - (aOtherInfo(0) * 1000)
    
    If nRemainder > 0 Then
        aOtherInfo(1) = Int(nRemainder) \ 500
        nRemainder = Val(nRemainder) - (aOtherInfo(1) * 500)
    End If
    
    If nRemainder > 0 Then
        aOtherInfo(2) = Int(nRemainder) \ 100
        nRemainder = Val(nRemainder) - (aOtherInfo(2) * 100)
    End If
    
    If nRemainder > 0 Then
        aOtherInfo(3) = Int(nRemainder) \ 50
        nRemainder = Val(nRemainder) - (aOtherInfo(3) * 50)
    End If

    If nRemainder > 0 Then
        aOtherInfo(4) = Int(nRemainder) \ 20
        nRemainder = Val(nRemainder) - (aOtherInfo(4) * 20)
    End If

    If nRemainder > 0 Then
        aOtherInfo(5) = Int(nRemainder) \ 10
        nRemainder = Val(nRemainder) - (aOtherInfo(5) * 10)
    End If

    If nRemainder > 0 Then
        aOtherInfo(6) = Int(nRemainder) \ 5
        nRemainder = Val(nRemainder) - (aOtherInfo(6) * 5)
    End If

    If nRemainder > 0 Then
        aOtherInfo(7) = Int(nRemainder) \ 1
        nRemainder = Val(nRemainder) - (aOtherInfo(7) * 1)
    End If
    
    aOtherInfo(8) = nRemainder
    
    GetDenom = aOtherInfo
End Function

Sub GenDenom(ByVal cPeriodID As String)
    Dim cSqlStmt As String, cPeriodName As String, _
        aDenomInfo As Variant, aDenomInfo2 As Variant
        
    If Not ChkPersonnel(Text6) Then Exit Sub
    If Not ChkPersonnel(Text5) Then Exit Sub
    
    CreateTmpDenom
    
    aDenomInfo = Array(0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#)
    aDenomInfo2 = Array(0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#)
    
    cSqlStmt = "select a.periodid, a.empid, a.fullname, a.firstname, a.mname, a.lastname, " & _
               "  a.depid, ifnull(b.linename,'') as department, " & _
               "  a.net_pay , a.sa_net_pay, a.active, a.emp_stat " & _
               "from pa87260 a left join di5463 b on a.depid=b.lineid " & _
               "where a.periodid=" & cQuote & cPeriodID & cQuote
    OpenQueryDNS cSqlStmt, oTempADO, False
    If oTempADO.RecordCount > 0 Then
        
        ShowProgress 0
        
        OpenQueryDNS "select * from pa7730 where periodid=" & cQuote & cPeriodID & cQuote, objdbRs, False
        If objdbRs.RecordCount > 0 Then
            cPeriodName = "For the Payroll period " & Format(objdbRs("date_start"), "mmm d, yyyy") & " to " & Format(objdbRs("date_end"), "mmm d, yyyy")
        End If
        
        While Not oTempADO.EOF
            ShowProgress 2, (oTempADO.AbsolutePosition / oTempADO.RecordCount) * 100
            
            aDenomInfo = GetDenom(oTempADO("net_pay"))
            aDenomInfo2 = GetDenom(oTempADO("sa_net_pay"))
            
            cSqlStmt = "insert into TmpDenom(periodname, depid, deptname, empid, active, emp_stat," & _
                       " fullname, fname, lname, net_pay, sa_net_pay," & _
                       " p1000,p500,p100,p50,p20,p10,p5,p1,pcoin, from_name, attn_name)values(" & _
                       cQuote & EncodeStr2(DecodeStr(cPeriodName)) & cQuote & "," & _
                       cQuote & oTempADO("depid") & cQuote & "," & _
                       cQuote & EncodeStr2(DecodeStr(oTempADO("department"))) & cQuote & "," & _
                       cQuote & oTempADO("empid") & cQuote & "," & oTempADO("active") & "," & oTempADO("emp_stat") & "," & _
                       cQuote & EncodeStr2(DecodeStr(oTempADO("fullname"))) & cQuote & "," & _
                       cQuote & EncodeStr2(DecodeStr(oTempADO("firstname"))) & cQuote & "," & _
                       cQuote & EncodeStr2(DecodeStr(oTempADO("lastname"))) & cQuote & "," & _
                       oTempADO("net_pay") & "," & oTempADO("sa_net_pay") & "," & _
                       aDenomInfo(0) + aDenomInfo2(0) & "," & _
                       aDenomInfo(1) + aDenomInfo2(1) & "," & _
                       aDenomInfo(2) + aDenomInfo2(2) & "," & _
                       aDenomInfo(3) + aDenomInfo2(3) & "," & _
                       aDenomInfo(4) + aDenomInfo2(4) & "," & _
                       aDenomInfo(5) + aDenomInfo2(5) & "," & _
                       aDenomInfo(6) + aDenomInfo2(6) & "," & _
                       aDenomInfo(7) + aDenomInfo2(7) & "," & _
                       aDenomInfo(8) + aDenomInfo2(8) & "," & _
                       cQuote & EncodeStr2(DecodeStr(Label8.Caption)) & cQuote & "," & _
                       cQuote & EncodeStr2(DecodeStr(Label6.Caption)) & cQuote & ")"
            QueryTemp cSqlStmt, objdbRs, True
            
            oTempADO.MoveNext
            
        Wend
        
        ShowProgress 3
        
        GenerateReport "Denomination Report", IIf(Check4.Value = vbChecked, "rpt33666.rpt", "rpt33666s.rpt")
        
        ShowProgress 4
    End If
End Sub



' + -->
' |     Procedure Name  :   ClosePeriod(ByVal cPeriodID As String)
' |     Description     :   Utility to Close a certain Period
' |     Date Created    :   4 apr 2006
' + -->
Function GenField(aTableDef As Variant) As String
    Dim aFieldStru As Variant, _
        nCtr As Integer, _
        cParam As String
        
    DoEvents
    For nCtr = 0 To UBound(aTableDef)
        aFieldStru = aTableDef(nCtr)
        cParam = cParam & "`" & aFieldStru(0) & "`" & IIf(nCtr <> UBound(aTableDef), ",", "")
    Next nCtr
    GenField = cParam
End Function

Sub ClosePeriod(ByVal cPeriodID As String)
    Dim cSqlStmt As String, _
        lProceed As Boolean, _
        oRecordSet As New ADODB.Recordset, _
        aPeriodInfo As Variant
        
    aPeriodInfo = Array("", "", 0, 0, 0)
'    aPeriodInfo(0)      Date Start
'    aPeriodInfo(1)      Date End
'    aPeriodInfo(2)      status
'    aPeriodInfo(3)      Annual Tax
'    aPeriodInfo(4)      13 month period
    
    cSqlStmt = "Warning!!!" & vbCrLf & vbCrLf & _
               "By clicking the [YES] button, you are agreeing" & vbCrLf & _
               "to the condition that all the transactions for the" & vbCrLf & _
               "selected period will be deemed final and executory." & vbCrLf & _
               "All related transactions for this period will be closed" & vbCrLf & _
               "altogether to avoid any further altercations in the near" & vbCrLf & _
               "future for reference and archival purposes." & vbCrLf & vbCrLf & _
               "Click the [YES] button to proceed now."
               
    If MsgBox(cSqlStmt, vbYesNo + vbCritical, "System Advisory") = vbNo Then Exit Sub
    
    If gUserLevel <> 1 Then
        frmManager.Show 1
        If ModalResult = mrCancel Then Exit Sub
        lProceed = ModalResult = mrOk
    Else
        lProceed = gUserLevel = 1
    End If
    
    
    If lProceed Then
        OpenQueryDNS "select date_start, date_end,`status`, wtax, 13month  from pa7730 where periodid=" & cQuote & cPeriodID & cQuote, objdbRs, False
        aPeriodInfo(0) = Format(IIf(objdbRs.RecordCount > 0, objdbRs("date_start"), Now), "yyyy-mm-dd")
        aPeriodInfo(1) = Format(IIf(objdbRs.RecordCount > 0, objdbRs("date_end"), Now), "yyyy-mm-dd")
        aPeriodInfo(2) = IIf(objdbRs.RecordCount > 0, objdbRs("status"), 0)
        aPeriodInfo(3) = IIf(objdbRs.RecordCount > 0, objdbRs("wtax"), 0)
        aPeriodInfo(4) = IIf(objdbRs.RecordCount > 0, objdbRs("13month"), 0)
        
        If aPeriodInfo(2) > 0 Then
            
            ShowProgress 0, , 1
            
            ShowProgress 2, 11, , , "Updating Employee record..."
            
            ' --> 20070116 - d2 me ngtapos...
            If aPeriodInfo(3) = 1 Then
                ' --> reset usage of union leave
                OpenQueryDNS "update PA73887 set ul_use=0", objdbRs, True
                Script2File cSqlStmt
            
                cSqlStmt = "update pa87260 a, di3670 b set b.ssprem1215=0, " & _
                           "                               b.sser1215=0, " & _
                           "                               b.ps1215=0," & _
                           "                               b.es1215=0," & _
                           "                               b.mtd_gross=0," & _
                           "                               b.mtd_basic=0," & _
                           "                               b.mtd_taxable=0," & _
                           "                               b.ytd_cola=0," & _
                           "                               b.ytd_gross=0," & _
                           "                               b.ytd_basic=0," & _
                           "                               b.ytd_wtax=0," & _
                           "                               b.ytd_gross_sa=0" & _
                           " where (a.empid=b.empid) and (a.periodid=" & cQuote & cPeriodID & cQuote & ")"
            Else
                ' --> update employee's MTD/YTD info...
                Select Case aPeriodInfo(2)
                    Case 1  ' --> 1st Period (1-15)
                        cSqlStmt = "update pa87260 a, di3670 b set b.ssprem1215=a.ssprem, " & _
                                   "                               b.sser1215=a.sser, " & _
                                   "                               b.ps1215=a.medicare," & _
                                   "                               b.es1215=a.medicare," & _
                                   "                               b.mtd_gross=a.gross_pay," & _
                                   "                               b.mtd_basic=a.reg_pay+a.ndiff_pay," & _
                                   "                               b.mtd_taxable=a.taxable," & _
                                   "                               b.ytd_cola=b.ytd_cola+a.cola," & _
                                   "                               b.ytd_gross=b.ytd_gross+a.gross_pay-a.m13pay," & _
                                   "                               b.ytd_basic=b.ytd_basic+(a.reg_pay+a.ndiff_pay)," & _
                                   "                               b.ytd_wtax=b.ytd_wtax+a.wtax," & _
                                   "                               b.ytd_gross_sa=b.ytd_gross_sa+a.sa_net_pay" & _
                                   " where (a.empid=b.empid) and (a.periodid=" & cQuote & cPeriodID & cQuote & ")"
                    Case 2  ' --> 2nd Period (16-end of month)
                        cSqlStmt = "update pa87260 a, di3670 b set b.ssprem1215=0, " & _
                                   "                               b.sser1215=0, " & _
                                   "                               b.ps1215=0," & _
                                   "                               b.es1215=0," & _
                                   "                               b.mtd_gross=0," & _
                                   "                               b.mtd_basic=0," & _
                                   "                               b.mtd_taxable=0," & _
                                   "                               b.ytd_cola=b.ytd_cola+a.cola," & _
                                   "                               b.ytd_gross=b.ytd_gross+a.gross_pay-a.m13pay," & _
                                   "                               b.ytd_basic=b.ytd_basic+(a.reg_pay+a.ndiff_pay)," & _
                                   "                               b.ytd_wtax=b.ytd_wtax+a.wtax," & _
                                   "                               b.ytd_gross_sa=b.ytd_gross_sa+a.sa_net_pay" & _
                                   " where (a.empid=b.empid) and (a.periodid=" & cQuote & cPeriodID & cQuote & ")"
                End Select
            End If
            OpenQueryDNS cSqlStmt, objdbRs, True
        
        
            ' --> move daily attendance
            ShowProgress 2, 22, , , "Moving Daily Time Record to archive..."
            cSqlStmt = "insert into pah84650(" & GenField(chkPA84650) & ")" & _
                       "select " & GenField(chkPA84650) & _
                       " from PA84650 where logdate between " & cQuote & aPeriodInfo(0) & cQuote & _
                       " and " & cQuote & aPeriodInfo(1) & cQuote
            OpenQueryDNS cSqlStmt, objdbRs, True
            Script2File cSqlStmt
            
            ShowProgress 2, 33, , , "Deleting DTR entry..."
            cSqlStmt = "delete from pa84650 where logdate between " & cQuote & aPeriodInfo(0) & cQuote & _
                       " and " & cQuote & aPeriodInfo(1) & cQuote
            OpenQueryDNS cSqlStmt, objdbRs, True
            Script2File cSqlStmt
            
            
            ' --> move shifting schedule - 20070113
            cSqlStmt = "insert into dih36770(" & GenField(chkDI36770) & ")" & _
                       "select " & GenField(chkDI36770) & _
                       " from di36770 where `date` between " & cQuote & aPeriodInfo(0) & cQuote & _
                       " and " & cQuote & aPeriodInfo(1) & cQuote
            OpenQueryDNS cSqlStmt, objdbRs, True
            Script2File cSqlStmt
            
            cSqlStmt = "delete from di36770 where `date` between " & cQuote & aPeriodInfo(0) & cQuote & _
                       " and " & cQuote & aPeriodInfo(1) & cQuote
            OpenQueryDNS cSqlStmt, objdbRs, True
            Script2File cSqlStmt
            
            
            ' --> move payroll header transaction to history
            ShowProgress 2, 44, , , "Moving Payroll transaction to archive..."
            cSqlStmt = "insert into pah87260(" & GenField(chkPA87260) & ")" & _
                       "select " & GenField(chkPA87260) & _
                       " from pa87260 where periodid=" & cQuote & cPeriodID & cQuote
            OpenQueryDNS cSqlStmt, objdbRs, True
            Script2File cSqlStmt
            
            ShowProgress 2, 55, , , "Deleting Payroll transaction..."
            cSqlStmt = "delete from pa87260 where periodid=" & cQuote & cPeriodID & cQuote
            OpenQueryDNS cSqlStmt, objdbRs, True
            Script2File cSqlStmt
            
            
            ' --> update custom deduction here
            ShowProgress 2, 66, , , "Updating Custom Deduction..."
            cSqlStmt = "update di3673 a, pa87263 b set a.acc_amt = a.acc_amt + b.ded_amt " & _
                       "where (a.empid=b.empid and a.dedid=b.dedid and a.ctrl_no=b.ctrl_no) " & _
                       " and (b.periodid=" & cQuote & cPeriodID & cQuote & ")"
            OpenQueryDNS cSqlStmt, objdbRs, True
            Script2File cSqlStmt
            
            
            ' --> close finished deduction here
            ShowProgress 2, 71, , , "Closing finished deduction..."
            cSqlStmt = "update di3673 set status=1, date_fin=" & cQuote & Format(Now, "yyyy-mm-dd") & cQuote & _
                       " where cut_off_amt <= acc_amt and status=0"
            OpenQueryDNS cSqlStmt, objdbRs, True
            Script2File cSqlStmt
            
            
            ' --> move deduction to history
            ShowProgress 2, 77, , , "Moving Deduction transaction to archive..."
            cSqlStmt = "insert into pah87263(" & GenField(chkPA87263) & ")" & _
                       "select " & GenField(chkPA87263) & _
                       " from pa87263 where periodid=" & cQuote & cPeriodID & cQuote
            OpenQueryDNS cSqlStmt, objdbRs, True
            Script2File cSqlStmt
            
            ShowProgress 2, 88, , , "Deleting deduction transaction..."
            cSqlStmt = "delete from pa87263 where periodid=" & cQuote & cPeriodID & cQuote
            OpenQueryDNS cSqlStmt, objdbRs, True
            Script2File cSqlStmt
            
            
            ' --> close period
            ShowProgress 2, 95, , , "Closing Period..."
            cSqlStmt = "update pa7730 set pclose=1, date_close=" & cQuote & Format(Now, "yyyy-mm-dd") & cQuote & _
                       " where periodid=" & cQuote & cPeriodID & cQuote
            OpenQueryDNS cSqlStmt, objdbRs, True
            Script2File cSqlStmt
            
            
            ShowProgress 4
            
            SetSelection Tag
        End If
    End If
    
    Set oRecordSet = Nothing
End Sub


' + -->
' |     Procedure Name  :   MFCon(ByVal cParam As String, cParam2 As String)
' |     Description     :   Generate Monthly Finish Contract Report
' |     Date Created    :   5 apr 2006
' + -->
Sub CreateMFCon()
        On Error GoTo ErrCreate
    Dim cSqlStmt As String
    cSqlStmt = " CREATE TABLE tmpMFCon( " & _
               " [DATE_HIRE] date,       [DATE_FIN] date, " & _
               " [EMPID] char(6),        [fullname] char(100), " & _
               " [SEX] CHAR(100),        [EMP_STATName] char(100), " & _
               " [LineName] char(100),   [POSNAME] char(100), " & _
               " [CMPName] char(100),    [Remark] char (100), " & _
               " [tcid] char (4),         [emp_stat] integer, " & _
               " [wap] integer) "
               
    oTempConn.Execute cSqlStmt
    While oTempConn.State = adStateExecuting
        DoEvents
    Wend
ErrCreate:
    ' in case table is already existing, let's clear it...
    cSqlStmt = "DELETE FROM tmpMFCon"
    QueryTemp cSqlStmt, oTempADO, True

End Sub

Sub MFCon(ByVal cParam As String, cParam2 As String, nMode As Integer)
    Dim oRecordSet As New ADODB.Recordset, _
        cSqlStmt As String, _
        aOtherInfo As Variant, _
        aPeriodInfo As Variant
        
    aPeriodInfo = Array("", "", "")
    aOtherInfo = Array("", "", "", "", "", "")
    
    CreateMFCon
    
    If nMode = 0 Then
        cSqlStmt = " SELECT empid,concat(lastname,', ', firstname, ' ', left(mname,1), if(trim(mname)='','','.') ) as fullname, depid,posid,date_fin,date_hire,cmpid,emp_stat,sex,active,tcid,wap  FROM di3670 " & _
                   " where " & cParam & cParam2 & " And active = 0"
    Else
        ' --> retrieve period info here...
        OpenQueryDNS "SELECT * FROM PA7730 WHERE PERIODID=" & cQuote & cParam & cQuote, objdbRs, False
        aPeriodInfo(0) = Format(IIf(objdbRs.RecordCount > 0, objdbRs("DATE_START"), Now), "yyyy-mm-dd")
        aPeriodInfo(1) = Format(IIf(objdbRs.RecordCount > 0, objdbRs("DATE_END"), Now), "yyyy-mm-dd")
        aPeriodInfo(2) = IIf(objdbRs.RecordCount > 0, objdbRs("Duration"), "")
        
'        cSqlStmt = " SELECT b.empid,concat(b.lastname,', ', b.firstname, ' ', left(b.mname,1), if(trim(b.mname)='','','.') ) as fullname, b.depid,b.posid,b.date_fin,b.date_hire,b.cmpid,b.emp_stat,b.sex,b.active,b.tcid FROM pa87260 a " & _
'                   " left join di3670 b on a.empid=b.empid " & _
'                   " where b.date_fin between " & cQuote & aPeriodInfo(0) & cQuote & " and " & cQuote & aPeriodInfo(1) & cQuote & _
'                   " and a.periodid =" & cQuote & cParam & cQuote & cParam2
'        cSqlStmt = cSqlStmt & " and b.active > 0 "


        cSqlStmt = " SELECT b.empid, concat(b.lastname,', ',b.firstname,' ',if(trim(b.mname)='','',concat(left(b.mname,1),'.'))) as fullname, " & _
                   " b.depid,ifnull(b.posid,'') as posid, if(b.active=1,b.date_res, b.date_fin) as date_fin,b.date_hire,b.cmpid,b.emp_stat,b.sex,b.active,b.tcid,b.wap " & _
                   " FROM di3670 b " & _
                   " Where (((b.date_fin between " & cQuote & aPeriodInfo(0) & cQuote & " and " & cQuote & aPeriodInfo(1) & cQuote & " ) and (b.active=2)) or ((b.date_res between " & cQuote & aPeriodInfo(0) & cQuote & " and " & cQuote & aPeriodInfo(1) & cQuote & " ) and (b.active=1))) " & _
                   " " & cParam2 & _
                   " order by b.emp_stat,b.wap desc, fullname "
    End If
'    MsgBox cSqlStmt
    OpenQueryDNS cSqlStmt, oRecordSet, False
    If oRecordSet.RecordCount > 0 Then

        ShowProgress 0
        
        While Not oRecordSet.EOF
        
            ShowProgress 2, (oRecordSet.AbsolutePosition / oRecordSet.RecordCount) * 100, , , "Retrieving Employee ID#" & oRecordSet("empid")
            
            OpenQueryDNS "select * from di5463 where lineid = " & cQuote & oRecordSet("depid") & cQuote, objdbRs, False
            aOtherInfo(0) = IIf(objdbRs.RecordCount > 0, EncodeStr2(DecodeStr(objdbRs("linename"))), "")
        
            OpenQueryDNS "select ifnull(posname,'') as posname from di7670 where posid = " & cQuote & oRecordSet("posid") & cQuote, objdbRs, False
            If objdbRs.RecordCount > 0 Then
                aOtherInfo(1) = EncodeStr2(DecodeStr(objdbRs("posname")))
            Else
                aOtherInfo(1) = ""
            End If
'            aOtherInfo(1) = IIf(objdbRs.RecordCount > 0, EncodeStr2(DecodeStr(objdbRs("posname"))), "")
        
'            OpenQueryDNS "select * from di2660 where cmpid = " & cQuote & oRecordSet("cmpid") & cQuote, objdbRs, False
'            aOtherInfo(2) = IIf(objdbRs.RecordCount > 0, EncodeStr2(DecodeStr(objdbRs("cmpname"))), "")
            
            aOtherInfo(3) = IIf(oRecordSet("sex") = 0, "Male", "Female")
            aOtherInfo(4) = IIf(oRecordSet("emp_stat") = 0, "Wap", IIf(oRecordSet("emp_stat") = 1, "Contractual", "Regular"))
            aOtherInfo(5) = IIf(oRecordSet("active") = 0, "Active ", IIf(oRecordSet("active") = 1, "Resigned", "Finished"))
                        
                
            cSqlStmt = " INSERT INTO tmpMFCon(DATE_HIRE,DATE_FIN,EMPID,fullname,SEX,EMP_STATname,LineName,POSNAME, " & _
                       " remark,CMPName,tcid,emp_stat,wap)VALUES(" & _
                       cQuote & Format(oRecordSet("DATE_HIRE"), "mm/dd/yyyy") & cQuote & "," & _
                       cQuote & Format(oRecordSet("DATE_FIN"), "mm/dd/yyyy") & cQuote & "," & _
                       cQuote & oRecordSet("EMPID") & cQuote & "," & _
                       cQuote & EncodeStr2(DecodeStr(oRecordSet("FULLNAME"))) & cQuote & "," & _
                       cQuote & aOtherInfo(3) & cQuote & "," & _
                       cQuote & aOtherInfo(4) & cQuote & "," & _
                       cQuote & aOtherInfo(0) & cQuote & "," & _
                       cQuote & aOtherInfo(1) & cQuote & "," & _
                       cQuote & aOtherInfo(5) & cQuote & "," & _
                       cQuote & aOtherInfo(2) & cQuote & "," & _
                       cQuote & oRecordSet("tcid") & cQuote & "," & _
                       oRecordSet("emp_stat") & "," & _
                       oRecordSet("wap") & ")"
                       
            QueryTemp cSqlStmt, objdbRs, True

            oRecordSet.MoveNext
            
        Wend
        
        ShowProgress 3
        
        GenerateReport IIf(nMode = 0, "Monthly Finish Contract Listing", "Finish Contract Report for Payroll - " & aPeriodInfo(2)), IIf(Check4.Value = vbChecked, "LST3670MFC_S", "LST3670MFC") & ".RPT", , True
        
        ShowProgress 4
        
    Else
        MsgBox "No report(s) to generate!", vbExclamation, App.Title
    End If
End Sub


' + -->
' |     Procedure Name  :   GenPEZA(ByVal cPeriodID As String)
' |     Description     :   Generate PEZA Report
' |     Date Created    :   18 apr 2006
' + -->
Sub CreateTmpPEZA()
    On Error GoTo ErrCreate
    Dim cSqlStmt As String
    cSqlStmt = " CREATE TABLE tmpPEZA( " & _
               " [DURATION] CHAR(100),  [PERIODID] char(5), " & _
               " [LineName] char(100),  [DEPID] char(3), " & _
               " [MSMCNT] integer,      [MSFCNT] integer, " & _
               " [REMCNT] integer,      [REFCNT] integer, " & _
               " [COMCNT] integer,      [COFCNT] integer, " & _
               " [CAMCNT] integer,      [CAFCNT] integer, " & _
               " [MSMAMT] double,       [MSFAMT] double, " & _
               " [REMAMT] double,       [REFAMT] double, " & _
               " [COMAMT] double,       [COFAMT] double, " & _
               " [CAMAMT] double,       [CAFAMT] double, " & _
               " [TOTCNT] integer,      [TOTAMT] double)"
               
    oTempConn.Execute cSqlStmt
    While oTempConn.State = adStateExecuting
        DoEvents
    Wend
ErrCreate:
    ' in case table is already existing, let's clear it...
    cSqlStmt = "DELETE FROM tmpPEZA"
    QueryTemp cSqlStmt, oTempADO, True
End Sub

Sub Save2PEZA(ByVal nMode As Integer, ByVal cQueryString As String)
    Dim cSqlStmt As String, _
        cParam, cParam1, cParam2 As String
    
    ShowProgress 0
    
    OpenQueryDNS cQueryString, oTempADO, False
    If oTempADO.RecordCount > 0 Then
    
        While Not oTempADO.EOF
        
            ShowProgress 2, (oTempADO.AbsolutePosition / oTempADO.RecordCount) * 100
            
            Select Case nMode
                Case 0      ' --> initial data
                    cSqlStmt = "insert into tmpPEZA(periodid, duration, depid,linename,totcnt,totamt," & _
                               "msmcnt,msfcnt,remcnt,refcnt,comcnt,cofcnt,camcnt,cafcnt," & _
                               "msmamt,msfamt,remamt,refamt,comamt,cofamt,camamt,cafamt)values(" & _
                               cQuote & oTempADO("periodid") & cQuote & "," & _
                               cQuote & "Payroll Period " & EncodeStr2(oTempADO("duration")) & cQuote & "," & _
                               cQuote & oTempADO("depid") & cQuote & "," & _
                               cQuote & EncodeStr2(oTempADO("linename")) & cQuote & "," & _
                               "0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)"
                    QueryTemp cSqlStmt, objdbRs, True
                    
                Case 1, 2, 3, 4
                    cParam = IIf(oTempADO("sex") = 0, "m", "f")
                    Select Case nMode
                        Case 1      ' --> management & staff
                            cParam = "ms" & cParam
                        Case 2      ' --> regular
                            cParam = "re" & cParam
                        Case 3      ' --> contractual
                            cParam = "co" & cParam
                        Case 4      ' --> casual
                            cParam = "ca" & cParam
                    End Select
                    cParam1 = cParam & "cnt"
                    cParam2 = cParam & "amt"
                    cSqlStmt = "update tmpPEZA set " & cParam1 & "=" & cParam1 & "+" & oTempADO("cnt") & "," & _
                               cParam2 & "=" & cParam2 & "+ " & oTempADO("gross_pay") & "," & _
                               "totcnt = totcnt + " & oTempADO("cnt") & "," & _
                               "totamt = totamt + " & oTempADO("gross_pay") & _
                               " where (depid=" & cQuote & oTempADO("depid") & cQuote & ")"
                    QueryTemp cSqlStmt, objdbRs, True
                    
            End Select
            
            oTempADO.MoveNext
            
        Wend
        
    End If
    
    ShowProgress 4
End Sub

Sub GenPEZA(ByVal cPeriodID As String)
    Dim cSqlStmt As String, _
        cPeriodTable As String, _
        aSQLQuery As Variant, _
        nCtr As Integer
    
    CreateTmpPEZA
    
    cSqlStmt = "select pclose from pa7730 where periodid=" & cQuote & cPeriodID & cQuote
    OpenQueryDNS cSqlStmt, objdbRs, False
    cPeriodTable = IIf(objdbRs("pclose") = 0, "pa87260", "pah87260")
    
    aSQLQuery = Array(" and (a.emp_stat <> 0) and c.staff ", _
                      " and (a.emp_stat = 2) and (not c.staff) ", _
                      " and (a.emp_stat = 1) and (not c.staff) and (not a.wap) ", _
                      " and (a.emp_stat = 1) and (not c.staff) and a.wap ")
    
    cSqlStmt = "select distinct a.depid, ifnull(b.linename,'') as linename, a.periodid, ifnull(c.duration,'') as duration " & _
               "from " & cPeriodTable & " a left join di5463 b on a.depid=b.lineid " & _
               "left join pa7730 c on a.periodid=c.periodid " & _
               "where a.periodid=" & cQuote & cPeriodID & cQuote
               
    Save2PEZA 0, cSqlStmt
    
    cSqlStmt = "select a.depid, ifnull(b.sex,0) as sex, count(a.empid) as cnt, sum(a.gross_pay) as gross_pay " & _
               "from " & cPeriodTable & " a left join di3670 b on a.empid=b.empid " & _
               "left join di7670 c on a.posid=c.posid " & _
               "where (a.periodid=" & cQuote & cPeriodID & cQuote & ")"
    For nCtr = 0 To 3
        Save2PEZA nCtr + 1, cSqlStmt & aSQLQuery(nCtr) & "group by a.depid, b.sex"
    Next nCtr
    
    QueryTemp "select * from tmpPEZA", objdbRs, False
    If objdbRs.RecordCount > 0 Then
        ShowProgress 0
        ShowProgress 3
        GenerateReport "PEZA REPORT", "rpt7392.rpt"
        ShowProgress 4
    End If
End Sub


' + -->
' |     Procedure Name  :   GenPhilHealth(ByVal nQuarter As Integer, cYear As String)
' |     Description     :   Generate Philhealth/Medicare Remittance Report
' |     Date Created    :   21 july 2006
' + -->
Sub CreateTMPPHealth()
    On Error GoTo ErrCreate
    Dim cSqlStmt As String
    cSqlStmt = "CREATE TABLE TMPPHealth( " & _
               " [QTR_INFO] char(50),   [TEL_NUM] char(50)," & _
               " [CMP_TIN] char(20),    [CMP_PH] char(20), " & _
               " [SIGNATORY] char(50),  [POSNAME] char(50), " & _
               " [EMPID] char(6),       [PHEALTHNUM] char(20), " & _
               " [FIRSTNAME] CHAR(100), [LASTNAME] char(100),   [MI] char(2), " & _
               " [BR1] integer,         [BR2] integer,          [BR3] integer," & _
               " [PS1] double,          [ES1] double, " & _
               " [PS2] double,          [ES2] double, " & _
               " [PS3] double,          [ES3] double, " & _
               " [REM1] char(2),        [REM2] char(2),         [REM3] char(2)," & _
               " [DATE_EFC] date,       [TAG] integer)"
               
    oTempConn.Execute cSqlStmt
    While oTempConn.State = adStateExecuting
        DoEvents
    Wend
ErrCreate:
    ' in case table is already existing, let's clear it...
    cSqlStmt = "DELETE FROM TMPPHealth"
    QueryTemp cSqlStmt, oTempADO, True
End Sub

Function getBracket(ByVal nAmount As Double) As Integer
    Dim cSqlStmt As String
    
    cSqlStmt = "select msal_brac from pa7454 where mtot_cont=" & nAmount
    OpenQueryDNS cSqlStmt, objdbRs, False
    If objdbRs.RecordCount > 0 Then
        getBracket = objdbRs("msal_brac")
    Else
        getBracket = 0
    End If
End Function

Sub GenPhilHealth(ByVal nQuarter As Integer, cYear As String)
    Dim cSqlStmt, _
        cParam, _
        cPosName As String, _
        nCtr As Integer, _
        lClose As Boolean, _
        oRecordSet As New ADODB.Recordset
        
    If Not ChkPersonnel(Text2) Then Exit Sub
    
    OpenQueryDNS "select position from pa2360 where userid=" & cQuote & Text2.Text & cQuote, objdbRs, False
    If objdbRs.RecordCount > 0 Then cPosName = objdbRs("position")
        
    CreateTMPPHealth
    
    cSqlStmt = "select empid, active, date_hire, date_res, date_fin, " & _
               " month(date_res) - ((quarter(date_res)-1)*3) as month_res, " & _
               " month(date_fin) - ((quarter(date_fin)-1)*3) as month_fin, " & _
               " month(date_hire) - ((quarter(date_hire)-1)*3) as month_hire " & _
               "from di3670 " & _
               "where ((active=0) and (year(date_hire)=" & Combo3.Text & ") and (quarter(date_hire)=" & Combo2.ListIndex + 1 & "))" & _
               " or ((active=1) and (year(date_res)=" & Combo3.Text & ") and (quarter(date_res)=" & Combo2.ListIndex + 1 & "))" & _
               " or ((active=2) and (year(date_fin)=" & Combo3.Text & ") and (quarter(date_fin)=" & Combo2.ListIndex + 1 & "))"
'    Script2File cSqlStmt
    OpenQueryDNS cSqlStmt, oTempADO, False
    
    ShowProgress 0
    
    lClose = False
    
loopd2:

    cSqlStmt = "select month(b.date_start) - ((quarter(b.date_start)-1)*3) as contri_month, " & _
               "       a.periodid, " & _
               "       a.empid, " & _
               "       ifnull(c.date_hire,'') as date_hire, " & _
               "       ifnull(c.date_res,'') as date_res, " & _
               "       ifnull(c.firstname,'') as firstname, " & _
               "       ifnull(c.mname,'') as mname, " & _
               "       ifnull(c.lastname,'') as lastname, " & _
               "       ifnull(if(trim(c.phealthnum=''),c.sssnum,c.phealthnum),'') as phealthnum, " & _
               "       sum(a.ded_amt) as ded_amt " & _
               "from ((" & IIf(lClose, "pah", "pa") & "87263 a left join " & IIf(lClose, "pah", "pa") & "87260 c on a.periodid=c.periodid and a.empid=c.empid) " & _
               "  left join pa7730 b on a.periodid=b.periodid) " & _
               "where a.periodid in (select periodid From pa7730 " & _
               "    Where (((quarter(date_start) = " & nQuarter + 1 & ") And (Year(date_start) = " & cYear & ")) Or " & _
               "           ((quarter(date_end) = " & nQuarter + 1 & ") And (Year(date_end) = " & cYear & "))) " & _
               "          and pclose=" & IIf(lClose, "1", "0") & ") " & _
               "and (a.dedid='005') and (a.ded_amt>0) " & _
               "group by month(b.date_start), a.empid " & _
               "order by a.empid, a.periodid "
'    Script2File cSqlStmt
    OpenQueryDNS cSqlStmt, oRecordSet, False
    If oRecordSet.RecordCount > 0 Then
        While Not oRecordSet.EOF
        
            ShowProgress 2, (oRecordSet.AbsolutePosition / oRecordSet.RecordCount) * 100
            
'            If oRecordSet("empid") = "013794" Then MsgBox "test"
            cSqlStmt = "select * from tmpphealth where empid=" & cQuote & oRecordSet("empid") & cQuote
            QueryTemp cSqlStmt, objdbRs, False
            If objdbRs.RecordCount = 0 Then
                Select Case oRecordSet("contri_month")
                    Case 1
                        cParam = oRecordSet("ded_amt") & ",0,0"
                    Case 2
                        cParam = "0," & oRecordSet("ded_amt") & ",0"
                    Case 3
                        cParam = "0,0," & oRecordSet("ded_amt")
                End Select
                cSqlStmt = "insert into tmpphealth(signatory,posname,qtr_info,tel_num,cmp_tin,cmp_ph,empid,phealthnum,firstname,lastname,mi,ps1,ps2,ps3,es1,es2,es3,br1,br2,br3,rem1,rem2,rem3,[tag],date_efc)values(" & _
                           cQuote & Label9.Caption & cQuote & "," & _
                           cQuote & cPosName & cQuote & "," & _
                           cQuote & "Quarter Ending " & MonthName((Combo2.ListIndex + 1) * 3) & " " & Combo3.Text & cQuote & "," & _
                           cQuote & gTelNum & cQuote & "," & _
                           cQuote & gTINNum & cQuote & "," & _
                           cQuote & gPHealthNum & cQuote & "," & _
                           cQuote & oRecordSet("empid") & cQuote & "," & _
                           cQuote & oRecordSet("phealthnum") & cQuote & "," & _
                           cQuote & EncodeStr2(DecodeStr(oRecordSet("firstname"))) & cQuote & "," & _
                           cQuote & EncodeStr2(DecodeStr(oRecordSet("lastname"))) & cQuote & "," & _
                           cQuote & left(oRecordSet("mname"), 1) & cQuote & "," & _
                           cParam & "," & cParam & "," & _
                           "0,0,0," & cQuote & cQuote & "," & cQuote & cQuote & "," & cQuote & cQuote & ",0," & _
                           cQuote & Format(oRecordSet("date_hire"), "mm/dd/yyyy") & cQuote & ")"
            Else
                cSqlStmt = "update tmpphealth set ps" & oRecordSet("contri_month") & " = ps" & oRecordSet("contri_month") & "+" & oRecordSet("ded_amt") & "," & _
                           " es" & oRecordSet("contri_month") & " = " & " es" & oRecordSet("contri_month") & "+" & oRecordSet("ded_amt") & _
                           " where empid=" & cQuote & oRecordSet("empid") & cQuote
            End If
            QueryTemp cSqlStmt, objdbRs, True
            oRecordSet.MoveNext
        Wend
    End If
    
    If Not lClose Then
        lClose = True
        GoTo loopd2
    End If
    
    QueryTemp "select empid,ps1,ps2,ps3,es1,es2,es3 from tmpphealth", oRecordSet, False
    If oRecordSet.RecordCount > 0 Then
        While Not oRecordSet.EOF
            ShowProgress 2, (oRecordSet.AbsolutePosition / oRecordSet.RecordCount) * 100
            
            cParam = ""
            
            oTempADO.Requery adAsyncFetch
            oTempADO.Find "EMPID='" & oRecordSet("EMPID") & "'"
            If Not oTempADO.EOF Then
                Select Case oTempADO("active")
                    Case 0
                        cParam = "tag=1," & _
                                 "rem" & oTempADO("month_hire") & "=" & cQuote & "NH" & cQuote & "," & _
                                 "date_efc=" & cQuote & Format(oTempADO("date_hire"), "mm/dd/yyyy") & cQuote & ","
                    Case 1, 2
                        cParam = "tag=1," & _
                                 "rem" & IIf(oTempADO("active") = 1, oTempADO("month_res"), oTempADO("month_fin")) & "=" & cQuote & "S" & cQuote & "," & _
                                 "date_efc=" & cQuote & Format(IIf(oTempADO("active") = 1, oTempADO("date_res"), oTempADO("date_fin")), "mm/dd/yyyy") & cQuote & ","
                End Select
            End If
            
            If Trim(cParam) = "" Then
                If oRecordSet("ps1") + oRecordSet("es1") = 0 Then
                    cParam = IIf(Trim(cParam) = "", "tag=2,", cParam) & _
                             "rem1=" & cQuote & "NE" & cQuote & ","
                End If
                If oRecordSet("ps2") + oRecordSet("es2") = 0 Then
                    cParam = IIf(Trim(cParam) = "", "tag=2,", cParam) & _
                             "rem2=" & cQuote & "NE" & cQuote & ","
                End If
                If oRecordSet("ps3") + oRecordSet("es3") = 0 Then
                    cParam = IIf(Trim(cParam) = "", "tag=2,", cParam) & _
                             "rem3=" & cQuote & "NE" & cQuote & ","
                End If
            End If
            
            cSqlStmt = "update tmpphealth set " & _
                       IIf(Trim(cParam) = "", "", cParam) & _
                       " br1=" & getBracket(oRecordSet("ps1") + oRecordSet("es1")) & "," & _
                       " br2=" & getBracket(oRecordSet("ps2") + oRecordSet("es2")) & "," & _
                       " br3=" & getBracket(oRecordSet("ps3") + oRecordSet("es3")) & _
                       " where empid=" & cQuote & oRecordSet("empid") & cQuote
            QueryTemp cSqlStmt, objdbRs, True
            oRecordSet.MoveNext
        Wend
        
        ShowProgress 3
        
        GenerateReport "Employer Quarterly Remittance Report", "rpt74.rpt"
        
    Else
        MsgBox "No Report to generate!"
    End If
    
    ShowProgress 4

    Set oRecordSet = Nothing
End Sub


' + -->
' |     Procedure Name  :   GenLeaveRep(cParam As String, nmode As Integer)
' |     Description     :   Generate Leave Report
' |     Date Created    :   27 july 2006
' + -->
Sub Createleaverep()
        On Error GoTo ErrCreate
    Dim cSqlStmt As String

    cSqlStmt = " CREATE TABLE Tmp367583( " & _
               " [leave_no] char(10),           [date_leave] date, " & _
               " [date_start] date,             [date_end] date, " & _
               " [duration] char(30), " & _
               " [sl_avail_cnt] double,         [vl_avail_cnt] double, " & _
               " [el_avail_cnt] double,         [ml_avail_cnt] double, " & _
               " [pl_avail_cnt] double,         [fl_avail_cnt] double, " & _
               " [ul_avail_cnt] double,         [Leavename] char(100), " & _
               " [tag] double,                  [paytag] double, " & _
               " [EMPID] char(6),               [fullname] char(100), " & _
               " [LineName] char(100),          [POSNAME] char(100), " & _
               " [rate_amt] double,             [CMPName] char(100), " & _
               " [prep_by] char(6),             [chk_by] char(6), " & _
               " [noted_by] char(6),            [appr_by] char(6), " & _
               " [prep_name] char(100),         [chk_name] char(100),  " & _
               " [noted_name] char(100),        [appr_name] char(100), " & _
               " [prep_pos] char(100),          [chk_pos] char(100),  " & _
               " [noted_pos] char(100),         [appr_pos] char(100))"
               

    oTempConn.Execute cSqlStmt
    While oTempConn.State = adStateExecuting
        DoEvents
    Wend
ErrCreate:
    ' in case table is already existing, let's clear it...
    cSqlStmt = "DELETE FROM Tmp367583"
    QueryTemp cSqlStmt, oTempADO, True

End Sub

Sub Genleaverep(cParam As String, nMode As Integer)
    Dim oRecordSet As New ADODB.Recordset, _
        cSqlStmt As String, _
        cString As String, _
        cParam2 As String, _
        cParam3 As String, _
        cParam4 As String, _
        aOtherDate As Variant, _
        aUserInfo As Variant, _
        aLeave As Variant, _
        aCounter As Variant, _
        dDate_End As Date, _
        dDate_Start As Date, _
        nCtr As Integer
    
    aCounter = Array(0, 0#, 0#)
    aOtherDate = Array("", "", "")
    aLeave = Array(0#, 0#, 0#, 0#, 0#, 0#, 0#)
    aUserInfo = Array("", "", "", "", "")
    
    If Not ChkPersonnel(Text6) Then Exit Sub
    If Not ChkPersonnel(Text5) Then Exit Sub
    If Not ChkPersonnel(Text7) Then Exit Sub
    If Not ChkPersonnel(Text8) Then Exit Sub
    
    Createleaverep

    OpenQueryDNS "SELECT * FROM PA2360 ORDER BY USERID", objdbRs, False
    If objdbRs.RecordCount > 0 Then
        objdbRs.Requery adAsyncFetch
        objdbRs.Find "USERID='" & Text6.Text & "'"
        aUserInfo(0) = IIf(Not objdbRs.EOF, objdbRs("POSITION"), "")

        objdbRs.Requery adAsyncFetch
        objdbRs.Find "USERID='" & Text5.Text & "'"
        aUserInfo(1) = IIf(Not objdbRs.EOF, objdbRs("POSITION"), "")
        
        objdbRs.Requery adAsyncFetch
        objdbRs.Find "USERID='" & Text7.Text & "'"
        aUserInfo(2) = IIf(Not objdbRs.EOF, objdbRs("POSITION"), "")

        objdbRs.Requery adAsyncFetch
        objdbRs.Find "USERID='" & Text8.Text & "'"
        aUserInfo(3) = IIf(Not objdbRs.EOF, objdbRs("POSITION"), "")
    End If
    
    OpenQueryDNS "select * from PA7730 where periodid = " & cQuote & cParam & cQuote, oRecordSet, False
    aOtherDate(0) = IIf(oRecordSet.RecordCount > 0, Format(oRecordSet("date_start"), "yyyy-mm-dd"), "")
    aOtherDate(1) = IIf(oRecordSet.RecordCount > 0, Format(oRecordSet("date_end"), "yyyy-mm-dd"), "")
    aOtherDate(2) = IIf(oRecordSet.RecordCount > 0, oRecordSet("duration"), "")
    
    cParam2 = "and ((date_start between " & cQuote & aOtherDate(0) & cQuote & " and " & cQuote & aOtherDate(1) & cQuote & ") or (date_end between " & cQuote & aOtherDate(0) & cQuote & " and " & cQuote & aOtherDate(1) & cQuote & "))  and a.paytag <> 1 order by a.empid"
    Select Case nMode
        Case 0
            cParam2 = " where a.Tag < 2 " & cParam2
        Case 1
            cParam2 = " where a.Tag = 2 " & cParam2
        Case 2
            cParam2 = " where a.Tag = 3 " & cParam2
        Case 3
            cParam2 = " where a.Tag = 4 " & cParam2
        Case 4
            cParam2 = " where a.Tag = 5 " & cParam2
        Case 5
            cParam2 = " where a.Tag = 6 " & cParam2
        Case Else
            cParam2 = "where a.tag < 6 " & cParam2
        
    End Select
    
    cSqlStmt = " SELECT a.leave_no, a.date_leave, a.date_start,a.date_end, a.empid,concat(b.lastname,', ', b.firstname) as fullname, " & _
               " c.linename,d.posname, ifnull(a.leave_cnt,0) as leave_cnt, ifnull(a.Tag,0) as tag, ifnull(a.paytag,0) as paytag, a.ul_avail,ifnull(rate_amt,0) as rate_amt " & _
               " FROM pa367583 a left join di3670 b on a.empid=b.empid " & _
               " left join di5463 c on b.depid=c.lineid left join di7670 d on b.posid=d.posid "
               
'    MsgBox cSqlStmt & " " & cParam2

    
    OpenQueryDNS cSqlStmt & cParam2, oRecordSet, False
    If oRecordSet.RecordCount > 0 Then
        ShowProgress 0
        cString = ""
        While Not oRecordSet.EOF
        
            ShowProgress 2, (oRecordSet.AbsolutePosition / oRecordSet.RecordCount) * 100, , , "Copying " & Trim(oRecordSet("EMPID")) & "... " & Trim(oRecordSet("FULLNAME")) & "..."
            
            dDate_Start = IIf(Format(oRecordSet("date_start"), "yyyy-mm-dd") > aOtherDate(0), oRecordSet("date_start"), aOtherDate(0))
            
            dDate_End = IIf(Format(oRecordSet("date_end"), "yyyy-mm-dd") > aOtherDate(1), aOtherDate(1), oRecordSet("date_end"))
            
            aCounter = Array(0, 0#, 0#)
            
            nCtr = 0
            
            For nCtr = Day(dDate_Start) To Day(dDate_End)
                 aCounter(0) = aCounter(0) + 1
                 If Weekday(dDate_Start + aCounter(0) - 1) = vbSunday Then
                    aCounter(1) = aCounter(1) + 1
                 End If
            Next nCtr
            
            If nMode <> 0 Then
                Select Case nMode
                    Case 1
                        cParam3 = "el_avail_cnt"
                        cParam4 = aCounter(0) - aCounter(1)
                    Case 2
                        cParam3 = "ml_avail_cnt"
                        cParam4 = aCounter(0) - aCounter(1)
                    Case 3
                        cParam3 = "pl_avail_cnt"
                        cParam4 = aCounter(0) - aCounter(1)
                    Case 4
                        cParam3 = "fl_avail_cnt"
                        cParam4 = aCounter(0) - aCounter(1)
                    Case 5
                        cParam3 = "ul_avail_cnt"
                        cParam4 = aCounter(0) - aCounter(1)
                        
                    Case Else
                        aLeave = Array(0#, 0#, 0#, 0#, 0#, 0#, 0#)
                        cParam4 = aCounter(0) - aCounter(1)
                        aLeave(oRecordSet("tag")) = cParam4
                                
                        cParam3 = "sl_avail_cnt,vl_avail_cnt,el_avail_cnt,ml_avail_cnt,pl_avail_cnt,fl_avail_cnt,ul_avail_cnt"
                        cParam4 = aLeave(0) & "," & aLeave(1) & "," & aLeave(2) & "," & aLeave(3) & "," & aLeave(4) & "," & aLeave(5) & "," & aLeave(6)

                End Select
                
                cSqlStmt = " INSERT INTO Tmp367583(leave_no,date_leave,date_start,date_end,duration," & cParam3 & ",tag,paytag,EMPID,fullname,LineName,POSNAME, " & _
                           " prep_by,chk_by,noted_by,appr_by,prep_name,chk_name,noted_name,appr_name,prep_pos,chk_pos,noted_pos,appr_pos,Leavename,rate_amt)VALUES(" & _
                           cQuote & oRecordSet("leave_no") & cQuote & "," & cQuote & Format(oRecordSet("date_leave"), "yyyy-mm-dd") & cQuote & "," & _
                           cQuote & Format(oRecordSet("date_start"), "yyyy-mm-dd") & cQuote & "," & cQuote & Format(oRecordSet("date_end"), "yyyy-mm-dd") & cQuote & "," & cQuote & aOtherDate(2) & cQuote & "," & _
                           cParam4 & "," & oRecordSet("tag") & "," & oRecordSet("paytag") & "," & _
                           cQuote & oRecordSet("empid") & cQuote & "," & cQuote & oRecordSet("fullname") & cQuote & "," & cQuote & oRecordSet("linename") & cQuote & "," & _
                           cQuote & oRecordSet("posname") & cQuote & "," & _
                           cQuote & Text6.Text & cQuote & "," & cQuote & Text5.Text & cQuote & "," & cQuote & Text7.Text & cQuote & "," & _
                           cQuote & Text8.Text & cQuote & "," & _
                           cQuote & EncodeStr2(DecodeStr(Label8.Caption)) & cQuote & "," & cQuote & EncodeStr2(DecodeStr(Label6.Caption)) & cQuote & "," & _
                           cQuote & EncodeStr2(DecodeStr(Label15.Caption)) & cQuote & "," & cQuote & EncodeStr2(DecodeStr(Label16.Caption)) & cQuote & "," & _
                           cQuote & aUserInfo(0) & cQuote & "," & cQuote & aUserInfo(1) & cQuote & "," & cQuote & aUserInfo(2) & cQuote & "," & _
                           cQuote & aUserInfo(3) & cQuote & "," & _
                           cQuote & IIf(Combo1.ListIndex = 6, "Leave", Combo1.Text) & cQuote & "," & oRecordSet("rate_amt") & ")"
            
            Else
                
                cParam4 = aCounter(0) - aCounter(1)
                If oRecordSet("tag") = 1 Then
                    If Trim(cString) = oRecordSet("empid") Then
                        cSqlStmt = " update Tmp367583 set vl_avail_cnt =" & cParam4 & " where empid = " & cQuote & oRecordSet("empid") & cQuote
                        cString = ""
                    Else
                        cSqlStmt = " INSERT INTO Tmp367583(leave_no,date_leave,date_start,date_end,duration,vl_avail_cnt,tag,paytag,EMPID,fullname,LineName,POSNAME, " & _
                                   " prep_by,chk_by,noted_by,appr_by,prep_name,chk_name,noted_name,appr_name,prep_pos,chk_pos,noted_pos,appr_pos,Leavename,rate_amt)VALUES(" & _
                                   cQuote & oRecordSet("leave_no") & cQuote & "," & cQuote & Format(oRecordSet("date_leave"), "yyyy-mm-dd") & cQuote & "," & _
                                   cQuote & Format(oRecordSet("date_start"), "yyyy-mm-dd") & cQuote & "," & cQuote & Format(oRecordSet("date_end"), "yyyy-mm-dd") & cQuote & "," & cQuote & aOtherDate(2) & cQuote & "," & _
                                   cParam4 & "," & oRecordSet("tag") & "," & oRecordSet("paytag") & "," & _
                                   cQuote & oRecordSet("empid") & cQuote & "," & cQuote & oRecordSet("fullname") & cQuote & "," & cQuote & oRecordSet("linename") & cQuote & "," & _
                                   cQuote & oRecordSet("posname") & cQuote & "," & _
                                   cQuote & Text6.Text & cQuote & "," & cQuote & Text5.Text & cQuote & "," & cQuote & Text7.Text & cQuote & "," & _
                                   cQuote & Text8.Text & cQuote & "," & _
                                   cQuote & EncodeStr2(DecodeStr(Label8.Caption)) & cQuote & "," & cQuote & EncodeStr2(DecodeStr(Label6.Caption)) & cQuote & "," & _
                                   cQuote & EncodeStr2(DecodeStr(Label15.Caption)) & cQuote & "," & cQuote & EncodeStr2(DecodeStr(Label16.Caption)) & cQuote & "," & _
                                   cQuote & aUserInfo(0) & cQuote & "," & cQuote & aUserInfo(1) & cQuote & "," & cQuote & aUserInfo(2) & cQuote & "," & _
                                   cQuote & aUserInfo(3) & cQuote & "," & _
                                   cQuote & Combo1.Text & cQuote & "," & oRecordSet("rate_amt") & ")"

                    End If
                Else
                    cSqlStmt = " INSERT INTO Tmp367583(leave_no,date_leave,date_start,date_end,duration,sl_avail_cnt,vl_avail_cnt,tag,paytag,EMPID,fullname,LineName,POSNAME, " & _
                               " prep_by,chk_by,noted_by,appr_by,prep_name,chk_name,noted_name,appr_name,prep_pos,chk_pos,noted_pos,appr_pos,Leavename,rate_amt)VALUES(" & _
                               cQuote & oRecordSet("leave_no") & cQuote & "," & cQuote & Format(oRecordSet("date_leave"), "yyyy-mm-dd") & cQuote & "," & _
                               cQuote & Format(oRecordSet("date_start"), "yyyy-mm-dd") & cQuote & "," & cQuote & Format(oRecordSet("date_end"), "yyyy-mm-dd") & cQuote & "," & cQuote & aOtherDate(2) & cQuote & "," & _
                               cParam4 & "," & 0 & "," & oRecordSet("tag") & "," & oRecordSet("paytag") & "," & _
                               cQuote & oRecordSet("empid") & cQuote & "," & cQuote & oRecordSet("fullname") & cQuote & "," & cQuote & oRecordSet("linename") & cQuote & "," & _
                               cQuote & oRecordSet("posname") & cQuote & "," & _
                               cQuote & Text6.Text & cQuote & "," & cQuote & Text5.Text & cQuote & "," & cQuote & Text7.Text & cQuote & "," & _
                               cQuote & Text8.Text & cQuote & "," & _
                               cQuote & EncodeStr2(DecodeStr(Label8.Caption)) & cQuote & "," & cQuote & EncodeStr2(DecodeStr(Label6.Caption)) & cQuote & "," & _
                               cQuote & EncodeStr2(DecodeStr(Label15.Caption)) & cQuote & "," & cQuote & EncodeStr2(DecodeStr(Label16.Caption)) & cQuote & "," & _
                               cQuote & aUserInfo(0) & cQuote & "," & cQuote & aUserInfo(1) & cQuote & "," & cQuote & aUserInfo(2) & cQuote & "," & _
                               cQuote & aUserInfo(3) & cQuote & "," & _
                               cQuote & Combo1.Text & cQuote & "," & oRecordSet("rate_amt") & ")"
                    cString = oRecordSet("empid")
                End If
            End If

'ShowProgress 4

'            MsgBox cSqlStmt
            QueryTemp cSqlStmt, objdbRs, True
            oRecordSet.MoveNext
        Wend
        ShowProgress 3
        cParam2 = ""
        Select Case nMode
            Case 0
                cParam2 = "PRV367583"
            Case 1
                cParam2 = "PRV367583_El"
            Case 2
                cParam2 = "PRV367583_Ml"
            Case 3
                cParam2 = "PRV367583_Pl"
            Case 4
                cParam2 = "PRV367583_Fl"
            Case 5
                cParam2 = "PRV367583_Ul"
            Case Else
                cParam2 = "PRV367583_All"
        End Select
                         
        GenerateReport "Leave report", cParam2 & ".RPT", , True
        
        ShowProgress 4
    Else
        MsgBox "No report(s) to generate!", vbExclamation, App.Title
    End If
End Sub

' + -->
' |     Procedure Name  :   GenWithRep(cParam As String)
' |     Description     :   Generate Withholding Tax Report
' |     Date Created    :   27 july 2006
' + -->
Sub CreateWithTax()
        On Error GoTo ErrCreate
    Dim cSqlStmt As String

    cSqlStmt = " CREATE TABLE TmpWithTax( [PERIODID]  char(5), " & _
               " [EMPID]  char(6),       [TINNUM]  char(15), " & _
               " [FIRSTNAME]  char(25),  [MNAME]  char(25), " & _
               " [LASTNAME]  char(25),   [DED_AMT]  double, " & _
               " [WTMONTH] char(30),     [WTYEAR] char(30))"

    oTempConn.Execute cSqlStmt
    While oTempConn.State = adStateExecuting
        DoEvents
    Wend
ErrCreate:
    ' in case table is already existing, let's clear it...
    cSqlStmt = "DELETE FROM TmpWithTax"
    QueryTemp cSqlStmt, oTempADO, True
End Sub

Sub GenWithRep(cParam As String)
    Dim oRecordSet As New ADODB.Recordset, _
        oRSet As New ADODB.Recordset, _
        oRSet2 As New ADODB.Recordset, _
        cSqlStmt As String, _
        cPeriodID As String, _
        cMonth As String, _
        cYear As String
    
    CreateWithTax
    
    cSqlStmt = " select * from PA7730 " & _
               " where (13month=0) and ((month(date_start)=" & cParam & ") and (year(date_start) = " & cQuote & Combo1.Text & cQuote & " )) and " & _
               " ((Month(date_end) = " & cParam & ") And (Year(date_end) = " & cQuote & Combo1.Text & cQuote & "))"
    
    OpenQueryDNS cSqlStmt, oRSet, False
    If oRSet.RecordCount > 0 Then
        cMonth = MonthName(Month(oRSet("date_end")))
        cYear = Year(oRSet("date_end"))
        While Not oRSet.EOF
            If oRSet("pclose") <> 1 Then
                cSqlStmt = " select a.periodid,a.empid,ifnull(b.lastname,'') as lastname, " & _
                           " ifnull(b.firstname,'') as firstname,ifnull(b.mname,'') as mname,ifnull(b.tinnum,'') as tinnum,a.ded_amt from pa87263 a " & _
                           " left join pa87260 b on a.periodid=b.periodid and a.empid=b.empid " & _
                           " Where a.dedid = " & cQuote & "006" & cQuote & " And a.periodid = " & cQuote & oRSet("periodid") & cQuote & " order by a.empid "
                
            Else
                cSqlStmt = " select a.periodid,a.empid,ifnull(b.lastname,'') as lastname, " & _
                           " ifnull(b.firstname,'') as firstname,ifnull(b.mname,'') as mname,ifnull(b.tinnum,'') as tinnum,a.ded_amt from pah87263 a " & _
                           " left join pah87260 b on a.periodid=b.periodid and a.empid=b.empid " & _
                           " Where a.dedid = " & cQuote & "006" & cQuote & " And a.periodid = " & cQuote & oRSet("periodid") & cQuote & " order by a.empid "
            End If
            
'            MsgBox cSqlStmt
            OpenQueryDNS cSqlStmt, oRecordSet, False
            If oRecordSet.RecordCount > 0 Then
                ShowProgress 0
                While Not oRecordSet.EOF
                
                ShowProgress 2, (oRecordSet.AbsolutePosition / oRecordSet.RecordCount) * 100, , , "Copying " & Trim(oRecordSet("EMPID")) & "... " & Trim(oRecordSet("Lastname") & ", " & oRecordSet("firstname")) & "..."
                
                If oRecordSet("ded_amt") <> 0 Then
                    QueryTemp " select periodid,empid from TmpWithTax where empid = " & cQuote & oRecordSet("empid") & cQuote, oRSet2, False
                    If oRSet2.RecordCount > 0 Then
                        'dito yung update
                        cSqlStmt = " update TmpWithTax set ded_amt = ded_amt + " & oRecordSet("ded_amt") & _
                                   " where empid = " & cQuote & oRecordSet("empid") & cQuote
                    Else
                        'insert naman d2
                        cSqlStmt = " INSERT INTO TmpWithTax(PERIODID,EMPID,TINNUM,FIRSTNAME,MNAME,LASTNAME,DED_AMT,WTMONTH,WTYEAR)VALUES(" & _
                                   cQuote & oRecordSet("periodid") & cQuote & "," & _
                                   cQuote & oRecordSet("empid") & cQuote & "," & _
                                   cQuote & oRecordSet("tinnum") & cQuote & "," & _
                                   cQuote & EncodeStr2(DecodeStr(oRecordSet("firstname"))) & cQuote & "," & _
                                   cQuote & EncodeStr2(DecodeStr(oRecordSet("mname"))) & cQuote & "," & _
                                   cQuote & EncodeStr2(DecodeStr(oRecordSet("lastname"))) & cQuote & "," & _
                                   oRecordSet("ded_amt") & "," & cQuote & cMonth & cQuote & "," & cQuote & cYear & cQuote & ")"
                    End If
                    
'                    MsgBox cSqlStmt
                    QueryTemp cSqlStmt, objdbRs, True
                    End If
                    oRecordSet.MoveNext
                Wend
            End If
            
            oRSet.MoveNext
        Wend
        ShowProgress 3
        
        GenerateReport "Individual Withheld Tax Report", "PRVWithTax.RPT", , True
        
        ShowProgress 4
    End If
End Sub


' + -->
' |     Procedure Name  :   GenPagIbig(ByVal cParam As String)
' |     Description     :   Generate Pag-Ibig Remittance Report (Premium & Loan)
' |     Date Created    :   28 july 2006
' + -->
Sub CreateTmpHDMF()
    On Error GoTo ErrCreate
    Dim cSqlStmt As String

    cSqlStmt = "CREATE TABLE TmpHDMF(   [CMP_PAGIBIG] char(20), " & _
               " [MONTH_INFO] char(50), [TEL_NUM] char(50)," & _
               " [SIGNATORY] char(50),  [POSNAME] char(50), " & _
               " [SIGNATORY2] char(50), [POSNAME2] char(50), " & _
               " [EMPID]  char(6),      [PAGIBIGNUM]  char(15), " & _
               " [FIRSTNAME]  char(25), [MNAME]  char(25), " & _
               " [LASTNAME]  char(25),  [DED_AMT]  double, " & _
               " [DED_AMT2]  double,    [TOT_AMT]  double, " & _
               " [date_grant] date,     [ref_no] char(15))"

    oTempConn.Execute cSqlStmt
    While oTempConn.State = adStateExecuting
        DoEvents
    Wend
ErrCreate:
    ' in case table is already existing, let's clear it...
    cSqlStmt = "DELETE FROM TmpHDMF"
    QueryTemp cSqlStmt, oTempADO, True
End Sub

Sub GenPagIbig(ByVal cParam As String)
    Dim cSqlStmt, _
        cPosName, _
        cPeriod As String, _
        aOtherInfo As Variant, _
        nDefAmt As Double
    
    aOtherInfo = Array("", "")
    
    If Not ChkPersonnel(Text6, "Please specify signatory first!!!") Then
        SSTab1.Tab = 3
        Text6.SetFocus
        Exit Sub
    End If
    
    If Check4.Value <> vbChecked Then
        If Not ChkPersonnel(Text5, "Please specify signatory first!!!") Then
            SSTab1.Tab = 3
            Text5.SetFocus
            Exit Sub
        End If
    End If
    
    CreateTmpHDMF
    
    OpenQueryDNS "select position from pa2360 where userid=" & cQuote & Text6.Text & cQuote, objdbRs, False
    If objdbRs.RecordCount > 0 Then aOtherInfo(0) = objdbRs("position")
    
    OpenQueryDNS "select position from pa2360 where userid=" & cQuote & Text5.Text & cQuote, objdbRs, False
    If objdbRs.RecordCount > 0 Then aOtherInfo(1) = objdbRs("position")
    
    If Check4.Value = vbChecked Then
        cSqlStmt = "select def_amt from pa3330 where dedid='003'"
        OpenQueryDNS cSqlStmt, objdbRs, False
        If objdbRs.RecordCount > 0 Then nDefAmt = objdbRs("def_amt")
    End If
    
    cSqlStmt = " select periodid from PA7730 " & _
               " where (13month=0) and ((month(date_start)=" & cParam & ") and (year(date_start) = " & cQuote & Combo1.Text & cQuote & " )) and " & _
               " ((Month(date_end) = " & cParam & ") And (Year(date_end) = " & cQuote & Combo1.Text & cQuote & "))"
    OpenQueryDNS cSqlStmt, objdbRs, False
    If objdbRs.RecordCount > 0 Then
        While Not objdbRs.EOF
            cPeriod = cPeriod & cQuote & objdbRs("periodid") & cQuote & ","
            objdbRs.MoveNext
        Wend
    End If
    If Trim(cPeriod) <> "" Then cPeriod = "(" & left(cPeriod, Len(cPeriod) - 1) & ")"
    
    cSqlStmt = "select a.periodid, a.empid, if(b.firstname is null,0,a.ded_amt) as ded_amt, b.firstname, b.mname, b.lastname, b.pagibigno " & _
               IIf(Check4.Value = vbChecked, ",'' as ref_no, now() as date_grant, 0 as cut_off_amt, '' as ctrl_no ", " ,c.ref_no, c.date_grant, c.cut_off_amt, c.ctrl_no ") & _
               "from pah87263 a left join pah87260 b on a.periodid=b.periodid and a.empid=b.empid " & _
               IIf(Check4.Value = vbChecked, "", " left join di3673 c on a.empid=c.empid and a.dedid=c.dedid and a.ctrl_no=c.ctrl_no ") & _
               "where (a.dedid='" & IIf(Check4.Value = vbChecked, "003", "004") & "') and (a.periodid in " & cPeriod & ")" & IIf(Check4.Value = vbChecked, "", " and (trim(a.ctrl_no)<>'') ") & _
               "Union All " & _
               "select a.periodid, a.empid, if(b.firstname is null,0,a.ded_amt) as ded_amt, b.firstname, b.mname, b.lastname, b.pagibigno " & _
               IIf(Check4.Value = vbChecked, ",'' as ref_no, now() as date_grant, 0 as cut_off_amt, '' as ctrl_no ", " ,c.ref_no, c.date_grant, c.cut_off_amt, c.ctrl_no ") & _
               "from pa87263 a left join pa87260 b on a.periodid=b.periodid and a.empid=b.empid " & _
               IIf(Check4.Value = vbChecked, "", " left join di3673 c on a.empid=c.empid and a.dedid=c.dedid and a.ctrl_no=c.ctrl_no ") & _
               "where (a.dedid='" & IIf(Check4.Value = vbChecked, "003", "004") & "') and (a.periodid in " & cPeriod & ")" & IIf(Check4.Value = vbChecked, "", " and (trim(a.ctrl_no)<>'') ") & _
               "order by periodid,firstname "
    OpenQueryDNS cSqlStmt, oTempADO, False
    If oTempADO.RecordCount > 0 Then
        
        ShowProgress 0
        
        While Not oTempADO.EOF
            
            ShowProgress 2, (oTempADO.AbsolutePosition / oTempADO.RecordCount) * 100
            
            If oTempADO("ded_amt") > 0 Then
                cSqlStmt = "select * from TmpHDMF where empid=" & cQuote & oTempADO("empid") & cQuote
                QueryTemp cSqlStmt, objdbRs, False
                If objdbRs.RecordCount = 0 Then
                    cSqlStmt = "insert into tmpHDMF(month_info,tel_num,cmp_pagibig,signatory,posname,signatory2,posname2," & _
                               "empid,pagibignum,firstname,mname,lastname,ded_amt,ded_amt2,tot_amt" & IIf(Check4.Value <> vbChecked, ",ref_no,date_grant", "") & ")values(" & _
                               cQuote & MonthName(cParam) & " " & Combo1.Text & cQuote & "," & _
                               cQuote & gTelNum & cQuote & "," & _
                               cQuote & gSSSNum & cQuote & "," & _
                               cQuote & Label8.Caption & cQuote & "," & _
                               cQuote & aOtherInfo(0) & cQuote & "," & _
                               cQuote & Label6.Caption & cQuote & "," & _
                               cQuote & aOtherInfo(1) & cQuote & "," & _
                               cQuote & oTempADO("empid") & cQuote & "," & _
                               cQuote & oTempADO("pagibigno") & cQuote & "," & _
                               cQuote & oTempADO("firstname") & cQuote & "," & _
                               cQuote & oTempADO("mname") & cQuote & "," & _
                               cQuote & oTempADO("lastname") & cQuote & "," & _
                               oTempADO("ded_amt") & "," & _
                               IIf(Check4.Value = vbChecked, IIf(oTempADO("ded_amt") > nDefAmt, nDefAmt, oTempADO("ded_amt")), oTempADO("cut_off_amt")) & "," & _
                               IIf(Check4.Value = vbChecked, oTempADO("ded_amt") + IIf(oTempADO("ded_amt") > nDefAmt, nDefAmt, oTempADO("ded_amt")), 0) & _
                               IIf(Check4.Value <> vbChecked, "," & cQuote & oTempADO("ref_no") & cQuote & "," & cQuote & Format(oTempADO("date_grant"), "mm/dd/yyyy") & cQuote, "") & ")"
                Else
                    cSqlStmt = "update tmpHDMF set ded_amt = ded_amt + " & oTempADO("ded_amt") & _
                               " where empid=" & cQuote & oTempADO("empid") & cQuote
                End If
                QueryTemp cSqlStmt, objdbRs, True
            End If
            
            oTempADO.MoveNext
        Wend
    
        ShowProgress 3
        GenerateReport IIf(Check4.Value = vbChecked, "MEMBERSHIP REGISTRATION/REMITTANCE FORM", ""), IIf(Check4.Value = vbChecked, "rpt4364.rpt", "rpt4364l.rpt")
        ShowProgress 4
    Else
        MsgBox "No data to process!", vbInformation, "System Advisory!!!"
    End If
End Sub


Function DetectDBF(cDBFPath As String) As Boolean
    On Error GoTo ErrDetect
    Dim cString As String
    
    DoEvents

    If oDBFConn.State = adStateOpen Then oDBFConn.Close
    With oDBFConn
        .CursorLocation = adUseClient
        cString = "Provider=Microsoft.Jet.OLEDB.4.0;" & _
                   "Data Source=" & cDBFPath & ";" & _
                   "Extended Properties=" & cQuote & "DBASE IV;" & cQuote & ";"
'        MsgBox cString
        .ConnectionString = cString
        .Open
    End With

    DetectDBF = True

    Exit Function

ErrDetect:
    MsgBox "Error retrieving DBF file", vbCritical
    DetectDBF = False
End Function

Sub QueryDBF(ByVal cSqlStmt As String, oADORSet As ADODB.Recordset, ByVal lState As Boolean)
    On Error GoTo ErrQuery
    
    DoEvents
    If Not lState Then
        Set oADORSet = oDBFConn.Execute(cSqlStmt)
    Else
        oDBFConn.Execute (cSqlStmt)
        While oDBFConn.State = adStateExecuting
            DoEvents
        Wend
    End If
    Exit Sub
    
ErrQuery:
    ErrorMsg Err.Number, Err.Description, "Open DBF Query", "uSRM"
End Sub


' + -->
' |     Procedure Name  :   SSSPData(cParam As String)
' |     Description     :   Generate SSS Premium Remittance Report
' |     Date Created    :   8 aug 2006
' + -->
Sub SSSPData(cParam As String)
    On Error GoTo ErrLoad
    
    Dim cSqlStmt As String, oFile As File, oTextFile As New FileSystemObject, _
        oRecordSet As New ADODB.Recordset, _
        oRSet As New ADODB.Recordset, _
        oRSet2 As New ADODB.Recordset, _
        cParam2 As String, _
        nPClose As Integer, _
        aEmpInfo As Variant

    Check4.Value = vbChecked
    
    aEmpInfo = Array("", "", "", "", "", 0#)
        
    CommonDialog1.CancelError = False

    CommonDialog1.InitDir = CheckPath(cUploadPath) & "SSS Data\"
    CommonDialog1.Filter = IIf(Check4.Value = vbChecked, "SSS Premium File | employee.dbf", "SSS Loan File | lmstrndu.dbf")
    CommonDialog1.Flags = cdlOFNFileMustExist
    CommonDialog1.ShowOpen
    
    Set oFile = oTextFile.GetFile(CommonDialog1.Filename)
    If DetectDBF(left(oFile.Path, Len(oFile.Path) - Len(oFile.Name) - 1)) Then
    '   delete laman ng dbf
        cSqlStmt = "delete from " & IIf(Check4.Value = vbChecked, "employee", "lmstrndu")
        QueryDBF cSqlStmt, objdbRs, True
    
    End If
    
    cSqlStmt = " SELECT periodid,date_start,date_end FROM pa7730 " & _
               " where (13month=0) and (month(date_start) = " & cParam & " and  month(date_end) = " & cParam & ") and " & _
               " (year(date_start) = " & cQuote & Combo1.Text & cQuote & " and year(date_end) = " & cQuote & Combo1.Text & cQuote & ")"
    OpenQueryDNS cSqlStmt, oRSet, False
    
    cParam2 = ""
    If oRSet.RecordCount > 0 Then
        While Not oRSet.EOF
            cParam2 = IIf(cParam2 = "", cQuote & oRSet("periodid"), cParam2 & cQuote & "," & cQuote & oRSet("periodid") & cQuote)
            oRSet.MoveNext
        Wend
    End If
    
    cSqlStmt = "SELECT a.periodid,a.empid as empid, ifnull(b.firstname,c.firstname) as firstname, " & _
               "  left(ifnull(b.mname,c.mname),1) as mname, " & _
               "  ifnull(b.lastname,c.lastname) as lastname, ifnull(ssnum,'') as ssnum, " & _
               "  round(Sum(a.ded_amt + a.ded_amt2), 2) As ded_amt " & _
               "FROM pah87263 a left join di3670 b on a.empid=b.empid " & _
               "  left join pah87260 c on a.periodid=c.periodid and a.empid=c.empid " & _
               "where (a.periodid in ( " & cParam2 & " )) and (a.dedid=" & cQuote & IIf(Check4.Value = vbChecked, "001", "002") & cQuote & ") and ((a.ded_amt + a.ded_amt2) <> 0) " & _
               "group by a.empid " & _
               "Union All " & _
               "SELECT a.periodid,a.empid as empid, ifnull(b.firstname,c.firstname) as firstname, " & _
               "  left(ifnull(b.mname,c.mname),1) as mname, " & _
               "  ifnull(b.lastname,c.lastname) as lastname, ifnull(ssnum,'') as ssnum, " & _
               "  round(Sum(a.ded_amt + a.ded_amt2), 2) As ded_amt " & _
               "FROM pa87263 a left join di3670 b on a.empid=b.empid " & _
               "  left join pa87260 c on a.periodid=c.periodid and a.empid=c.empid " & _
               "where (a.periodid in ( " & cParam2 & " )) and (a.dedid=" & cQuote & IIf(Check4.Value = vbChecked, "001", "002") & cQuote & ") and ((a.ded_amt + a.ded_amt2) <> 0) " & _
               "group by a.empid " & _
               "order by empid, periodid "
'    Script2File cSqlStmt
    OpenQueryDNS cSqlStmt, oRecordSet, False
    If oRecordSet.RecordCount > 0 Then
        
        ShowProgress 0
        
        While Not oRecordSet.EOF
        
            ShowProgress 2, (oRecordSet.AbsolutePosition / oRecordSet.RecordCount) * 100, , , "Copying " & Trim(oRecordSet("EMPID")) & "... " & Trim(oRecordSet("Lastname") & ", " & oRecordSet("firstname")) & "..."
            
            If aEmpInfo(0) <> oRecordSet("empid") Then
                If Trim(aEmpInfo(0)) <> "" Then
'                    If Check4.Value = vbChecked Then
                        cSqlStmt = "INSERT INTO employee(RECCD,ESURN,ENAME,EENMI,SSNUM,SIGN1,SSS01,SIGN2,SSS02,SIGN3,SSS03,SMED1,MED01,SMED2," & _
                                   " MED02,SMED3,MED03,SEC01,EC001,SEC02,EC002,SEC03,EC003,APQTR,REMKS,HRDTE)VALUES(" & _
                                   cQuote & "20" & cQuote & "," & _
                                   cQuote & aEmpInfo(1) & cQuote & "," & _
                                   cQuote & aEmpInfo(2) & cQuote & "," & _
                                   cQuote & aEmpInfo(3) & cQuote & "," & _
                                   cQuote & aEmpInfo(4) & cQuote & "," & _
                                   cQuote & cQuote & "," & aEmpInfo(5) & "," & _
                                   cQuote & cQuote & "," & "0.00" & "," & cQuote & cQuote & "," & "0.00" & "," & _
                                   cQuote & cQuote & "," & "0.00" & "," & cQuote & cQuote & "," & "0.00" & "," & _
                                   cQuote & cQuote & "," & "0.00" & "," & cQuote & cQuote & "," & IIf(aEmpInfo(5) > 0, "10.00", "0.00") & "," & _
                                   cQuote & cQuote & "," & "0.00" & "," & cQuote & cQuote & "," & "0.00" & "," & _
                                   cQuote & cQuote & "," & cQuote & "N" & cQuote & "," & cQuote & cQuote & ")"
'                    Else
'                        cSqlStmt = "insert into lmstrndu(recid,eeno,sname,gname,midinit,ltype,ldate,lamt,pen,amtpd,ampdsg,rem)values(" & _
'                                   cQuote & "10" & cQuote & "," & _
'                                   cQuote & aEmpInfo(4) & cQuote & "," & _
'                                   cQuote & aEmpInfo(1) & cQuote & "," & _
'                                   cQuote & aEmpInfo(2) & cQuote & "," & _
'                                   cQuote & aEmpInfo(3) & cQuote & "," & _
'                                   cQuote & "S" & cQuote & "," & _
'                                   ")"
'                    End If
                    QueryDBF cSqlStmt, objdbRs, True
                End If
'                Else
                    aEmpInfo(0) = oRecordSet("empid")
                    aEmpInfo(1) = EncodeStr2(DecodeStr(left(oRecordSet("lastname"), 15)))
                    aEmpInfo(2) = EncodeStr2(DecodeStr(left(oRecordSet("firstname"), 15)))
                    aEmpInfo(3) = EncodeStr2(DecodeStr(left(oRecordSet("mname"), 1)))
                    aEmpInfo(4) = left(oRecordSet("ssnum"), 10)
                    aEmpInfo(5) = oRecordSet("ded_amt")
'                End If
            Else
                aEmpInfo(5) = aEmpInfo(5) + oRecordSet("ded_amt")
            End If
            
            oRecordSet.MoveNext
            
            If oRecordSet.EOF Then
                cSqlStmt = "INSERT INTO employee(RECCD,ESURN,ENAME,EENMI,SSNUM,SIGN1,SSS01,SIGN2,SSS02,SIGN3,SSS03,SMED1,MED01,SMED2," & _
                           " MED02,SMED3,MED03,SEC01,EC001,SEC02,EC002,SEC03,EC003,APQTR,REMKS,HRDTE)VALUES(" & _
                           cQuote & "20" & cQuote & "," & _
                           cQuote & aEmpInfo(1) & cQuote & "," & _
                           cQuote & aEmpInfo(2) & cQuote & "," & _
                           cQuote & aEmpInfo(3) & cQuote & "," & _
                           cQuote & aEmpInfo(4) & cQuote & "," & _
                           cQuote & cQuote & "," & aEmpInfo(5) & "," & _
                           cQuote & cQuote & "," & "0.00" & "," & cQuote & cQuote & "," & "0.00" & "," & _
                           cQuote & cQuote & "," & "0.00" & "," & cQuote & cQuote & "," & "0.00" & "," & _
                           cQuote & cQuote & "," & "0.00" & "," & cQuote & cQuote & "," & "10.00" & "," & _
                           cQuote & cQuote & "," & "0.00" & "," & cQuote & cQuote & "," & "0.00" & "," & _
                           cQuote & cQuote & "," & cQuote & "N" & cQuote & "," & cQuote & cQuote & ")"
                QueryDBF cSqlStmt, objdbRs, True
            End If
        Wend
        
        ShowProgress 4
        
        MsgBox "Saving Done... Press [OK] to continue...", vbInformation, App.Title
    End If
    
    Set oDBFConn = Nothing
    
    Exit Sub

ErrLoad:
    MsgBox "Error uploading SSS..."
End Sub


' + -->
' |     Procedure Name  :   GenBackupPay
' |     Description     :   Generate Backup of Processed Payroll Transaction...
' |     Date Created    :   15 aug 2006
' + -->
' + -->
' |     Procedure Name  :   GenBackupPay
' |     Description     :   Generate Backup of Processed Payroll Transaction...
' |     Date Created    :   15 aug 2006
' + -->
'Sub createBackupPay()
Sub createBackupK1Pay(nMode As Integer)
    On Error GoTo ErrCreate
    Dim cSqlStmt As String

    If nMode = 0 Then
        cSqlStmt = "CREATE TABLE K1PAY (" & _
                   " [EMPID] char(6),                [FULLNAME] char(60),            [POSITION] char(60), " & _
                   " [DEPID] char(3),                [DEPARTMENT] char(60)," & _
                   " [EMP_STAT] char(1),             [WAP] char(1),                  [DATE_HIRE] char(10),           [STATUS] char(2)," & _
                   " [date_res] char(10),            [TAXCODE] char(5),              [RATE_AMT] NUMERIC(18,4),       [POS_ALLOW] NUMERIC(18,4)," & _
                   " [COLA_AMT] double,              [REG_DAY] double,               [REG_PAY] double,               [REG_OT_HR] NUMERIC(18,4)," & _
                   " [REG_OT_PAY] NUMERIC(18,4),     [ND_DAY] NUMERIC(18,4),         [ND_PAY] NUMERIC(18,4),         [ND_OT_HR] NUMERIC(18,4)," & _
                   " [ND_OT_PAY] NUMERIC(18,4),      [HOLIDAY] NUMERIC(18,4),        [HOL_PAY] NUMERIC(18,4),        [SA_REG_OT] NUMERIC(18,4)," & _
                   " [SA_REG_PAY] NUMERIC(18,4),     [SA_ND_OT] NUMERIC(18,4),       [SA_ND_PAY] NUMERIC(18,4),      [SUN_HR] NUMERIC(18,4)," & _
                   " [SUN_PAY] NUMERIC(18,4),        [SUN_OT] NUMERIC(18,4),         [SUN_OT_PAY] NUMERIC(18,4),     [SUN_COLA] NUMERIC(18,4)," & _
                   " [ADJ_PAY] NUMERIC(18,4),        [SA_ADJ_PAY] NUMERIC(18,4),     [OTHER_PAY] NUMERIC(18,4),      [LEAVE_PAY] NUMERIC(18,4),      [M13PAY] NUMERIC(18,4)," & _
                   " [WTAX] NUMERIC(18,4),           [TAXABLE] NUMERIC(18,4),        [SSPREM] NUMERIC(18,4),         [SSLOAN] NUMERIC(18,4)," & _
                   " [MEDICARE] NUMERIC(18,4),       [PAGIBIGPREM] NUMERIC(18,4),    [PAGIBIGLOAN] NUMERIC(18,4),    [UNIONDUE] NUMERIC(18,4)," & _
                   " [MF_LOAN] NUMERIC(18,4),        [CA] NUMERIC(18,4),             [PE] NUMERIC(18,4),             [EL] NUMERIC(18,4)," & _
                   " [ASSESS] NUMERIC(18,4),         [OP] NUMERIC(18,4),             [DE] NUMERIC(18,4),             [UN] NUMERIC(18,4),                [DED_AMT] NUMERIC(18,4)," & _
                   " [GROSS_PAY] NUMERIC(18,4),      [NET_PAY] NUMERIC(18,4),        [SA_NET_PAY] NUMERIC(18,4),     [GROSS16231] NUMERIC(18,4)," & _
                   " [SSER] NUMERIC(18,4),           [SSS01] NUMERIC(18,4),          [EC001] NUMERIC(18,4),          [SSER1215] NUMERIC(18,4)," & _
                   " [SSPREM1215] NUMERIC(18,4),     [MEDICARE2] NUMERIC(18,4),      [MED01] NUMERIC(18,4),          [PS1215] NUMERIC(18,4)," & _
                   " [ES1215] NUMERIC(18,4),         [SSSNUM] char(15),              [TINNUM] char(15),              [PAYSTATUS] NUMERIC(1,0)," & _
                   " [PAGIBIGNO] char(15),           [FIRSTNAME] char(60),           [MNAME] char(60),               [LASTNAME] char(60)," & _
                   " [PHEALTHNUM] char(15),          [BASIC1215] NUMERIC(18,4), " & _
                   " [BASICPAY] NUMERIC(18,4),       [SEQ_NO] NUMERIC(1,0))"
                
    Else
        cSqlStmt = " CREATE TABLE MASTERK1 (" & _
                   " [EMPID] char(6),        [LASTNAME] char(20),        [MNAME] char(20),       [FIRSTNAME] char(20), " & _
                   " [BIRTHDAY] date,        [SEX] char(1),              [PAGIBIGNO] char(15),   [DEPID] char(3), " & _
                   " [LineName] char(20),    [POSID] char(3),            [POSNAME] char(50),     [POS_ALLOW] double, " & _
                   " [RATE_AMT] double,      [MTD_BASIC] double,         [MTD_GROSS] double,     [YTD_BASIC] double, " & _
                   " [YTD_GROSS] double,     [YTD_WTAX] double,          [EMP_STAT] char(1),     [PAYSTATUS] char(1), " & _
                   " [SSNUM] char(15),       [ISUNION] char(1),          [TIN] char(15),         [TAXID] char(3), " & _
                   " [TAXCODE] char(15),     [TAXNAME] char(100),        [FULLNAME] char(100),   [DATE_HIRE] date, " & _
                   " [SL_AVAIL] double,      [VL_AVAIL] double,          [SL_USE] double,        [VL_USE] double, " & _
                   " [SSPREM1215] double,    [SSER1215] double,          [PS1215] double,        [ES1215] double, " & _
                   " [DATE_RES] date,        [STATUS] integer,           [ACTIVE] char(2),       [WAP] char(1), " & _
                   " [CMPID] char(4),        [CMPName] char(50))"
    
    End If
    
    oDBFConn.Execute cSqlStmt
    While oDBFConn.State = adStateExecuting
        DoEvents
    Wend
ErrCreate:
    ' in case table is already existing, let's clear it...
    If nMode = 0 Then
        cSqlStmt = "DELETE FROM K1PAY"
    Else
        cSqlStmt = "DELETE FROM MASTERK1"
    End If
    QueryDBF cSqlStmt, oTempADO, True
End Sub

Sub GenbackupK1pay(cPath As String, ByVal cPeriod As String)
    Dim oRecordSet As New ADODB.Recordset, _
        cSqlStmt As String

    DetectDBF cPath
    
    createBackupK1Pay 0
    createBackupK1Pay 1
    
    ShowProgress 0

    cSqlStmt = " select a.EMPID, a.FULLNAME,  ifnull(d.posname,'') as position, a.depid, ifnull(b.linename,'') as department," & _
           " if(a.EMP_STAT=0,'W',if(a.EMP_STAT=1,'C','R')) as emp_stat, if(a.WAP=1,'1','') as WAP, " & _
           " a.DATE_HIRE, if(a.ACTIVE>0,if(a.ACTIVE=1,'R','FC'),'') as status, if(a.ACTIVE>0,a.date_res,'') as date_res, " & _
           " ifnull(c.taxcode,'') as taxcode, a.RATE_AMT, a.POS_ALLOW, a.COLA, a.SUN_COLA, " & _
           " a.REG_DAY, a.REG_PAY, a.REG_OT_HR, a.REG_OT_PAY, a.NDIFF_DAY, a.NDIFF_PAY, a.NDIFF_OT_HR, a.NDIFF_OT_PAY, a.HOLIDAY, a.HOL_PAY, a.SA_REG_OT, a.SA_REG_PAY, a.SA_NDIFF_OT, a.SA_NDIFF_PAY, a.SUN_HR, a.SUN_PAY, a.SUN_OT, a.SUN_OT_PAY, " & _
           " a.ADJ_PAY, a.SA_ADJ_PAY, a.OTHER_PAY, a.LEAVE_PAY, a.M13PAY, a.WTAX, a.TAXABLE, a.SSPREM,  ifnull(e.ded_amt,0) as SSSLOAN, a.MEDICARE, ifnull(f.ded_amt,0) as PAGIBIGPREM, ifnull(g.ded_amt,0) as PAGIBIGLOAN, " & _
           " ifnull(h.ded_amt,0) as UNIONDUE, ifnull(i.ded_amt,0) as MF_LOAN, ifnull(j.ded_amt,0) as CA, ifnull(k.ded_amt,0) as PE, ifnull(l.ded_amt,0) as EL, ifnull(m.ded_amt,0) as ASSESS, ifnull(n.ded_amt,0) as OP, ifnull(o.ded_amt,0) as DE, " & _
           " a.DED_AMT, a.GROSS_PAY, a.NET_PAY, a.SA_NET_PAY, a.GROSS16231, a.SSER, a.SSS01, a.EC001, a.SSER1215, a.SSPREM1215, a.MEDICARE2, a.MED01, a.PS1215, a.ES1215, " & _
           " a.SSSNUM , a.TINNUM, a.PAYSTATUS, a.PAGIBIGNO, a.FIRSTNAME, a.MNAME, a.LASTNAME, a.PHEALTHNUM, a.BASIC1215, " & _
           " a.basicpay,a.seq_no,ifnull(p.ded_amt,0) as UN " & _
           " from pa87260 a left join pa87263 p on a.periodid=p.periodid and a.empid=p.empid and p.dedid='015' " & _
           " left join pa87263 e on a.periodid=e.periodid and a.empid=e.empid and e.dedid='002' " & _
           " left join pa87263 f on a.periodid=f.periodid and a.empid=f.empid and f.dedid='003' " & _
           " left join pa87263 g on a.periodid=g.periodid and a.empid=g.empid and g.dedid='004' " & _
           " left join pa87263 h on a.periodid=h.periodid and a.empid=h.empid and h.dedid='007' " & _
           " left join pa87263 i on a.periodid=i.periodid and a.empid=i.empid and i.dedid='008' " & _
           " left join pa87263 j on a.periodid=j.periodid and a.empid=j.empid and j.dedid='009' " & _
           " left join pa87263 k on a.periodid=k.periodid and a.empid=k.empid and k.dedid='010' " & _
           " left join pa87263 l on a.periodid=l.periodid and a.empid=l.empid and l.dedid='011' " & _
           " left join pa87263 m on a.periodid=m.periodid and a.empid=m.empid and m.dedid='012' " & _
           " left join pa87263 n on a.periodid=n.periodid and a.empid=n.empid and n.dedid='013' " & _
           " left join pa87263 o on a.periodid=o.periodid and a.empid=o.empid and o.dedid='014' " & _
           " left join di5463 b on a.depid=b.lineid left join pa8290 c on a.taxid=c.taxid left join di7670 d on a.posid=d.posid " & _
           " where a.periodid= " & cQuote & cPeriod & cQuote & _
           " order by status, a.depid, a.emp_stat desc, a.lastname, a.firstname "
'    MsgBox cSqlStmt
    OpenQueryDNS cSqlStmt, oRecordSet, False
    If oRecordSet.RecordCount > 0 Then

        While Not oRecordSet.EOF

            ShowProgress 2, (oRecordSet.AbsolutePosition / oRecordSet.RecordCount) * 100, , , "Copying " & Trim(oRecordSet("EMPID")) & "... " & Trim(oRecordSet("Lastname") & ", " & oRecordSet("firstname")) & "..."

            cSqlStmt = " INSERT INTO K1pay (EMPID,FULLNAME,[POSITION],DEPID,DEPARTMENT,EMP_STAT,WAP,DATE_HIRE,[STATUS],date_res,TAXCODE,RATE_AMT,POS_ALLOW,COLA_AMT,SUN_COLA,REG_DAY,REG_PAY,REG_OT_HR,REG_OT_PAY,ND_DAY,ND_PAY,ND_OT_HR," & _
                       " ND_OT_PAY,[HOLIDAY],HOL_PAY,SA_REG_OT,SA_REG_PAY,SA_ND_OT,SA_ND_PAY,SUN_HR,SUN_PAY,SUN_OT,SUN_OT_PAY,ADJ_PAY,SA_ADJ_PAY,OTHER_PAY,LEAVE_PAY,M13PAY,WTAX,TAXABLE,SSPREM,SSLOAN,MEDICARE,PAGIBIGPREM,PAGIBIGLOAN, " & _
                       " UNIONDUE,MF_LOAN,CA,PE,EL,ASSESS,OP,DE,DED_AMT,GROSS_PAY,NET_PAY,SA_NET_PAY,GROSS16231,SSER,SSS01,EC001,SSER1215,SSPREM1215,MEDICARE2,MED01,PS1215,ES1215,SSSNUM,TINNUM,PAYSTATUS,PAGIBIGNO,FIRSTNAME,MNAME,LASTNAME,PHEALTHNUM,BASIC1215,BASICPAY,SEQ_NO,UN)VALUES(" & _
                       cQuote & left(oRecordSet("EMPID"), 6) & cQuote & "," & cQuote & EncodeStr2(DecodeStr(left(oRecordSet("FULLNAME"), 100))) & cQuote & "," & _
                       cQuote & EncodeStr2(DecodeStr(left(oRecordSet("POSITION"), 100))) & cQuote & "," & _
                       cQuote & oRecordSet("DEPID") & cQuote & "," & cQuote & EncodeStr2(DecodeStr(left(oRecordSet("DEPARTMENT"), 100))) & cQuote & "," & _
                       cQuote & left(oRecordSet("EMP_STAT"), 1) & cQuote & "," & cQuote & left(oRecordSet("WAP"), 1) & cQuote & "," & _
                       cQuote & left(oRecordSet("DATE_HIRE"), 10) & cQuote & "," & _
                       cQuote & left(oRecordSet("STATUS"), 2) & cQuote & "," & _
                       cQuote & left(oRecordSet("date_res"), 10) & cQuote & "," & _
                       cQuote & left(oRecordSet("TAXCODE"), 5) & cQuote & "," & _
                       oRecordSet("RATE_AMT") & "," & oRecordSet("POS_ALLOW") & "," & oRecordSet("COLA") & "," & oRecordSet("SUN_COLA") & "," & oRecordSet("REG_DAY") & "," & oRecordSet("REG_PAY") & "," & oRecordSet("REG_OT_HR") & "," & _
                       oRecordSet("REG_OT_PAY") & "," & oRecordSet("NDIFF_DAY") & "," & oRecordSet("NDIFF_PAY") & "," & oRecordSet("NDIFF_OT_HR") & "," & oRecordSet("NDIFF_OT_PAY") & "," & oRecordSet("HOLIDAY") & "," & oRecordSet("HOL_PAY") & "," & _
                       oRecordSet("SA_REG_OT") & "," & oRecordSet("SA_REG_PAY") & "," & oRecordSet("SA_NDIFF_OT") & "," & oRecordSet("SA_NDIFF_PAY") & "," & oRecordSet("SUN_HR") & "," & oRecordSet("SUN_PAY") & "," & oRecordSet("SUN_OT") & "," & oRecordSet("SUN_OT_PAY") & "," & _
                       oRecordSet("ADJ_PAY") & "," & oRecordSet("SA_ADJ_PAY") & "," & oRecordSet("OTHER_PAY") & "," & oRecordSet("LEAVE_PAY") & "," & oRecordSet("M13PAY") & "," & oRecordSet("WTAX") & "," & oRecordSet("TAXABLE") & "," & oRecordSet("SSPREM") & "," & _
                       oRecordSet("SSSLOAN") & "," & oRecordSet("MEDICARE") & "," & oRecordSet("PAGIBIGPREM") & "," & oRecordSet("PAGIBIGLOAN") & "," & oRecordSet("UNIONDUE") & "," & oRecordSet("MF_LOAN") & "," & oRecordSet("CA") & "," & oRecordSet("PE") & "," & _
                       oRecordSet("EL") & "," & oRecordSet("ASSESS") & "," & oRecordSet("OP") & "," & oRecordSet("DE") & "," & oRecordSet("DED_AMT") & "," & oRecordSet("GROSS_PAY") & "," & oRecordSet("NET_PAY") & "," & oRecordSet("SA_NET_PAY") & "," & _
                       oRecordSet("GROSS16231") & "," & oRecordSet("SSER") & "," & oRecordSet("SSS01") & "," & oRecordSet("EC001") & "," & oRecordSet("SSER1215") & "," & oRecordSet("SSPREM1215") & "," & oRecordSet("MEDICARE2") & "," & oRecordSet("MED01") & "," & oRecordSet("PS1215") & "," & _
                       oRecordSet("ES1215") & "," & _
                       cQuote & left(oRecordSet("SSSNUM"), 15) & cQuote & "," & cQuote & left(oRecordSet("TINNUM"), 15) & cQuote & "," & oRecordSet("PAYSTATUS") & "," & cQuote & left(oRecordSet("PAGIBIGNO"), 15) & cQuote & "," & _
                       cQuote & EncodeStr2(DecodeStr(left(oRecordSet("FIRSTNAME"), 100))) & cQuote & "," & _
                       cQuote & EncodeStr2(DecodeStr(left(oRecordSet("MNAME"), 100))) & cQuote & "," & _
                       cQuote & EncodeStr2(DecodeStr(left(oRecordSet("LASTNAME"), 100))) & cQuote & "," & cQuote & left(oRecordSet("PHEALTHNUM"), 15) & cQuote & "," & oRecordSet("BASIC1215") & "," & _
                       oRecordSet("BASICPAY") & "," & oRecordSet("seq_no") & "," & oRecordSet("UN") & ")"
            QueryDBF cSqlStmt, objdbRs, True

            oRecordSet.MoveNext

        Wend

        ShowProgress 4
    Else
        MsgBox "Data not found...!!!", vbInformation, App.Title
        Exit Sub
    End If

    ShowProgress 0
    
    cSqlStmt = " SELECT a.date_hire,if(a.active>0,if(a.active=1,a.date_res,a.date_fin),'') as date_res,a.status,a.rate_amt,a.empid,a.firstname,a.mname,a.lastname," & _
               " a.cmpid,b.cmpname,a.depid,c.linename,ifnull(a.ssnum,'') as ssnum,a.pagibigno,a.tin,a.taxcode,d.taxname,a.birthday,if(a.emp_stat=0,'W',if(a.emp_stat=1,'C','R')) as emp_stat, " & _
               " if(a.isunion=0,'Y','N') as isUnion,if(a.sex=0,'M','F') as sex,a.posid,e.posname,a.ytd_gross,a.ytd_basic,a.ytd_wtax,a.sl_avail,a.vl_avail,a.sl_use,a.vl_use," & _
               " a.pos_allow,a.date_res,a.ytd_cola,a.ytd_gross_sa,a.mtd_basic,a.mtd_gross,a.es1215,a.ps1215,a.ssprem1215,a.sser1215,if(a.paystatus=0,'D','M') as paystatus," & _
               " if(a.active>0,if(a.active=1,'R','FC'),'') as active,if(a.wap=1,'Y','') as wap,a.taxid,concat(a.lastname,', ', a.firstname,' ', if(trim(a.mname)='','',concat(left(a.mname,1),'.'))) as fullname FROM di3670 a " & _
               " left join di2660 b on a.cmpid=b.cmpid left join di5463 c on a.depid=c.lineid left join pa8290 d on a.taxcode=d.taxcode left join DI7670 e on a.posid=e.posid "
'    MsgBox cSqlStmt
    OpenQueryDNS cSqlStmt, oRecordSet, False
    If oRecordSet.RecordCount > 0 Then

        While Not oRecordSet.EOF

            ShowProgress 2, (oRecordSet.AbsolutePosition / oRecordSet.RecordCount) * 100, , , "Copying " & Trim(oRecordSet("EMPID")) & "... " & Trim(oRecordSet("Lastname") & ", " & oRecordSet("firstname")) & "..."

            cSqlStmt = " INSERT INTO MASTERK1 (EMPID,LASTNAME,MNAME,FIRSTNAME,BIRTHDAY,SEX,PAGIBIGNO,DEPID,LineName,POSID,POSNAME,POS_ALLOW,RATE_AMT,MTD_BASIC,MTD_GROSS,YTD_BASIC,YTD_GROSS,YTD_WTAX,EMP_STAT,PAYSTATUS," & _
                       " SSNUM,ISUNION,TIN,TAXID,TAXCODE,TAXNAME,FULLNAME,DATE_HIRE,SL_AVAIL,VL_AVAIL,SL_USE,VL_USE,SSPREM1215,SSER1215,PS1215,ES1215,DATE_RES,STATUS,ACTIVE,WAP,CMPID,CMPName)VALUES(" & _
                       cQuote & oRecordSet("empid") & cQuote & "," & cQuote & oRecordSet("lastname") & cQuote & "," & cQuote & oRecordSet("mname") & cQuote & "," & cQuote & oRecordSet("firstname") & cQuote & "," & cQuote & oRecordSet("birthday") & cQuote & "," & cQuote & oRecordSet("sex") & cQuote & "," & _
                       cQuote & oRecordSet("pagibigno") & cQuote & "," & cQuote & oRecordSet("depid") & cQuote & "," & cQuote & oRecordSet("linename") & cQuote & "," & cQuote & oRecordSet("posid") & cQuote & "," & cQuote & oRecordSet("posname") & cQuote & "," & oRecordSet("pos_allow") & "," & _
                       oRecordSet("rate_amt") & "," & oRecordSet("mtd_basic") & "," & oRecordSet("mtd_gross") & "," & oRecordSet("ytd_basic") & "," & oRecordSet("ytd_gross") & "," & oRecordSet("ytd_wtax") & "," & cQuote & oRecordSet("emp_stat") & cQuote & "," & cQuote & oRecordSet("paystatus") & cQuote & "," & _
                       cQuote & oRecordSet("ssnum") & cQuote & "," & cQuote & oRecordSet("isunion") & cQuote & "," & cQuote & oRecordSet("tin") & cQuote & "," & cQuote & oRecordSet("taxid") & cQuote & "," & cQuote & oRecordSet("taxcode") & cQuote & "," & cQuote & oRecordSet("taxname") & cQuote & "," & cQuote & EncodeStr2(DecodeStr(oRecordSet("fullname"))) & cQuote & "," & _
                       cQuote & oRecordSet("DATE_HIRE") & cQuote & "," & oRecordSet("sl_avail") & "," & oRecordSet("vl_avail") & "," & oRecordSet("sl_use") & "," & oRecordSet("vl_use") & "," & oRecordSet("ssprem1215") & "," & oRecordSet("sser1215") & "," & oRecordSet("ps1215") & "," & _
                       oRecordSet("es1215") & "," & cQuote & oRecordSet("date_res") & cQuote & "," & cQuote & oRecordSet("status") & cQuote & "," & cQuote & oRecordSet("active") & cQuote & "," & cQuote & oRecordSet("wap") & cQuote & "," & cQuote & oRecordSet("cmpid") & cQuote & "," & _
                       cQuote & oRecordSet("cmpname") & cQuote & ")"
                                   
'            MsgBox cSqlStmt
            QueryDBF cSqlStmt, objdbRs, True

            oRecordSet.MoveNext

        Wend

        ShowProgress 4

        MsgBox "Backup File Done... Press [OK] to continue...", vbInformation, App.Title
    Else
        MsgBox "Data not found...!!!", vbInformation, App.Title
    End If
    
    Set oRecordSet = Nothing
    
End Sub

Sub checkK1Path(cPathcheck As String, cDuration As String)
    Dim cWant As String, _
        cHistoryPath As String, _
        FileSys As FileSystemObject, _
        nCtr As Integer
        
    Set FileSys = New FileSystemObject
    
    cHistoryPath = ""
                    
    cHistoryPath = CheckPath(Text4.Text) & "history"
    
    cHistoryPath = CheckPath(cHistoryPath)
    
    If Dir(cHistoryPath, vbDirectory) = "" Then MkDir cHistoryPath

    cHistoryPath = cHistoryPath & cDuration & "\"
    
    If Dir(cHistoryPath, vbDirectory) = "" Then MkDir cHistoryPath
    
    cHistoryPath = CheckPath(cHistoryPath)

Loop1:
    If Dir(cHistoryPath) = "" Then
        FileSys.CopyFile cPathcheck & "K1pay.dbf", cHistoryPath & "K1pay.dbf"
        FileSys.CopyFile cPathcheck & "MasterK1.dbf", cHistoryPath & "MasterK1.dbf"
    Else
        If (FileSys.FileExists(cHistoryPath & "K1pay" & IIf(nCtr <> 0, nCtr, "") & ".dbf") = True) Or (FileSys.FileExists(cHistoryPath & "MasterK1pay" & IIf(nCtr <> 0, nCtr, "") & ".dbf") = True) Then
            nCtr = nCtr + 1
            GoTo Loop1
        Else
            FileSys.CopyFile cPathcheck & "K1pay.dbf", cHistoryPath & "K1pay" & nCtr & ".dbf"
            FileSys.CopyFile cPathcheck & "MasterK1.dbf", cHistoryPath & "MasterK1" & nCtr & ".dbf"
'                        MsgBox "dito i aappend"
        End If
        
    End If
End Sub

Sub GenBackupPay(cParam As String)
    Dim oRecordSet As New ADODB.Recordset, _
        cSqlStmt As String, _
        cWant As String, _
        cPayPath As String, _
        cDuration As String, _
        cDurationPath As String, _
        cHistoryPath As String, _
        FileSys As FileSystemObject, _
        nCtr As Integer
        
    Set FileSys = New FileSystemObject
    
    cSqlStmt = " SELECT duration FROM pa7730 " & _
               " Where periodid = " & cQuote & cParam & cQuote
        
    OpenQueryDNS cSqlStmt, oRecordSet, False
    cDuration = IIf(oRecordSet.RecordCount > 0, oRecordSet("duration"), "")
    
    cDurationPath = CheckPath(Text4.Text) & "Backup"
    If Dir(cDurationPath, vbDirectory) = "" Then MkDir cDurationPath
    
    cDurationPath = cDurationPath & "\" & cDuration
    cDurationPath = CheckPath(cDurationPath)
    If Dir(cDurationPath, vbDirectory) = "" Then MkDir cDurationPath
    
    
    If (FileSys.FileExists(cDurationPath & "K1Pay.dbf") = True) Or (FileSys.FileExists(cDurationPath & "MasterK1.dbf") = True) Then
        cWant = MsgBox("K1Pay.dbf / MasterK1.dbf Already Exsist... do you want to backup previously created file ?", vbYesNoCancel + vbCritical, App.Title)
        If cWant = vbYes Then
            checkK1Path cDurationPath, cDuration
        End If
        
        FileSys.DeleteFile cDurationPath & "K1Pay.dbf"
        FileSys.DeleteFile cDurationPath & "MasterK1.dbf"
        
    End If
    
    GenbackupK1pay cDurationPath, cParam
    
End Sub


' --> for enhancement use...
'Sub Save2History(ByVal cPath As String, cFile As String)
'
'End Sub
'
'Sub GenBackup(ByVal cParam As String)
'    Dim oRecordSet As New ADODB.Recordset, _
'        cSqlStmt As String, _
'        cFolder As String, _
'        cBackupPath As String, _
'        cHistoryPath As String, _
'        oFileSys As New FileSystemObject, _
'        nCtr As Integer
'
'
'    cSqlStmt = " SELECT duration FROM pa7730 " & _
'               " Where periodid = " & cQuote & cParam & cQuote
'
'    OpenQueryDNS cSqlStmt, oRecordSet, False
'    cFolder = IIf(oRecordSet.RecordCount > 0, oRecordSet("duration"), "")
'
'    cBackupPath = CheckPath(Text4.Text) & "Backup"
'    If Dir(cBackupPath, vbDirectory) = "" Then MkDir cBackupPath
'
'    cBackupPath = CheckPath(cBackupPath) & cFolder
'    If Dir(cBackupPath, vbDirectory) = "" Then MkDir cBackupPath
'
'    If oFileSys.FileExists(CheckPath(cBackupPath) & "k1pay.dbf") Then
'        Save2History cBackupPath, "k1pay.dbf"
'    End If
'
'    Set oFileSys = Nothing
'End Sub



' + -->
' |     Procedure Name  :   GenSalDiv(ByVal cPeriod As String)
' |     Description     :   Generate Salary Division Report
' |     Date Created    :   22 aug 2006
' + -->
Sub CreateTmpSalDiv(ByVal nPeriod As Integer)
    On Error GoTo ErrCreate
    Dim cParam, _
        cSqlStmt As String, _
        nFieldCnt As Integer

    nFieldCnt = 0
    cParam = "fldname0 char(50), fldvalue0 double, "
    
    cSqlStmt = "select dedid, dedname from pa3330 where period" & nPeriod & "=1 order by dedid"
    OpenQueryDNS cSqlStmt, objdbRs, False
    If objdbRs.RecordCount > 0 Then
        nFieldCnt = objdbRs.RecordCount
        While Not objdbRs.EOF
            cParam = cParam & _
                     "fldname" & objdbRs.AbsolutePosition & " char(50)," & _
                     "fldvalue" & objdbRs.AbsolutePosition & " double,"
            objdbRs.MoveNext
        Wend
    End If
    
    cParam = cParam & _
             "fldname" & (nFieldCnt + 1) & " char(50)," & _
             "fldvalue" & (nFieldCnt + 1) & " double," & _
             "fldname" & (nFieldCnt + 2) & " char(50)," & _
             "fldvalue" & (nFieldCnt + 2) & " double," & _
             "fldname" & (nFieldCnt + 3) & " char(50)," & _
             "fldvalue" & (nFieldCnt + 3) & " double," & _
             "fldname" & (nFieldCnt + 4) & " char(50)," & _
             "fldvalue" & (nFieldCnt + 4) & " double," & _
             "fldname" & (nFieldCnt + 5) & " char(50)," & _
             "fldvalue" & (nFieldCnt + 5) & " double,"

    cSqlStmt = "CREATE TABLE TmpSalDiv( " & _
               " [periodname] char(100),    [tag] integer, " & _
               " [days_work] double,        [holiday] double," & _
               " [depid] char(3),           [depname] char(50), " & _
               cParam & " [mp_reg] double,  [mp_wap] double)"
    oTempConn.Execute cSqlStmt
    While oTempConn.State = adStateExecuting
        DoEvents
    Wend
ErrCreate:
    ' in case table is already existing, let's clear it...
    cSqlStmt = "DELETE FROM TmpSalDiv"
    QueryTemp cSqlStmt, oTempADO, True
End Sub

Private Sub GenSalDiv(ByVal cPeriod As String)
    Dim oRecordSet As New ADODB.Recordset, _
        nFieldCnt, ntag, nCtr, nPeriod As Integer, _
        cPeriodName, cParam, cParam2, cSqlStmt, cString As String, _
        aFieldDesc As Variant
       
    aFieldDesc = Array("", "", "", "")
       
    cSqlStmt = "select date_start, date_end, status from pa7730 where periodid=" & cQuote & cPeriod & cQuote
    OpenQueryDNS cSqlStmt, objdbRs, False
    If objdbRs.RecordCount > 0 Then
        nPeriod = IIf(objdbRs.RecordCount > 0, objdbRs("status"), 0)
        cPeriodName = "For the Payroll period " & Format(objdbRs("date_start"), "mmm d, yyyy") & " to " & Format(objdbRs("date_end"), "mmm d, yyyy")
    End If
    
    cParam = ""
    cParam2 = ""
    
    cSqlStmt = "select dedid, dedname from pa3330 where period" & nPeriod & "=1 order by dedid"
    OpenQueryDNS cSqlStmt, objdbRs, False
    If objdbRs.RecordCount > 0 Then
        nFieldCnt = objdbRs.RecordCount
    
        ReDim aFieldDesc(nFieldCnt + 6) '+ 5)
        
        aFieldDesc(0) = "GROSS PAY"
    
        While Not objdbRs.EOF
            cString = Chr$(98 + objdbRs.AbsolutePosition)
            cParam = cParam & " sum(ifnull(" & cString & ".ded_amt,0)) as dedamt" & objdbRs.AbsolutePosition & ","
            cParam2 = cParam2 & " left join pa87263 " & cString & _
                      " on a.periodid=" & cString & ".periodid" & _
                      " and a.empid=" & cString & ".empid " & _
                      " and " & cString & ".dedid=" & cQuote & objdbRs("dedid") & cQuote
            aFieldDesc(objdbRs.AbsolutePosition) = objdbRs("dedname")
            objdbRs.MoveNext
        Wend
    End If
    
    aFieldDesc(nFieldCnt + 1) = "Deductions"
    aFieldDesc(nFieldCnt + 2) = "NET PAY"
    aFieldDesc(nFieldCnt + 3) = "SA"
    aFieldDesc(nFieldCnt + 4) = "WAP"
    aFieldDesc(nFieldCnt + 5) = "WAP-SA"
       
    CreateTmpSalDiv nPeriod
    
    cSqlStmt = "select a.p_day, a.p_holiday, a.depid, ifnull(b.linename,'') as department, b.production, " & _
               "  sum(if(a.emp_stat>0,1,0)) as mp_reg, " & _
               "  sum(if(a.emp_stat=0,1,0)) as mp_wap, " & _
               "  sum(if(a.emp_stat>0,a.gross_pay,0)) as gross_pay, " & _
               "  sum(a.ded_amt) as deduction, " & _
               cParam & _
               "  sum(if(a.emp_stat>0,a.net_pay,0)) as net_reg, " & _
               "  sum(if(a.emp_stat=0,a.net_pay,0)) as net_wap, " & _
               "  sum(if(a.emp_stat>0,a.sa_net_pay,0)) as sa_net_reg, " & _
               "  sum(if(a.emp_stat=0,a.sa_net_pay,0)) as sa_net_wap " & _
               "from pa87260 a left join di5463 b on a.depid=b.lineid " & _
               cParam2 & _
               " where a.periodid=" & cQuote & cPeriod & cQuote & _
               " group by a.depid"
    OpenQueryDNS cSqlStmt, oRecordSet, False
    If oRecordSet.RecordCount > 0 Then
        
        ShowProgress 0
        
        While Not oRecordSet.EOF
            
            ShowProgress 2, (oRecordSet.AbsolutePosition / oRecordSet.RecordCount) * 100
            
            If oRecordSet("depid") = gAdmin Then
                ntag = 0
            ElseIf oRecordSet("depid") = gStaff Then
                ntag = 1
            ElseIf oRecordSet("production") = 1 Then
                ntag = 2
            Else
                ntag = 3
            End If
            
            cParam = "fldname0, fldvalue0, "
            cParam2 = cQuote & aFieldDesc(0) & cQuote & "," & oRecordSet("gross_pay") & ","
            
            For nCtr = 1 To nFieldCnt
                cParam = cParam & _
                         "fldname" & nCtr & ", " & _
                         "fldvalue" & nCtr & ", "
                cParam2 = cParam2 & _
                          cQuote & aFieldDesc(nCtr) & cQuote & ", " & _
                          oRecordSet("dedamt" & nCtr) & ", "
            Next nCtr
            
            cParam = cParam & _
                     "fldname" & (nFieldCnt + 1) & ", " & _
                     "fldvalue" & (nFieldCnt + 1) & ", " & _
                     "fldname" & (nFieldCnt + 2) & ", " & _
                     "fldvalue" & (nFieldCnt + 2) & ", " & _
                     "fldname" & (nFieldCnt + 3) & ", " & _
                     "fldvalue" & (nFieldCnt + 3) & ", " & _
                     "fldname" & (nFieldCnt + 4) & ", " & _
                     "fldvalue" & (nFieldCnt + 4) & ", " & _
                     "fldname" & (nFieldCnt + 5) & ", " & _
                     "fldvalue" & (nFieldCnt + 5) & ", "
            cParam2 = cParam2 & _
                      cQuote & aFieldDesc(nFieldCnt + 1) & cQuote & ", " & _
                      oRecordSet("deduction") & ", " & _
                      cQuote & aFieldDesc(nFieldCnt + 2) & cQuote & ", " & _
                      oRecordSet("net_reg") & ", " & _
                      cQuote & aFieldDesc(nFieldCnt + 3) & cQuote & ", " & _
                      oRecordSet("sa_net_reg") & ", " & _
                      cQuote & aFieldDesc(nFieldCnt + 4) & cQuote & ", " & _
                      oRecordSet("net_wap") & ", " & _
                      cQuote & aFieldDesc(nFieldCnt + 5) & cQuote & ", " & _
                      oRecordSet("sa_net_wap") & ", "
            
            cSqlStmt = "insert into tmpsaldiv(periodname, [tag], [days_work], [holiday], depid, depname, " & _
                       cParam & " mp_reg, mp_wap)values(" & _
                       cQuote & cPeriodName & cQuote & "," & _
                       ntag & "," & _
                       oRecordSet("p_day") & "," & oRecordSet("p_holiday") & "," & _
                       cQuote & oRecordSet("depid") & cQuote & "," & cQuote & EncodeStr2(oRecordSet("department")) & cQuote & "," & _
                       cParam2 & _
                       oRecordSet("mp_reg") & "," & oRecordSet("mp_wap") & ")"
            QueryTemp cSqlStmt, objdbRs, True
            
            oRecordSet.MoveNext
        
        Wend
        
        ShowProgress 3

        GenerateReport "Salary Division", IIf(Check4.Value = vbChecked, "rpt725348.rpt", "rpt725348s.rpt")
        
        ShowProgress 4
    
    End If
    
    Set oRecordSet = Nothing
End Sub


' + -->
' |     Procedure Name  :   GenSalDiv(ByVal cPeriod As String)
' |     Description     :   Generate Salary Division Report
' |     Date Created    :   22 aug 2006
' + -->
Sub CreateTmpM13(ByVal nMode As Integer)
    Dim nCtr As Integer, _
        cSqlStmt As String, _
        aField As Variant
        
    aField = Array("", "", "")
        
    For nCtr = 1 To 24
        aField(0) = aField(0) & "[bas" & Format(nCtr, "00") & "] double,"
        aField(1) = aField(1) & "[gr" & Format(nCtr, "00") & "] double,"
        aField(2) = aField(2) & "[sa" & Format(nCtr, "00") & "] double,"
    Next nCtr
    
    If nMode = 0 Then
        cSqlStmt = "create table C13MOPAY (" & _
                   "[empid] char(6), [fullname] char(100), [emp_stat] char(1), " & _
                   aField(0) & _
                   "[totbasic] double, [leave_pay] double, [m13pay] double, " & _
                   "[gross13] double, [cash_adv] double, [net13] double)"
    Else
        cSqlStmt = "create table R13MOPAY (" & _
                   "[empid] char(6), [fullname] char(100), [emp_stat] char(1), [tin] char(20), [taxcode] char(10), " & _
                   aField(1) & _
                   aField(2) & _
                   "[totgross] double, [totsa] double, [leave_pay] double, [m13pay] double, " & _
                   "[gross13] double, [cash_adv] double, [net13] double)"
    End If

    oDBFConn.Execute cSqlStmt
    While oDBFConn.State = adStateExecuting
        DoEvents
    Wend
    
'ErrCreate:
'    ' in case table is already existing, let's clear it...
'    If nMode = 0 Then
'        cSqlStmt = "DELETE FROM C13MOPAY"
'    Else
'        cSqlStmt = "DELETE FROM R13MOPAY"
'    End If
'    QueryDBF cSqlStmt, oTempADO, True
End Sub

Sub Gen13mobackup()
    Dim cSqlStmt As String, _
        cBackupPath As String, _
        oFileSys As New FileSystemObject, _
        aField As Variant, _
        aFieldValue As Variant, _
        nCtr As Integer
        
    aField = Array("", "", "")
        
    cBackupPath = CheckPath(Text4.Text)
    
    If oFileSys.FileExists(CheckPath(cBackupPath) & "C13MOPAY.DBF") Then
        oFileSys.DeleteFile CheckPath(cBackupPath) & "C13MOPAY.DBF"
    End If
    
    If oFileSys.FileExists(CheckPath(cBackupPath) & "R13MOPAY.DBF") Then
        oFileSys.DeleteFile CheckPath(cBackupPath) & "R13MOPAY.DBF"
    End If
    
    DetectDBF cBackupPath
    
    CreateTmpM13 0      ' --> contractual
    CreateTmpM13 1      ' --> regular
    
    For nCtr = 1 To 24
        aField(0) = aField(0) & "a.bas" & Format(nCtr, "00") & ","
        aField(1) = aField(1) & "a.gr" & Format(nCtr, "00") & ","
        aField(2) = aField(2) & "a.sa" & Format(nCtr, "00") & ","
    Next nCtr
    
    cSqlStmt = "select a.empid, a.emp_stat, a.fullname, a.totgross, a.totbasic, a.totsa, b.emp_stat, a.tin, a.taxcode, " & _
               aField(0) & aField(1) & aField(2) & _
               " b.leave_pay, b.m13pay, b.ded_amt, b.net_pay, b.gross_pay " & _
               "from pa13667 a left join pa87260 b on a.empid=b.empid and b.periodid=" & cQuote & Text2.Text & cQuote
    OpenQueryDNS cSqlStmt, oTempADO, False
    If oTempADO.RecordCount > 0 Then
    
        ShowProgress 0
    
        While Not oTempADO.EOF
        
            ShowProgress 2, (oTempADO.AbsolutePosition / oTempADO.RecordCount) * 100
            
            aField = Array("", "", "")
            aFieldValue = Array("", "", "")
            For nCtr = 1 To 24
                aField(0) = aField(0) & "bas" & Format(nCtr, "00") & ","
                aField(1) = aField(1) & "gr" & Format(nCtr, "00") & ","
                aField(2) = aField(2) & "sa" & Format(nCtr, "00") & ","
            
                aFieldValue(0) = aFieldValue(0) & oTempADO("bas" & Format(nCtr, "00")) & ","
                aFieldValue(1) = aFieldValue(1) & oTempADO("gr" & Format(nCtr, "00")) & ","
                aFieldValue(2) = aFieldValue(2) & oTempADO("sa" & Format(nCtr, "00")) & ","
            Next nCtr
            
            cSqlStmt = "insert into " & IIf(oTempADO("emp_stat") = 1, "C13MOPAY", "R13MOPAY") & "(empid,fullname,emp_stat," & _
                       IIf(oTempADO("emp_stat") = 1, aField(0) & "totbasic,", "[tin],taxcode," & aField(1) & aField(2) & "totgross, totsa,") & _
                       "leave_pay,m13pay,gross13,cash_adv,net13)values(" & _
                       cQuote & oTempADO("empid") & cQuote & "," & _
                       cQuote & oTempADO("fullname") & cQuote & "," & _
                       cQuote & IIf(oTempADO("emp_stat") = 1, "C", "R") & cQuote & "," & _
                       IIf(oTempADO("emp_stat") = 1, aFieldValue(0) & oTempADO("totbasic") & ",", cQuote & oTempADO("tin") & cQuote & "," & cQuote & oTempADO("taxcode") & cQuote & "," & aFieldValue(1) & aFieldValue(2) & oTempADO("totgross") & "," & oTempADO("totsa") & ",") & _
                       oTempADO("leave_pay") & "," & _
                       oTempADO("m13pay") & "," & _
                       oTempADO("gross_pay") & "," & _
                       oTempADO("ded_amt") & "," & _
                       oTempADO("net_pay") & ")"
            QueryDBF cSqlStmt, objdbRs, True

            oTempADO.MoveNext
            
        Wend
        
        ShowProgress 4
        
        MsgBox "Done!"
    End If
    
    Set oFileSys = Nothing
End Sub


' + -->
' |     Procedure Name  :   GenAlphaList(ByVal cPeriodID As String)
' |     Description     :   Generate Alphalist (Annual Withholding Tax)
' |     Date Created    :   6 jan 2007
' + -->
Sub CreateAlphaLst()
    Dim cSqlStmt As String

    cSqlStmt = "create table alphalst(" & _
               " [tin] char(20),        [fullname] char(100)," & _
               " [m13pay] double,       [non_tax] double," & _
               " [grosspay] double,     [ex_amt] double," & _
               " [tax_due] double,      [tax_wheld] double," & _
               " [over_wheld] double,   [adj_tax] double," & _
               " [percent] double," & _
               " [amount] double,       [range1] double," & _
               " [taxcode] char(3),     [empid] char(6))"

    oDBFConn.Execute cSqlStmt
    While oDBFConn.State = adStateExecuting
        DoEvents
    Wend
End Sub

Sub GenAlphaList(ByVal cPeriodID As String)
    Dim cDedID As String, _
        cSqlStmt As String, _
        oFileSys As New FileSystemObject, _
        oRecordSet As New ADODB.Recordset, _
        nCtr As Integer, _
        nYear As Integer, _
        aTaxable As Variant

    aTaxable = Array(0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#)

    If oFileSys.FileExists(CheckPath(Text4.Text) & "alphalst.DBF") Then
        oFileSys.DeleteFile CheckPath(Text4.Text) & "alphalst.DBF"
    End If

    DetectDBF CheckPath(Text4.Text)
    
    CreateAlphaLst
    
    OpenQueryDNS "select year(date_end) as oyear from pa7730 where periodid=" & cQuote & cPeriodID & cQuote, objdbRs, False
    nYear = objdbRs("oyear")
    
    ' --> active employee
    cSqlStmt = "select a.empid, a.fullname, c.tin, e.taxcode, " & _
               "  round(c.ytd_gross + a.gross_pay,2) as gross_pay, " & _
               "  round(b.ded_amt3,2) as non_tax, " & _
               "  if(instr(e.taxcode,'S') > 0,d.s_amt,if(instr(e.taxcode,'H') > 0,d.h_amt,if(instr(e.taxcode,'ME') > 0,d.m_amt,0))) + if(if(instr(e.taxcode,'S') > 0,d.s_amt,if(instr(e.taxcode,'H') > 0,d.h_amt,if(instr(e.taxcode,'ME') > 0,d.m_amt,0))) > 0,if(right(e.taxcode,1)>4,4,right(e.taxcode,1)) * d.ex_amt,0) as ex_amt, " & _
               "  d.percent, " & _
               "  d.amount, " & _
               "  d.range1, " & _
               "  d.amount + (((c.ytd_gross + a.gross_pay - b.ded_amt3) - (if(instr(e.taxcode,'S') > 0,d.s_amt,if(instr(e.taxcode,'H') > 0,d.h_amt,if(instr(e.taxcode,'ME') > 0,d.m_amt,0))) + if(if(instr(e.taxcode,'S') > 0,d.s_amt,if(instr(e.taxcode,'H') > 0,d.h_amt,if(instr(e.taxcode,'ME') > 0,d.m_amt,0))) > 0,if(right(e.taxcode,1)>4,4,right(e.taxcode,1)) * d.ex_amt,0)) - d.range1) * (d.percent/100)) as tax_due, " & _
               "  round(c.ytd_wtax,2) as tax_wheld, " & _
               "  round(b.ded_amt2, 2) As adj_tax " & _
               "from pa87260 a left join pa87263 b on a.periodid=b.periodid and a.empid=b.empid and b.dedid='006' " & _
               "  left join di3670 c on a.empid=c.empid " & _
               "  left join pa8290 e on c.taxid=e.taxid " & _
               "  left join pa4870 d on (c.ytd_gross + a.gross_pay - b.ded_amt3) - " & _
               "                        if(instr(e.taxcode,'S') > 0,d.s_amt,if(instr(e.taxcode,'H') > 0,d.h_amt,if(instr(e.taxcode,'ME') > 0,d.m_amt,0))) - " & _
               "                        if(if(instr(e.taxcode,'S') > 0,d.s_amt,if(instr(e.taxcode,'H') > 0,d.h_amt,if(instr(e.taxcode,'ME') > 0,d.m_amt,0))) > 0,if(right(e.taxcode,1)>4,4,right(e.taxcode,1)) * d.ex_amt,0) " & _
               "                        Between d.range1 And d.range2 " & _
               "where a.emp_stat=2 and a.periodid=" & cQuote & cPeriodID & cQuote & _
               " order by a.fullname"
    OpenQueryDNS cSqlStmt, oTempADO, False
    If oTempADO.RecordCount > 0 Then
    
        ShowProgress 0
        
        While Not oTempADO.EOF
        
            ShowProgress 2, (oTempADO.AbsolutePosition / oTempADO.RecordCount) * 100
            
            cSqlStmt = "select net_pay from pa87260 " & _
                       "where (periodid in (select periodid from pa7730 where 13month=1 and year(date_end)=" & nYear & ")) " & _
                       "      and (empid=" & cQuote & oTempADO("empid") & cQuote & ")"
            OpenQueryDNS cSqlStmt, objdbRs, False
            aTaxable(9) = IIf(objdbRs.RecordCount > 0, objdbRs("net_pay"), 0)
            
            ' --> re-compute adjusted tax...
            aTaxable(0) = Round(oTempADO("amount") + ((oTempADO("gross_pay") - oTempADO("non_tax") - oTempADO("ex_amt") - oTempADO("range1")) * (oTempADO("percent") / 100)) - oTempADO("tax_wheld"), 2)
            
            ' --> replace previously computed adj tax with re-computed adjustment...
            aTaxable(1) = IIf(oTempADO("adj_tax") <> aTaxable(0), aTaxable(0), oTempADO("adj_tax"))
            
            cSqlStmt = "insert into alphalst([empid],[fullname],[taxcode],[tin],[grosspay],[non_tax]," & _
                       "[ex_amt],[percent],[amount],[range1]," & _
                       "[tax_due],[tax_wheld],[over_wheld],[adj_tax],[m13pay])values(" & _
                       cQuote & oTempADO("empid") & cQuote & "," & _
                       cQuote & oTempADO("fullname") & cQuote & "," & _
                       cQuote & oTempADO("taxcode") & cQuote & "," & _
                       cQuote & oTempADO("tin") & cQuote & "," & _
                       oTempADO("gross_pay") & "," & _
                       oTempADO("non_tax") & "," & _
                       oTempADO("ex_amt") & "," & _
                       oTempADO("percent") & "," & _
                       oTempADO("amount") & "," & _
                       oTempADO("range1") & "," & _
                       oTempADO("tax_due") & "," & _
                       oTempADO("tax_wheld") & "," & _
                       IIf(aTaxable(1) < 0, aTaxable(1) * -1, 0) & "," & _
                       IIf(aTaxable(1) > 0, aTaxable(1), 0) & "," & _
                       aTaxable(9) & ")"
            QueryDBF cSqlStmt, objdbRs, True
            
            oTempADO.MoveNext
            
        Wend
        
        ShowProgress 4
        
    End If
    
    
    ' --> resigned employee
    For nCtr = 0 To UBound(aTaxExempt)
        If Trim(aTaxExempt(nCtr)) = "" Then Exit For
        cDedID = cDedID & aTaxExempt(nCtr) & ","
    Next nCtr
    If Trim(cDedID) <> "" Then cDedID = left(cDedID, Len(cDedID) - 1)
    
    cSqlStmt = "select a.empid, " & _
               "  concat(a.lastname,', ',a.firstname,if(trim(a.mname)<>'',concat(' ',left(a.mname,1),'.'),'')) as fullname, " & _
               "  a.tin, " & _
               "  ifnull(b.taxcode,a.taxcode) as taxcode, " & _
               "  a.ytd_gross, " & _
               "  a.ytd_wtax as tax_wheld, " & _
               "  sum(c.ded_amt) As ded_amt " & _
               "from di3670 a left join pa8290 b on a.taxid=b.taxid " & _
               "  left join pah87263 c on a.empid=c.empid and (c.periodid in (select periodid from pa7730 where year(date_end)=" & nYear & ")) " & _
               "Where (a.emp_stat = 2) " & _
               "  and (((a.active=1) and (year(a.date_res)=" & nYear & "))" & _
               "       or ((a.active=2) and (year(a.date_fin)=" & nYear & ")))" & _
               "  and (c.dedid in (" & cDedID & ")) " & _
               "group by c.empid " & _
               " order by fullname "
    OpenQueryDNS cSqlStmt, oRecordSet, False
    If oRecordSet.RecordCount > 0 Then
    
        ShowProgress 0
        
        While Not oRecordSet.EOF
        
            ShowProgress 2, (oRecordSet.AbsolutePosition / oRecordSet.RecordCount) * 100
            
            aTaxable = Array(0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#, 0#)
            '    aTaxable(0)     Taxable Amount
            '    aTaxable(1)     Net Taxable
            '    aTaxable(2)     excess
            '    aTaxable(3)     leave pay
            '    aTaxable(4)     adj tax
            '    aTaxable(5)     percent
            '    aTaxable(6)     amount
            '    aTaxable(7)     range1
            '    aTaxable(8)     exemption amount
            '    aTaxable(9)     13 month
            
            If Trim(oRecordSet("taxcode")) <> "" Then
                cSqlStmt = "select sum(leave_pay) as leave_pay, sum(m13pay) as 13mopay " & _
                           "From pah87260 " & _
                           "where (periodid in (select periodid from pa7730 where year(date_end)=" & nYear & ")) and (empid=" & cQuote & oRecordSet("empid") & cQuote & ")"
                OpenQueryDNS cSqlStmt, objdbRs, False
                aTaxable(3) = IIf(objdbRs.RecordCount > 0, objdbRs("leave_pay") + objdbRs("13mopay"), 0)
                aTaxable(9) = IIf(objdbRs.RecordCount > 0, objdbRs("13mopay"), 0)
                
                aTaxable(0) = Round(oRecordSet("ytd_gross") - oRecordSet("ded_amt") - aTaxable(3), 2)
                
                cSqlStmt = "select percent, amount, range1, " & _
                           "       if(instr(" & cQuote & oRecordSet("taxcode") & cQuote & ",'S') > 0,s_amt,if(instr(" & cQuote & oRecordSet("taxcode") & cQuote & ",'H') > 0,h_amt,if(instr(" & cQuote & oRecordSet("taxcode") & cQuote & ",'ME') > 0,m_amt,0))) + if(if(instr(" & cQuote & oRecordSet("taxcode") & cQuote & ",'S') > 0,s_amt,if(instr(" & cQuote & oRecordSet("taxcode") & cQuote & ",'H') > 0,h_amt,if(instr(" & cQuote & oRecordSet("taxcode") & cQuote & ",'ME') > 0,m_amt,0))) > 0,if(right(" & cQuote & oRecordSet("taxcode") & cQuote & ",1)>4,4,right(" & cQuote & oRecordSet("taxcode") & cQuote & ",1)) * ex_amt,0) as ex_amt " & _
                           "from pa4870 " & _
                           "where " & aTaxable(0) & " - " & _
                           "      if(instr(" & cQuote & oRecordSet("taxcode") & cQuote & ",'S') > 0,s_amt,if(instr(" & cQuote & oRecordSet("taxcode") & cQuote & ",'H') > 0,h_amt,if(instr(" & cQuote & oRecordSet("taxcode") & cQuote & ",'ME') > 0,m_amt,0))) + " & _
                           "      if(if(instr(" & cQuote & oRecordSet("taxcode") & cQuote & ",'S') > 0,s_amt,if(instr(" & cQuote & oRecordSet("taxcode") & cQuote & ",'H') > 0,h_amt,if(instr(" & cQuote & oRecordSet("taxcode") & cQuote & ",'ME') > 0,m_amt,0))) > 0,if(right(" & cQuote & oRecordSet("taxcode") & cQuote & ",1)>4,4,right(" & cQuote & oRecordSet("taxcode") & cQuote & ",1)) * ex_amt,0) " & _
                           " between range1 and range2"
'                Script2File cSqlStmt
                OpenQueryDNS cSqlStmt, oTempADO, False
                If oTempADO.RecordCount > 0 Then
                    aTaxable(1) = Round(aTaxable(0) - oTempADO("ex_amt"), 2)
                    aTaxable(2) = Round((aTaxable(1) - oTempADO("range1")) * (oTempADO("percent") / 100), 2)
                    aTaxable(4) = Round(oTempADO("amount") + aTaxable(2) - oRecordSet("tax_wheld"), 2)
                    aTaxable(5) = oTempADO("percent")
                    aTaxable(6) = oTempADO("amount")
                    aTaxable(7) = oTempADO("range1")
                    aTaxable(8) = oTempADO("ex_amt")
                Else
                    OpenQueryDNS "select s_amt, h_amt, m_amt, ex_amt from pa4870 limit 1", oTempADO, False
                    aTaxable(8) = IIf(InStr(oRecordSet("taxcode"), "S") > 0, oTempADO("s_amt"), IIf(InStr(oRecordSet("taxcode"), "H") > 0, oTempADO("h_amt"), IIf(InStr(oRecordSet("taxcode"), "M") > 0, oTempADO("m_amt"), 0))) + (IIf(Val(right(oRecordSet("taxcode"), 1)) > 4, 4, Val(right(oRecordSet("taxcode"), 1))) * oTempADO("ex_amt"))
                End If
                
                cSqlStmt = "insert into alphalst([empid],[fullname],[taxcode],[tin],[grosspay],[non_tax]," & _
                           "[ex_amt],[percent],[amount],[range1]," & _
                           "[tax_due],[tax_wheld],[over_wheld],[adj_tax],[m13pay])values(" & _
                           cQuote & oRecordSet("empid") & cQuote & "," & _
                           cQuote & oRecordSet("fullname") & cQuote & "," & _
                           cQuote & oRecordSet("taxcode") & cQuote & "," & _
                           cQuote & oRecordSet("tin") & cQuote & "," & _
                           oRecordSet("ytd_gross") & "," & _
                           oRecordSet("ded_amt") + aTaxable(3) & "," & _
                           aTaxable(8) & "," & _
                           aTaxable(5) & "," & _
                           aTaxable(6) & "," & _
                           aTaxable(7) & "," & _
                           IIf(aTaxable(6) + aTaxable(2) <= 0, 0, aTaxable(6) + aTaxable(2)) & "," & _
                           oRecordSet("tax_wheld") & "," & _
                           IIf(oRecordSet("tax_wheld") >= IIf(aTaxable(6) + aTaxable(2) <= 0, 0, aTaxable(6) + aTaxable(2)), oRecordSet("tax_wheld") - IIf(aTaxable(6) + aTaxable(2) <= 0, 0, aTaxable(6) + aTaxable(2)), 0) & "," & _
                           IIf(oRecordSet("tax_wheld") < IIf(aTaxable(6) + aTaxable(2) <= 0, 0, aTaxable(6) + aTaxable(2)), IIf(aTaxable(6) + aTaxable(2) <= 0, 0, aTaxable(6) + aTaxable(2)) - oRecordSet("tax_wheld"), 0) & "," & _
                           aTaxable(9) & ")"
                QueryDBF cSqlStmt, objdbRs, True
            End If
            
            oRecordSet.MoveNext
            
        Wend
        
        ShowProgress 4
        
    End If
               
    MsgBox "done"
    
    Set oFileSys = Nothing
    Set oRecordSet = Nothing
End Sub


Private Sub Check1_Click()
    Dim nCtr As Integer
    
    ListView1.Enabled = Check1.Value <> 1
    For nCtr = 1 To ListView1.ListItems.Count
        ListView1.ListItems(nCtr).Checked = Check1.Value = vbChecked
    Next nCtr
End Sub

Private Sub Check2_Click()
    Dim nCtr As Integer
    
    ListView2.Enabled = Check2.Value <> 1
    For nCtr = 1 To ListView2.ListItems.Count
        ListView2.ListItems(nCtr).Checked = Check2.Value = vbChecked
    Next nCtr
End Sub

Private Sub Check3_Click()
    Combo1.ListIndex = 0
    Combo1.Visible = Check3.Value = vbUnchecked
    Label2.Visible = Check3.Value = vbUnchecked
End Sub

Private Sub Check4_Click()
    Select Case Tag
        Case 6, 7, 15, 20
            SSTab1.TabVisible(3) = Check4.Value <> vbChecked
        Case 14
            Label10.Caption = IIf(Check4.Value = vbChecked, "Checked By", "Prepared By")
            Text5.Visible = Check4.Value <> vbChecked
            Label5.Visible = Check4.Value <> vbChecked
            Label6.Visible = Check4.Value <> vbChecked
            Command14.Visible = Check4.Value <> vbChecked
    End Select
End Sub

Private Sub Combo1_Click()
    Check3.Enabled = Combo1.ListIndex < 1
End Sub

Private Sub Command1_Click()
    cmdClick Text2, Label9
    Text2.SetFocus
End Sub

Private Sub Command13_Click()
    cmdClick Text6, Label8
    Text6.SetFocus
End Sub

Private Sub Command14_Click()
    cmdClick Text5, Label6
    Text5.SetFocus
End Sub

Private Sub Command15_Click()
    cmdClick Text7, Label15
    Text7.SetFocus
End Sub

Private Sub Command16_Click()
    cmdClick Text8, Label16
    Text8.SetFocus
End Sub

Private Sub Command2_Click()
    cmdClick Text3, Label14
    Text3.SetFocus
End Sub

Private Sub Command5_Click()
    cmdClick Text1, Label4
    Text1.SetFocus
End Sub

Private Sub Dir1_Change()
    Text4.Text = Dir1.Path
End Sub

Private Sub Drive1_Change()
    Dir1.Path = Drive1.Drive
End Sub

Private Sub Text1_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyReturn Then txtKeyDown 3, Text1.Text, Label4
End Sub

Private Sub Text2_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyReturn Then txtKeyDown 6, Text2.Text, Label9
End Sub

Private Sub Text3_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyReturn Then txtKeyDown 7, Text3.Text, Label14
End Sub

Private Sub Text5_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyReturn Then txtKeyDown 2, Text5.Text, Label6
End Sub

Private Sub Text6_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyReturn Then txtKeyDown 1, Text6.Text, Label8
End Sub

Private Sub Text7_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyReturn Then txtKeyDown 4, Text7.Text, Label15
End Sub

Private Sub Text8_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyReturn Then txtKeyDown 5, Text8.Text, Label16
End Sub

Private Sub XPButton3_Click()
    Dim nCtr As Integer, _
        cParam As String, _
        cParam2 As String, _
        cPeriod As String
        
    If (Tag <> 12) And ((Tag < 19) Or (Tag > 20)) Then
        If ListView1.Visible = True Then cPeriod = ListView1.SelectedItem.Text
    End If
    
    If Tag = 17 Then
        If (Text4.Text = "") Then 'Or (Text9.Text = "") Then
            MsgBox "Select Path/Location...", vbCritical, App.Title
            Exit Sub
        End If
    End If
    
    If Tag <= 2 Then
        If Check1.Value = vbUnchecked Then
            For nCtr = 1 To ListView1.ListItems.Count
                If ListView1.ListItems(nCtr).Checked Then cParam = cParam & cQuote & ListView1.ListItems(nCtr).Text & cQuote & ","
            Next nCtr
            
            If Trim(cParam) <> "" Then cParam = "(" & left(cParam, Len(cParam) - 1) & ")"
        End If
    Else
        If Tag <> 9 Then
            If Check2.Value = vbUnchecked Then
                For nCtr = 1 To ListView2.ListItems.Count
                    If ListView2.ListItems(nCtr).Checked Then cParam = cParam & cQuote & ListView2.ListItems(nCtr).Text & cQuote & ","
                Next nCtr
                
                If Trim(cParam) <> "" Then cParam = "(" & left(cParam, Len(cParam) - 1) & ")"
            End If
            If Tag = 10 Then
                If Check2.Value = vbUnchecked Then
                    For nCtr = 1 To ListView2.ListItems.Count
                        If ListView2.ListItems(nCtr).Checked Then cParam2 = cParam2 & cQuote & ListView2.ListItems(nCtr).Text & cQuote & ","
                    Next nCtr
                    
                    If Trim(cParam2) <> "" Then
                        cParam2 = " and (b.depid IN (" & left(cParam2, Len(cParam2) - 1) & "))"
                    Else
                        MsgBox "Please specify a Department/Line to preview!", vbInformation, "Monthly Production Report - " & App.Title
                        Exit Sub
                    End If
                End If
            End If
        Else
            If Check1.Value = vbUnchecked Then
                For nCtr = 1 To ListView1.ListItems.Count
                    If ListView1.ListItems(nCtr).Checked Then cParam = cParam & cQuote & ListView1.ListItems(nCtr).Text & cQuote & ","
                Next nCtr
                
                If Trim(cParam) <> "" Then
                    cParam = " ((month(date_fin) IN (" & left(cParam, Len(cParam) - 1) & ")) and (year(date_fin) = " & Combo1.Text & "))"
                Else
                    MsgBox "Please specify a month to preview!", vbInformation, "Monthly Production Report - " & App.Title
                    Exit Sub
                End If
            End If
      
            If Check2.Value = vbUnchecked Then
                For nCtr = 1 To ListView2.ListItems.Count
                    If ListView2.ListItems(nCtr).Checked Then cParam2 = cParam2 & cQuote & ListView2.ListItems(nCtr).Text & cQuote & ","
                Next nCtr
                
                If Trim(cParam2) <> "" Then
                    cParam2 = " and (depid IN (" & left(cParam2, Len(cParam2) - 1) & "))"
                Else
                    MsgBox "Please specify a Department/Line to preview!", vbInformation, "Monthly Production Report - " & App.Title
                    Exit Sub
                End If
            End If
        End If
    End If
        
    Select Case Tag
        Case 1      ' --> Process Payroll Transaction
            ProcessTransaction
            
        Case 2      ' --> Generate PEZA Report
            GenPEZA cPeriod
            
        Case 3      ' --> Employee Listing
            If Check4.Value = vbChecked Then
                GenEmpList cPeriod, cParam, Combo1.ListIndex
            Else
                GenEmpListSum cPeriod, cParam, Combo1.ListIndex
            End If
            
        Case 4, 5, 6, 15
            GenPayRoll cPeriod, cParam, Combo1.ListIndex
            
        Case 7, 23      ' --> Denomination Report
            GenDenom cPeriod
            
        Case 8      ' --> Close Period
            ClosePeriod cPeriod
            
        Case 9      ' --> Monthly Finish Contract Report
            MFCon cParam, cParam2, 0
            
        Case 10
            MFCon cPeriod, cParam2, 1
        
        Case 11     ' --> Leave Report by Period
            Genleaverep cPeriod, Combo1.ListIndex
            
        Case 12     ' --> Philhealth/Medicare Remittance Report
            GenPhilHealth Combo2.ListIndex, Combo3.Text
    
        Case 13     ' --> Withholding Tax Report
            GenWithRep cPeriod
            
        Case 14     ' --> Pag-Ibig Remittance Report
            GenPagIbig cPeriod
            
        Case 16     ' --> SSS Premium Remittance Report
            SSSPData cPeriod
            
        Case 17     ' --> Generate Backup
            GenBackupPay cPeriod
'            GenBackup cPeriod
            
        Case 18     ' --> Salary Division
            GenSalDiv cPeriod
            
        Case 19, 20 ' --> generate payslip/paysheet for 13th month
            GenPayRoll Text2.Text, cParam, 0
            
        Case 21     ' --> backup 13th month
            Gen13mobackup
            
        Case 22     ' --> 13th month acknowledgement...
            GenPayRoll cPeriod, cParam, 0
            
        Case 24     ' --> Alphalist (Annual Withholding Tax)
            GenAlphaList cPeriod
            
    End Select
End Sub

Private Sub Form_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then SendKeys vbTab
End Sub

Private Sub Form_Load()
    Log2Audit Me.Name, "OPEN"
End Sub

Private Sub Form_QueryUnload(Cancel As Integer, UnloadMode As Integer)
    Log2Audit Me.Name, "CLOSE"
End Sub

Private Sub Form_Terminate()
    Set oTempADO = Nothing
    Set oDBFConn = Nothing
End Sub

Private Sub Form_Unload(Cancel As Integer)
    Unload Me
End Sub

Private Sub ListView1_DblClick()
    XPButton3_Click
End Sub

Private Sub XPButton1_Click()
    Unload Me
End Sub

Private Sub XPButton2_Click()
    Dim cString As String
    
    OpenQueryDNS "SELECT * FROM PA87260 WHERE PERIODID=" & cQuote & ListView1.SelectedItem.Text & cQuote, objdbRs, False
    If objdbRs.RecordCount > 0 Then
        cString = "A transaction had been detected for Period ID #" & ListView1.SelectedItem.Text & Chr$(13) & Chr$(10) & _
                  "Would you like to re-process the transaction?"
        If MsgBox(cString, vbYesNo, "System Advisory") = vbYes Then
            OpenQueryDNS "DELETE FROM PA87260 WHERE PERIODID=" & cQuote & ListView1.SelectedItem.Text & cQuote, objdbRs, True
            Script2File "DELETE FROM PA87260 WHERE PERIODID=" & cQuote & ListView1.SelectedItem.Text & cQuote
            
            OpenQueryDNS "DELETE FROM PA87263 WHERE PERIODID=" & cQuote & ListView1.SelectedItem.Text & cQuote, objdbRs, True
            Script2File "DELETE FROM PA87263 WHERE PERIODID=" & cQuote & ListView1.SelectedItem.Text & cQuote
            
            Log2Audit Me.Name, "Re-Process Transaction for Period ID#" & ListView1.SelectedItem.Text
            
            ProcessTransaction
        End If
    End If
End Sub
